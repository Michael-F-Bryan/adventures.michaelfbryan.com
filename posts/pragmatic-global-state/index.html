<!doctype html><html lang=en><head><title>A Pragmatic Approach To Global State · Michael-F-Bryan
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Michael-F-Bryan"><meta name=description content="One of the first things I learned when programming professionally is that
global variables are bad. We all take it for granted that it&rsquo;s bad practice
to write code that relies heavily on global state but the other day I was
working with a 3rd party native library, and it reminded why these best
practices come about.
There are a couple factors which made this particular library&rsquo;s use of global
mutable state rather ugly to work with,"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="A Pragmatic Approach To Global State"><meta name=twitter:description content="One of the first things I learned when programming professionally is that global variables are bad. We all take it for granted that it’s bad practice to write code that relies heavily on global state but the other day I was working with a 3rd party native library, and it reminded why these best practices come about.
There are a couple factors which made this particular library’s use of global mutable state rather ugly to work with,"><meta property="og:url" content="https://adventures.michaelfbryan.com/posts/pragmatic-global-state/"><meta property="og:site_name" content="Michael-F-Bryan"><meta property="og:title" content="A Pragmatic Approach To Global State"><meta property="og:description" content="One of the first things I learned when programming professionally is that global variables are bad. We all take it for granted that it’s bad practice to write code that relies heavily on global state but the other day I was working with a 3rd party native library, and it reminded why these best practices come about.
There are a couple factors which made this particular library’s use of global mutable state rather ugly to work with,"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-17T22:22:47+08:00"><meta property="article:modified_time" content="2025-04-01T09:19:10+08:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Architecture"><link rel=canonical href=https://adventures.michaelfbryan.com/posts/pragmatic-global-state/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm+MTzNJdv80k+n0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/master.min.34be5ef36a820320661b4a8578382aba472d1a01092908eb30f0db81ec4031d4.css integrity="sha256-NL5e82qCAyBmG0qFeDgqukctGgEJKQjrMPDbgexAMdQ=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://adventures.michaelfbryan.com/>Michael-F-Bryan
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://adventures.michaelfbryan.com/posts/pragmatic-global-state/>A Pragmatic Approach To Global State</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2020-02-17T22:22:47+08:00>February 17, 2020
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
32-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/rust/>Rust</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/architecture/>Architecture</a></span></div></div></header><div class=post-content><p>One of the first things I learned when programming professionally is that
<em>global variables are bad</em>. We all take it for granted that it&rsquo;s bad practice
to write code that relies heavily on global state but the other day I was
working with a 3rd party native library, and it reminded <em>why</em> these best
practices come about.</p><p>There are a couple factors which made this particular library&rsquo;s use of global
mutable state rather ugly to work with,</p><ul><li>Thread safety - mutating something from two concurrent threads of execution
without proper synchronisation is a <a href=https://doc.rust-lang.org/nomicon/races.html class=external-link target=_blank rel=noopener>data race</a>, a common form of
<em>Undefined Behaviour</em>. This means the library can only ever be used from one
place at a time.</li><li>Brittle code - Relying on global state often means the code expects to be
run in a very specific order. Failing to invoke functions in the correct
order can lead to memory issues (e.g. leaks or double-frees) and
accidentally corrupting the library&rsquo;s state</li><li>Poor testability - when code is mutating global variables there&rsquo;s no way to
inject mocks (e.g. to <code>assert!()</code> specific conditions) or make sure
individual chunks of functionality work. You are often reduced to writing
one or two high-level integration tests which execute the &ldquo;happy path&rdquo;, and
when an error occurs it&rsquo;s hard to narrow it down to just one function</li></ul><div class="notices info"><p>To be clear, when I refer to <em>&ldquo;global state&rdquo;</em> I am referring to variables in
a program (typically declared with the keyword <code>static</code> in languages like C#,
Java, and Rust) which live for the lifetime of the program, only ever have
one instance, and where all uses of the variable are hard-coded to use that
instance (i.e. code refers to the variable by name instead of via a reference).</p><p>These variables don&rsquo;t necessarily need to be publicly accessible. All of
these problems occur when using <a href=https://en.wikipedia.org/wiki/Local_variable#Static_local_variables class=external-link target=_blank rel=noopener>static local variables</a> inside a
function or class. The core problems related to having static lifetime and
code directly referencing the variable are still there.</p></div><p>For my use case it&rsquo;s not really viable to use a different library because the
alternatives don&rsquo;t necessarily have the features we need. We also can&rsquo;t
rewrite the code to not use global mutable state because it&rsquo;s closed-source,
and even then would require tens of developer-years of effort. Which is tens of
developer-years more than I have to spare.</p><p>This necessitates a more pragmatic solution. In short, we needed to find a
way to use this 3rd party library without it polluting the rest of the
application too much.</p><p>I&rsquo;ll be implementing this in Rust primarily because it&rsquo;s quite good at
enforcing guarantees via the type system, but the general ideas aren&rsquo;t really
language-specific. It may just require more runtime checks.</p><div class="notices note"><p>The code written in this article is available <a href=https://github.com/Michael-F-Bryan/stateful-native-library class=external-link target=_blank rel=noopener>on GitHub</a>. Feel free to
browse through and steal code or inspiration.</p><p>If you found this useful or spotted a bug, let me know on the blog&rsquo;s
<a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com class=external-link target=_blank rel=noopener>issue tracker</a>!</p></div><h2 id=getting-acquainted>Getting Acquainted
<a class=heading-link href=#getting-acquainted><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>It would be a bit overwhelming to show you the full code, so I&rsquo;ve prepared a
rough example we can play around with.</p><p>Another important point to emphasize is the 3rd party library which initially
inspired this experiment is native code (I think it&rsquo;s written in C++). The
reason this is important is because it works touches memory directly and a
bug doesn&rsquo;t just mean an exception gets thrown, we could segfault and tear
down the entire process.</p><p>My decision to write use it from Rust also means we&rsquo;ll need to write some
<code>unsafe</code> code when crossing the language boundary and enforcing invariants.
This is actually <em>a good thing</em>! It gives us several easy-to-find places to
start from when troubleshooting a crash.</p><p>Without further ado, here&rsquo;s a header file defining the high-level interface of
the library we&rsquo;ll be working with.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// native/stateful.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if !defined(STATEFUL_H)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define STATEFUL_H
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdbool.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef __cplusplus
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The various possible return codes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>enum</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The function completed successfully.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RESULT_OK,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// A function was called out of order.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RESULT_BAD_STATE,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// One of the provided arguments is invalid.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RESULT_INVALID_ARGUMENT,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Initialize the library. MUST be run before any other function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_open</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Clean up any state associated with this library.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_close</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Begin setting parameters. MUST be run before any parameters can be set.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_setting_parameters</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_set_bool_var</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_set_int_var</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Finish setting parameters.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_setting_parameters</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Start adding input items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_adding_items</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// Add a single item as an input.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_add_item</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Start adding a group of items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_adding_group</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name);
</span></span><span style=display:flex><span><span style=color:#75715e>// Add an item to the current group. stateful_start_adding_group MUST be called
</span></span></span><span style=display:flex><span><span style=color:#75715e>// beforehand.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_add_group_item</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Finish adding items to the current group, adding the overall group to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// list of inputs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_adding_group</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// Finish setting up the list of inputs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_adding_items</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// A callback used to notify the caller when progress is made.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>int</span> (<span style=color:#f92672>*</span>progress_cb)(<span style=color:#66d9ef>int</span> percent);
</span></span><span style=display:flex><span><span style=color:#75715e>// A callback used to let the user retrieve results.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>int</span> (<span style=color:#f92672>*</span>result_cb)(<span style=color:#66d9ef>int</span> number_of_results);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Run the code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_execute</span>(progress_cb progress, result_cb result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Try to get the number of outputs in the result.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_get_num_outputs</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Tries to retrieve a particular output.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_get_output_by_index</span>(<span style=color:#66d9ef>int</span> index, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>value);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef __cplusplus
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif </span><span style=color:#75715e>// STATEFUL_H
</span></span></span></code></pre></div><div class="notices note"><p>The difficulty with trying to explain complex architecture is to find the
sweet spot between simplifying so much that people miss the point or the
example feels contrived, and providing so much detail that the reader loses
track of what&rsquo;s going on amongst the various moving parts.</p><p>Unfortunately, that means our <code>stateful.h</code> needs to be more than a couple
functions long to do this topic justice.</p></div><p>There&rsquo;s quite a lot going on here, so let&rsquo;s unpack it a bit.</p><p>Fortunately, this library does a pretty decent job of handling errors and most
of the time functions will give you some sort of return code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// The various possible return codes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>enum</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The function completed successfully.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RESULT_OK,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// A function was called out of order.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RESULT_BAD_STATE,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// One of the provided arguments is invalid.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RESULT_INVALID_ARGUMENT,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>In reality there are going to be a lot more error cases, but you get the gist.</p><p>The library needs to initialize some global state before first use and do
cleanup at the end, so our <code>stateful</code> library has <code>open()</code> and <code>close()</code>
functions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Initialize the library. MUST be run before any other function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_open</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Clean up any state associated with this library.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_close</span>();
</span></span></code></pre></div><p>(I don&rsquo;t know about you, but usually when I see this sort of code I&rsquo;ll start
thinking of using <a href=https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization class=external-link target=_blank rel=noopener>RAII</a>)</p><p>After initializing the library we need to set some global parameters. These are
various knobs and levers that are used to alter how the input is processed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Begin setting parameters. MUST be run before any parameters can be set.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_setting_parameters</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_set_bool_var</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_set_int_var</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Finish setting parameters.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_setting_parameters</span>();
</span></span></code></pre></div><p>You can see that we need to explicitly start and stop setting parameters. The
functions themselves take no arguments, which is a big give-away that the code
mutates global state under the hood.</p><p>Next we&rsquo;ve got functions for setting up the input.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Start adding input items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_adding_items</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// Add a single item as an input.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_add_item</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Start adding a group of items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_adding_group</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name);
</span></span><span style=display:flex><span><span style=color:#75715e>// Add an item to the current group. stateful_start_adding_group MUST be called
</span></span></span><span style=display:flex><span><span style=color:#75715e>// beforehand.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_add_group_item</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Finish adding items to the current group, adding the overall group to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// list of inputs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_adding_group</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// Finish setting up the list of inputs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_adding_items</span>();
</span></span></code></pre></div><p>If you squint, you&rsquo;ll see that the input is a list of individual named items
or groups of items. The <code>Input</code> that we&rsquo;re building procedurally might look
something like this (if written in Rust):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>ItemValue</span> {
</span></span><span style=display:flex><span>  Single(<span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>  Group(HashMap<span style=color:#f92672>&lt;</span>String, <span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span>),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Item</span> {
</span></span><span style=display:flex><span>    name: String,
</span></span><span style=display:flex><span>    value: <span style=color:#a6e22e>ItemValue</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Inputs</span> <span style=color:#f92672>=</span> Vec<span style=color:#f92672>&lt;</span>Item<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// The global we&#39;re initializing between `stateful_start_adding_items()` and
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/// `stateful_send_adding_items()`.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>mut</span> <span style=color:#66d9ef>TEMP_INPUTS</span>: <span style=color:#a6e22e>Inputs</span> <span style=color:#f92672>=</span> <span style=color:#f92672>..</span>.;
</span></span></code></pre></div><p>Now we&rsquo;ve set the algorithm&rsquo;s parameters and created our input, we can execute
the code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// A callback used to notify the caller when progress is made.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>int</span> (<span style=color:#f92672>*</span>progress_cb)(<span style=color:#66d9ef>int</span> percent);
</span></span><span style=display:flex><span><span style=color:#75715e>// A callback used to let the user retrieve results.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>int</span> (<span style=color:#f92672>*</span>result_cb)(<span style=color:#66d9ef>int</span> number_of_results);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Run the code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_execute</span>(progress_cb progress, result_cb result);
</span></span></code></pre></div><p>You&rsquo;ll notice this uses callback functions to notify the caller of progress and
when the results are ready. This wouldn&rsquo;t normally be a problem, except the
code doesn&rsquo;t let us provide some sort of <code>void *</code> pointer to user-provided data.
That means the only way our callbacks will be able to pass information to the
caller is by itself using static variables.</p><p>Finally, we get a couple functions for inspecting the output.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Try to get the number of outputs in the result.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_get_num_outputs</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>value);
</span></span><span style=display:flex><span><span style=color:#75715e>// Tries to retrieve a particular output.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_get_output_by_index</span>(<span style=color:#66d9ef>int</span> index, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>value);
</span></span></code></pre></div><p>Something to keep in mind is they can only be called from inside our
<code>result_cb</code> callback. Other than that, the functions are pretty ordinary.</p><div class="notices info"><p>I&rsquo;m going to be deliberately vague about what <code>stateful_execute()</code> actually
does. For our purposes the computation isn&rsquo;t actually relevant, we&rsquo;re mainly
concerned about <em>how</em> you can make use of such a &ldquo;stateful&rdquo; library while
maintaining nice things like,</p><ul><li>thread-safety</li><li>memory-safety</li><li>statically ensuring at compile time that it is impossible to do things out
of order</li></ul></div><p>If it helps, think of <code>stateful_execute()</code> as something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>stateful_execute</span>(
</span></span><span style=display:flex><span>    parameters: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>HashMap</span><span style=color:#f92672>&lt;</span>String, Value<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    items: Vec<span style=color:#f92672>&lt;</span>Input<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    on_progress: <span style=color:#a6e22e>impl</span> FnMut(percent: <span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>) -&gt; Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// magic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>We take a set of parameters and list of inputs and return a list of integers.</p><h2 id=our-high-level-approach>Our High-Level Approach
<a class=heading-link href=#our-high-level-approach><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We have two main goals for this exercise,</p><ul><li>Create a safe wrapper which lets us use this library while maintaining memory
and thread-safety</li><li>Use the type system to <em>make illegal states unrepresentable</em></li></ul><p>The first goal can be fulfilled fairly easily, because this library can only be
used by one bit of code at a time (<code>static</code> variables aren&rsquo;t thread-safe) we
can make a type which represents a &ldquo;handle&rdquo; to the library.</p><p>We can then write our code in such a way that calling a function from our
<code>stateful</code> library <em>needs</em> you to have a valid handle.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::marker::PhantomData;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// A handle to the `stateful` library.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Library</span> {
</span></span><span style=display:flex><span>    _not_send: <span style=color:#a6e22e>PhantomData</span><span style=color:#f92672>&lt;*</span><span style=color:#66d9ef>const</span> ()<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Something to note is the use of <code>PhantomData&lt;*const ()></code> here. This makes sure
<code>Library</code> is <code>!Send</code> and <code>!Sync</code> (i.e. it can&rsquo;t be used from another thread).</p><p>We can double-check that <code>Library</code> can&rsquo;t be used from other threads by adding
the <a href=https://crates.io/crates/static_assertions class=external-link target=_blank rel=noopener><code>static_assertions</code> crate</a> as a dev-dependency&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cargo add --dev static_assertions
</span></span><span style=display:flex><span>    Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
</span></span><span style=display:flex><span>      Adding static_assertions v1.1.0 to dev-dependencies
</span></span></code></pre></div><p>&mldr; And then writing a new test.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    static_assertions::assert_not_impl_any!(Library: Send, Sync);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we add an impl for <code>Send</code>, running <code>cargo test</code> will show a build failure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> /// A handle to the `stateful` library.
</span></span><span style=display:flex><span> pub struct Library {
</span></span><span style=display:flex><span>     _not_send: PhantomData&lt;*const ()&gt;,
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+unsafe impl Send for Library {}
</span></span></span></code></pre></div><p>The error message leaves a lot to be desired, but this is what you&rsquo;d see if
<code>Library</code> were <code>Send</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cargo test
</span></span><span style=display:flex><span>   Compiling stateful-native-library v0.1.0 (/home/michael/Documents/stateful-native-library)
</span></span><span style=display:flex><span>error[E0282]: type annotations needed for `fn() {&lt;Library as tests::_::{{closure}}#0::AmbiguousIfImpl&lt;_&gt;&gt;::some_item}`
</span></span><span style=display:flex><span>  --&gt; src/lib.rs:14:5
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span>14 |     static_assertions::assert_not_impl_any!(Library: Send, Sync);
</span></span><span style=display:flex><span>   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span></span><span style=display:flex><span>   |     |
</span></span><span style=display:flex><span>   |     consider giving this pattern the explicit type `fn() {&lt;Library as tests::_::{{closure}}#0::AmbiguousIfImpl&lt;_&gt;&gt;::some_item}`, with the type parameters specified
</span></span><span style=display:flex><span>   |     cannot infer type
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span>   = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>error: aborting due to previous error
</span></span></code></pre></div><p>Now we have a thread-safe <code>Library</code> type, we also need to make sure it&rsquo;s not
possible to create more than one <code>Library</code> at a time. This can be done easily
enough using a flag (<code>AtomicBool</code>) which is set to <code>true</code> when <code>Library</code> is
created and <code>false</code> when it is destroyed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> sync::atomic::{AtomicBool, Ordering};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>LIBRARY_IN_USE</span>: <span style=color:#a6e22e>AtomicBool</span> <span style=color:#f92672>=</span> AtomicBool::new(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Library {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>() -&gt; Result<span style=color:#f92672>&lt;</span>Library, Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>LIBRARY_IN_USE</span>.compare_and_swap(<span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>true</span>, Ordering::SeqCst)
</span></span><span style=display:flex><span>            <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Ok(Library { _not_send: <span style=color:#a6e22e>PhantomData</span> })
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            Err(Error::AlreadyInUse)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Drop <span style=color:#66d9ef>for</span> Library {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>drop</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) { <span style=color:#66d9ef>LIBRARY_IN_USE</span>.store(<span style=color:#66d9ef>false</span>, Ordering::SeqCst); }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// The various error cases that may be encountered while using this library.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[derive(Debug, Copy, Clone, PartialEq, thiserror::Error)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;The library is already in use&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    AlreadyInUse,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Yes I know the irony in using a <code>static</code> variable to workaround another
library&rsquo;s zealous use of <code>static</code> variables, but sometimes you&rsquo;ve got to
break a couple eggs to make an omelette 🤷‍</p><p>To make sure we&rsquo;ve implemented this correctly, let&rsquo;s write a test which
deliberately tries to create multiple <code>Library</code> handles at the same time.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// lib/src.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>cant_create_multiple_library_handles_at_the_same_time</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> first_library <span style=color:#f92672>=</span> Library::new().unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// make sure the flag is set
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        assert!(<span style=color:#66d9ef>LIBRARY_IN_USE</span>.load(Ordering::SeqCst));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// then try to create another handle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        assert!(Library::new().is_err());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// explicitly drop the first library so we know it clears the flag
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        drop(first_library);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        assert!(<span style=color:#f92672>!</span><span style=color:#66d9ef>LIBRARY_IN_USE</span>.load(Ordering::SeqCst));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// now the old handle is destroyed, we can create another
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> _another <span style=color:#f92672>=</span> Library::new().unwrap();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, to ensure functions aren&rsquo;t called out of order we can create some sort
of type-level state machine.</p><p>This idea was originally taken from <a href=https://users.rust-lang.org/t/common-strategies-for-wrapping-a-library-that-uses-globals-everywhere/37944 class=external-link target=_blank rel=noopener>a thread on the Rust users
forum</a>. You&rsquo;ll notice the approach we&rsquo;re taking is uncannily similar
to the solution proposed by <a href=https://users.rust-lang.org/u/yandros/summary class=external-link target=_blank rel=noopener>@Yandros</a>,</p><blockquote><p>I would wrap the library using a type-level state machine to make misusage
simply not compile; If necessary, you can even use the singleton pattern to
enforce no concurrency problems (which would be the only part checked at
runtime).</p></blockquote><p>One of the invariants we&rsquo;d like to maintain is that when setting parameters
it should be impossible to use any non-parameter-setting functionality.</p><p>This is where lifetimes really show their power. Using a <code>&amp;mut Library</code>
reference, the compiler can statically ensure some <code>SettingParameters</code> type
(which we&rsquo;re about to create) has unique access to our <code>Library</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Library {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>set_parameters</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) -&gt; <span style=color:#a6e22e>SettingParameters</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        SettingParameters { _library: <span style=color:#a6e22e>self</span> }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SettingParameters</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    _library: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;lib</span> <span style=color:#a6e22e>mut</span> Library,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> SettingParameters<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>boolean</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, _name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, _value: <span style=color:#66d9ef>bool</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self {
</span></span><span style=display:flex><span>        unimplemented!()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>integer</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, _name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, _value: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self {
</span></span><span style=display:flex><span>        unimplemented!()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You&rsquo;ll notice I&rsquo;m deliberately leaving the body for <code>boolean()</code> and
<code>integer()</code> as <code>unimplemented!()</code>. We&rsquo;re just setting up the infrastructure
for this &ldquo;type-level state machine&rdquo; for now and will execute the actual FFI
calls in a bit.</p><p>Once we&rsquo;ve set the various parameters we need to start constructing our inputs.
This can be done using some sort of <code>RecipeBuilder</code> which leverages the
<code>&amp;mut Library</code> trick from <code>SettingParameters</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Library {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>create_recipe</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) -&gt; <span style=color:#a6e22e>RecipeBuilder</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        RecipeBuilder { _library: <span style=color:#a6e22e>self</span> }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>RecipeBuilder</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    _library: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;lib</span> <span style=color:#a6e22e>mut</span> Library,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> RecipeBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add_item</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, _name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, _value: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self {
</span></span><span style=display:flex><span>        unimplemented!()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we&rsquo;ve got a problem, how can you add a group of items to the &ldquo;recipe&rdquo;? We
need to make sure it&rsquo;s not possible to call <code>RecipeBuilder::add_item()</code> while
in the middle of constructing a group because it could mess up the library&rsquo;s
internals.</p><div class="notices tip"><p>This may seem a bit extreme, but it&rsquo;s quite possible that adding a new item
triggers a resize in our <code>TEMP_INPUTS</code> vector which invalidates any references
that may have been used when constructing the group.</p><p>I <em>really</em> don&rsquo;t want something like this to happen because it&rsquo;s one of those
bugs that will be almost impossible to pinpoint in the wild. It&rsquo;s better to
take the conservative approach here and just outlaw things like
<code>RecipeBuilder::add_item()</code> when building a group.</p></div><p>If you think for a moment, that&rsquo;s the same problem we had with <code>Library</code> when
we wanted to make sure you can <em>either</em> be creating a recipe using the
<code>RecipeBuilder</code>, or setting parameters with <code>SettingParameters</code>. We just need to
add another layer of <code>&amp;mut</code>s!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> RecipeBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add_group</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span><span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>&#39;r</span> <span style=color:#66d9ef>mut</span> self, _name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>GroupBuilder</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        GroupBuilder {
</span></span><span style=display:flex><span>            _recipe_builder: <span style=color:#a6e22e>self</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>GroupBuilder</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    _recipe_builder: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;r</span> <span style=color:#a6e22e>mut</span> RecipeBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> GroupBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add_item</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, _name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, _value: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self { unimplemented!() }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>finish</span>(self) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;r</span> <span style=color:#a6e22e>mut</span> RecipeBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> { self._recipe_builder }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, I&rsquo;m going to continue with this builder pattern theme and give
<code>RecipeBuilder</code> a <code>build()</code> method which returns a <code>Recipe</code>. Here our
<code>Recipe</code> will just be an empty type indicating we&rsquo;ve fully assembled the
inputs.</p><p>It acts as a &ldquo;token&rdquo; indicating all inputs are constructed and we&rsquo;re ready to
call <code>stateful_execute()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> RecipeBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>build</span>(self) -&gt; <span style=color:#a6e22e>Recipe</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        Recipe {
</span></span><span style=display:flex><span>            _library: <span style=color:#a6e22e>self</span>._library,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Recipe</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    _library: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;lib</span> <span style=color:#a6e22e>mut</span> Library,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you&rsquo;ve been keeping up, we&rsquo;re now at the point where everything is
initialized and we&rsquo;re ready to consume this <code>Recipe</code> to get the output.</p><p>It seems odd for a <code>Recipe</code> to know how to execute itself, so we&rsquo;ll create
some sort of top-level <code>execute()</code> function instead of adding it as a method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>&lt;</span>P<span style=color:#f92672>&gt;</span>(_recipe: <span style=color:#a6e22e>Recipe</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span>, _progress: <span style=color:#a6e22e>P</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Output, Error<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    P: FnMut(<span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    unimplemented!()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Output</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> items: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To make sure the code we&rsquo;ve written prevents invalid uses of <code>Library</code>, let&rsquo;s
use Rustdoc&rsquo;s <code>compile_fail</code> feature to document our functions with examples
we expect <code>rustc</code> to reject.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Library {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Start creating the inputs for [`execute()`].
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>///
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// The [`RecipeBuilder`] uses lifetimes to make sure you can&#39;t do anything
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// else while creating a [`Recipe`].
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>///
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// ```rust,compile_fail
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// # use stateful_native_library::Library;
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// let mut library = Library::new().unwrap();
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>///
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// // start creating the recipe
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// let mut recipe_builder = library.create_recipe();
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>///
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// // trying to set parameters while recipe_builder is alive is an error
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// library.set_parameters();
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>///
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// // recipe_builder is still alive until here
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// drop(recipe_builder);
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// ```
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>create_recipe</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) -&gt; <span style=color:#a6e22e>RecipeBuilder</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Looking back, you can see that fulfilling the <code>!Send</code> and <code>!Sync</code> goal was
quite easy to do. By making sure <code>Library: !Send + !Sync</code>, anything
referencing <code>Library</code> is also <code>!Send + !Sync</code>.</p><p>On the other hand, ensuring functions can only be called in the correct order
is a lot more invasive. We needed to restructure our entire API using complex
concepts like lifetimes and RAII to encode the logical equivalent of a
type-level state machine.</p><p>Here&rsquo;s a more detailed example showing the error messages a user would get if
they tried to do things in the wrong order.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>this_should_not_compile</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> library <span style=color:#f92672>=</span> Library::new().unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> _sp <span style=color:#f92672>=</span> library.set_parameters();
</span></span><span style=display:flex><span>        library.create_recipe(); <span style=color:#75715e>// ERROR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> recipe <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> recipe_builder <span style=color:#f92672>=</span> library.create_recipe();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> group_builder <span style=color:#f92672>=</span> recipe_builder.add_group(<span style=color:#e6db74>&#34;Group&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// try to add an item to the recipe while building a group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        recipe_builder.add_item(<span style=color:#e6db74>&#34;asdf&#34;</span>, <span style=color:#ae81ff>123</span>); <span style=color:#75715e>// ERROR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// finish building the group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        group_builder.finish();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// we can now add items
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        recipe_builder.add_item(<span style=color:#e6db74>&#34;asdf&#34;</span>, <span style=color:#ae81ff>123</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// you can&#39;t set parameters while building the recipe
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        library.set_parameters(); <span style=color:#75715e>// ERROR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        recipe_builder.build()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> got <span style=color:#f92672>=</span> execute(recipe, <span style=color:#f92672>|</span>percent<span style=color:#f92672>|</span> println!(<span style=color:#e6db74>&#34;Progress: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>%&#34;</span>, percent));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assert!(got.is_ok());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And this is what <code>rustc</code> will emit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cargo test
</span></span><span style=display:flex><span>   Compiling stateful-native-library v0.1.0 (/home/michael/Documents/stateful-native-library)
</span></span><span style=display:flex><span>error[E0499]: cannot borrow `library` as mutable more than once at a time
</span></span><span style=display:flex><span>   --&gt; src/lib.rs:284:13
</span></span><span style=display:flex><span>    |
</span></span><span style=display:flex><span>283 |             let _sp = library.set_parameters();
</span></span><span style=display:flex><span>    |                       ------- first mutable borrow occurs here
</span></span><span style=display:flex><span>284 |             library.create_recipe(); // ERROR
</span></span><span style=display:flex><span>    |             ^^^^^^^ second mutable borrow occurs here
</span></span><span style=display:flex><span>285 |         }
</span></span><span style=display:flex><span>    |         - first borrow might be used here, when `_sp` is dropped and runs the `Drop` code for type `SettingParameters`
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>error[E0499]: cannot borrow `recipe_builder` as mutable more than once at a time
</span></span><span style=display:flex><span>   --&gt; src/lib.rs:292:13
</span></span><span style=display:flex><span>    |
</span></span><span style=display:flex><span>289 |             let group_builder = recipe_builder.add_group(&#34;Group&#34;);
</span></span><span style=display:flex><span>    |                                 -------------- first mutable borrow occurs here
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>292 |             recipe_builder.add_item(&#34;asdf&#34;, 123); // ERROR
</span></span><span style=display:flex><span>    |             ^^^^^^^^^^^^^^ second mutable borrow occurs here
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>295 |             group_builder.finish();
</span></span><span style=display:flex><span>    |             ------------- first borrow later used here
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>error[E0499]: cannot borrow `library` as mutable more than once at a time
</span></span><span style=display:flex><span>   --&gt; src/lib.rs:301:13
</span></span><span style=display:flex><span>    |
</span></span><span style=display:flex><span>288 |             let mut recipe_builder = library.create_recipe();
</span></span><span style=display:flex><span>    |                                      ------- first mutable borrow occurs here
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>301 |             library.set_parameters(); // ERROR
</span></span><span style=display:flex><span>    |             ^^^^^^^ second mutable borrow occurs here
</span></span><span style=display:flex><span>302 |
</span></span><span style=display:flex><span>303 |             recipe_builder.build()
</span></span><span style=display:flex><span>    |             -------------- first borrow later used here
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>error: aborting due to 3 previous errors
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>For more information about this error, try `rustc --explain E0499`.
</span></span><span style=display:flex><span>error: could not compile `stateful-native-library`.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>To learn more, run the command again with --verbose.
</span></span></code></pre></div><p>It&rsquo;s moments like these that make you appreciate how useful the concept of
lifetimes can be, and just how readable <code>rustc</code>&rsquo;s error messages are 🙂</p><h2 id=creating-ffi-bindings>Creating FFI Bindings
<a class=heading-link href=#creating-ffi-bindings><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>While you were reading through that previous section I took the liberty of
preparing some C++ code which satisfies the <code>stateful.h</code> interface.</p><p>The code isn&rsquo;t entirely relevant, but it&rsquo;s all <a href=https://github.com/Michael-F-Bryan/stateful-native-library/tree/master/native class=external-link target=_blank rel=noopener>on GitHub</a> if you&rsquo;re
curious. I don&rsquo;t write C++ full time, so let me know if you spot any bugs or
code which could have been written better.</p><details><summary>a big wall of code</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// native/stateful.cpp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;stateful.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;vector&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unordered_map&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;variant&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdint.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;memory&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>State</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Uninitialized,
</span></span><span style=display:flex><span>    Initialized,
</span></span><span style=display:flex><span>    SettingParameters,
</span></span><span style=display:flex><span>    AddingInputs,
</span></span><span style=display:flex><span>    AddingGroup,
</span></span><span style=display:flex><span>    Executing,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Item</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> flatten(std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int32_t</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>&amp;</span>dest) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>Item() {}
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Group</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> Item
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>unordered_map<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>string, <span style=color:#66d9ef>int32_t</span><span style=color:#f92672>&gt;</span> items;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> insert(std<span style=color:#f92672>::</span>string key, <span style=color:#66d9ef>int32_t</span> value)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        items.insert(std<span style=color:#f92672>::</span>make_pair(key, value));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>flatten</span>(std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int32_t</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>&amp;</span>dest)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> <span style=color:#f92672>&amp;&amp;</span>pair : items)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            dest.push_back(pair.second);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SingleItem</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> Item
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> value;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    SingleItem(<span style=color:#66d9ef>int32_t</span> v) <span style=color:#f92672>:</span> value(v) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>flatten</span>(std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int32_t</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>&amp;</span>dest)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        dest.push_back(value);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Parameter <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>variant<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int32_t</span>, <span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// our actual global variables
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>State current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>Uninitialized;
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>unordered_map<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>string, std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>Item<span style=color:#f92672>&gt;&gt;</span> <span style=color:#f92672>*</span>inputs;
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>unordered_map<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>string, Parameter<span style=color:#f92672>&gt;</span> <span style=color:#f92672>*</span>parameters;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int32_t</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>*</span>temp_results;
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>string <span style=color:#f92672>*</span>temp_group_name;
</span></span><span style=display:flex><span>Group <span style=color:#f92672>*</span>temp_group;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_open</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>Uninitialized)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    inputs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> std<span style=color:#f92672>::</span>unordered_map<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>string, std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>Item<span style=color:#f92672>&gt;&gt;</span>();
</span></span><span style=display:flex><span>    parameters <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> std<span style=color:#f92672>::</span>unordered_map<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>string, Parameter<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>Initialized;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_close</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (inputs)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>delete</span> inputs;
</span></span><span style=display:flex><span>        inputs <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (parameters)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>delete</span> parameters;
</span></span><span style=display:flex><span>        parameters <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>Uninitialized;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_setting_parameters</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>Initialized)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>SettingParameters;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> set_parameter(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, T value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>SettingParameters)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>name)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_INVALID_ARGUMENT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parameters<span style=color:#f92672>-&gt;</span>insert(std<span style=color:#f92672>::</span>make_pair(name, value));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_set_bool_var</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>bool</span> value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> set_parameter(name, value);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_set_int_var</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> set_parameter(name, value);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_setting_parameters</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>SettingParameters)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>Initialized;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_adding_items</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>Initialized)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>AddingInputs;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> add_input(std<span style=color:#f92672>::</span>string name, <span style=color:#66d9ef>const</span> T value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>AddingInputs)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>-&gt;</span>insert(std<span style=color:#f92672>::</span>pair(name, std<span style=color:#f92672>::</span>make_unique<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(value)));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_add_item</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> add_input(name, SingleItem(value));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_start_adding_group</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>AddingInputs)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    temp_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> std<span style=color:#f92672>::</span>string(name);
</span></span><span style=display:flex><span>    temp_group <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Group();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>AddingGroup;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_add_group_item</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>int</span> value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>AddingGroup)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    temp_group<span style=color:#f92672>-&gt;</span>insert(name, value);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_adding_group</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>AddingGroup)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>AddingInputs;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    add_input(<span style=color:#f92672>*</span>temp_group_name, <span style=color:#f92672>*</span>temp_group);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>delete</span> temp_group;
</span></span><span style=display:flex><span>    temp_group <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>delete</span> temp_group_name;
</span></span><span style=display:flex><span>    temp_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_end_adding_items</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>AddingInputs)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>Initialized;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// This overload stuff legitimately feels like magic...
</span></span></span><span style=display:flex><span><span style=color:#75715e>// https://www.bfilipek.com/2018/06/variant.html#visitors-for-stdvariant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>overload</span> <span style=color:#f92672>:</span> Ts...
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> Ts<span style=color:#f92672>::</span><span style=color:#66d9ef>operator</span>()...;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>overload(Ts...)<span style=color:#f92672>-&gt;</span>overload<span style=color:#f92672>&lt;</span>Ts...<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_execute</span>(progress_cb progress, result_cb result)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>Initialized)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>Executing;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int32_t</span><span style=color:#f92672>&gt;</span> results;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> <span style=color:#f92672>&amp;</span>pair : <span style=color:#f92672>*</span>inputs)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        pair.second<span style=color:#f92672>-&gt;</span>flatten(results);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>double</span> percent <span style=color:#f92672>=</span> <span style=color:#ae81ff>100.0</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>/</span> inputs<span style=color:#f92672>-&gt;</span>size();
</span></span><span style=display:flex><span>        progress((<span style=color:#66d9ef>int</span>)percent);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        i<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    progress(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    temp_results <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>results;
</span></span><span style=display:flex><span>    result(results.size());
</span></span><span style=display:flex><span>    temp_results <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_state <span style=color:#f92672>=</span> State<span style=color:#f92672>::</span>Initialized;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_get_num_outputs</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>Executing)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>value <span style=color:#f92672>=</span> temp_results<span style=color:#f92672>-&gt;</span>size();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>stateful_get_output_by_index</span>(<span style=color:#66d9ef>int</span> index, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_state <span style=color:#f92672>!=</span> State<span style=color:#f92672>::</span>Executing)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_BAD_STATE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> <span style=color:#f92672>&amp;</span>results <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>temp_results;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (index <span style=color:#f92672>&gt;=</span> results.size())
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RESULT_INVALID_ARGUMENT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>value <span style=color:#f92672>=</span> results[index];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RESULT_OK;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details><p>The first step in using our stateful library from Rust is to make sure <code>cargo</code>
automatically compiles the code for us. Luckily <a href=https://crates.io/crates/cc class=external-link target=_blank rel=noopener>the <code>cc</code> crate</a> was
designed for exactly this purpose.</p><p>First we need to add <code>cc</code> as a <code>build </code>dependency.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cargo add --build cc
</span></span><span style=display:flex><span>    Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
</span></span><span style=display:flex><span>      Adding cc v1.0.50 to build-dependencies
</span></span></code></pre></div><p>Then we can create a <a href=https://doc.rust-lang.org/cargo/reference/build-scripts.html class=external-link target=_blank rel=noopener>build script</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// build.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> cc::Build;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::{env, path::PathBuf};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> project_dir <span style=color:#f92672>=</span> PathBuf::from(env::var(<span style=color:#e6db74>&#34;CARGO_MANIFEST_DIR&#34;</span>).unwrap());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> native <span style=color:#f92672>=</span> project_dir.join(<span style=color:#e6db74>&#34;native&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Build::new()
</span></span><span style=display:flex><span>        .include(<span style=color:#f92672>&amp;</span>native)
</span></span><span style=display:flex><span>        .file(native.join(<span style=color:#e6db74>&#34;stateful.cpp&#34;</span>))
</span></span><span style=display:flex><span>        .cpp(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>        .flag_if_supported(<span style=color:#e6db74>&#34;-std=c++17&#34;</span>)
</span></span><span style=display:flex><span>        .compile(<span style=color:#e6db74>&#34;stateful&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next we need declarations that for the functions in <code>stateful.h</code> that can be
called from Rust. These sorts of things are a pain to do by hand, so I almost
always use <a href=https://github.com/rust-lang/rust-bindgen class=external-link target=_blank rel=noopener><code>bindgen</code></a> for this.</p><p>I ended up using this particular set of incantations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ bindgen native/stateful.h  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --whitelist-function &#39;stateful_.*&#39; \
</span></span><span style=display:flex><span>    --whitelist-var &#39;RESULT_.*&#39; \
</span></span><span style=display:flex><span>    --output src/bindings.rs \
</span></span><span style=display:flex><span>    --raw-line &#39;#![allow(bad_style, dead_code)]&#39;
</span></span><span style=display:flex><span>$ head src/bindings.rs
</span></span><span style=display:flex><span>/* automatically generated by rust-bindgen */
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>#!<span style=color:#f92672>[</span>allow<span style=color:#f92672>(</span>bad_style, dead_code<span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>extern &#34;C&#34; {
</span></span><span style=display:flex><span>    pub fn stateful_open() -&gt; ::std::os::raw::c_int;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>extern &#34;C&#34; {
</span></span><span style=display:flex><span>    pub fn stateful_close() -&gt; ::std::os::raw::c_int;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We also need to update <code>lib.rs</code> to include <code>src/bindings.rs</code> as a sub-module.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> bindings;
</span></span></code></pre></div><p>Before going any further I&rsquo;d like to double-check the <code>stateful</code> native library
is linked with our Rust code properly. The easiest way to do that is with a
simple <a href=https://en.wikipedia.org/wiki/Smoke_testing_%28software%29 class=external-link target=_blank rel=noopener>smoke test</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> std::os::raw::c_int;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>ffi_bindings_smoke_test</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>            assert_eq!(bindings::stateful_open(), bindings::<span style=color:#66d9ef>RESULT_OK</span> <span style=color:#66d9ef>as</span> c_int);
</span></span><span style=display:flex><span>            assert_eq!(bindings::stateful_close(), bindings::<span style=color:#66d9ef>RESULT_OK</span> <span style=color:#66d9ef>as</span> c_int);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices tip"><p>It&rsquo;s always a good idea to do these sorts of sanity checks. For one, you&rsquo;ve
added a test that verifies you can always link with the native library, plus it
also lets you identify other build problems early on.</p><p>Ironically, while writing that smoke test and saying how important it is to
have them, I kept having compilation errors because the linker wasn&rsquo;t able to
find <code>stateful_open()</code> and <code>stateful_close()</code>.</p><p>It turns out I forgot to add a <code>#ifdef __cplusplus extern "C" {</code> line to
<code>stateful.h</code> to prevent the compiler from mangling the symbols for our
<code>stateful_*</code>. It took a couple minutes of staring at linker errors, but after
compiling <code>stateful.cpp</code> manually and using <code>nm stateful.o | grep ' T '</code> I
noticed the mangled names and figured out what was going on.</p></div><h2 id=writing-a-safe-interface-to-libstateful>Writing a Safe Interface to libstateful
<a class=heading-link href=#writing-a-safe-interface-to-libstateful><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We&rsquo;re now ready to go from declaring our type-level state machine to giving it
some behaviour to execute when transitioning from state to state.</p><p>To make things easier we&rsquo;re going to define a helper trait for converting from
a return code to a <code>Result&lt;(), Error></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::convert::TryFrom;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> IntoResult {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>into_result</span>(self) -&gt; Result<span style=color:#f92672>&lt;</span>(), Error<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> IntoResult <span style=color:#66d9ef>for</span> c_int {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>into_result</span>(self) -&gt; Result<span style=color:#f92672>&lt;</span>(), Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> code <span style=color:#f92672>=</span> <span style=color:#66d9ef>u32</span>::try_from(self).map_err(<span style=color:#f92672>|</span>_<span style=color:#f92672>|</span> Error::Other(self))<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> code {
</span></span><span style=display:flex><span>            bindings::<span style=color:#66d9ef>RESULT_OK</span> <span style=color:#f92672>=&gt;</span> Ok(()),
</span></span><span style=display:flex><span>            bindings::<span style=color:#66d9ef>RESULT_BAD_STATE</span> <span style=color:#f92672>=&gt;</span> Err(Error::InvalidState),
</span></span><span style=display:flex><span>            bindings::<span style=color:#66d9ef>RESULT_INVALID_ARGUMENT</span> <span style=color:#f92672>=&gt;</span> Err(Error::InvalidArgument),
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> Err(Error::Other(self)),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>By itself this trait isn&rsquo;t overly interesting, but we can leverage it to enable
<code>?</code> for error handling.</p><p>This also gives us a chance to flesh out the <code>Error</code> enum.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Copy, Clone, PartialEq, thiserror::Error)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;The library is already in use&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    AlreadyInUse,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;The underlying library is in an invalid state&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    InvalidState,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;An argument was invalid&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    InvalidArgument,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Unknown error code: {}&#34;</span><span style=color:#75715e>, _0)]</span>
</span></span><span style=display:flex><span>    Other(c_int),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=proper-raii>Proper RAII
<a class=heading-link href=#proper-raii><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Now that&rsquo;s out of the way, the first part to address is our <code>Library</code> type.
At the moment we&rsquo;re just setting a flag to <code>true</code> and returning a <code>Library</code>
handle, but we aren&rsquo;t actually initializing the underlying library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> // src/lib.rs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> impl Library {
</span></span><span style=display:flex><span>     pub fn new() -&gt; Result&lt;Library, Error&gt; {
</span></span><span style=display:flex><span>         if LIBRARY_IN_USE.compare_and_swap(false, true, Ordering::SeqCst)
</span></span><span style=display:flex><span>             == false
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span><span style=color:#a6e22e>+            unsafe {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                bindings::stateful_open().into_result()?;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+            }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>             Ok(Library { _not_send: PhantomData })
</span></span><span style=display:flex><span>         } else {
</span></span><span style=display:flex><span>             Err(Error::AlreadyInUse)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>     }
</span></span></code></pre></div><p>You can also see how that <code>IntoResult</code> trait helps to remove the visual noise
associated with constant error checks.</p><p>When the <code>Library</code> gets destroyed we need to make sure everything gets cleaned
up.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> // src/lib.rs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> impl Drop for Library {
</span></span><span style=display:flex><span><span style=color:#f92672>-    fn drop(&amp;mut self) { LIBRARY_IN_USE.store(false, Ordering::SeqCst); }
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    fn drop(&amp;mut self) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        unsafe {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+            let _ = bindings::stateful_close().into_result();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        LIBRARY_IN_USE.store(false, Ordering::SeqCst);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> }
</span></span></code></pre></div><div class="notices note"><p>The ordering of operations is important here. We want to make sure the
<code>LIBRARY_IN_USE</code> flag is set to <code>true</code> for the entire time we&rsquo;re interacting
with the underlying code.</p></div><p>Our <code>SettingParameters</code> and <code>RecipeBuilder</code> types use RAII to represent when
the library is in a certain state. We&rsquo;ll need to call the corresponding
<code>*_start_*</code> and <code>*_end_*</code> functions when constructing and destroying them to
make sure their lifetimes align with the state of the native library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> // src/lib.rs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> impl Library {
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     pub fn set_parameters(&amp;mut self) -&gt; SettingParameters&lt;&#39;_&gt; {
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        cant_fail!(unsafe { bindings::stateful_start_setting_parameters() });
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>         SettingParameters { _library: self }
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     pub fn create_recipe(&amp;mut self) -&gt; RecipeBuilder&lt;&#39;_&gt; {
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        cant_fail!(unsafe { bindings::stateful_start_adding_items() });
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>         RecipeBuilder {
</span></span><span style=display:flex><span>             _library: ManuallyDrop::new(self),
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+impl&lt;&#39;lib&gt; Drop for SettingParameters&lt;&#39;lib&gt; {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    fn drop(&amp;mut self) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        unsafe {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+            let _ = bindings::stateful_end_setting_parameters().into_result();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+impl&lt;&#39;lib&gt; Drop for RecipeBuilder&lt;&#39;lib&gt; {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    fn drop(&amp;mut self) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        unsafe {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+            let _ = bindings::stateful_end_adding_items().into_result();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+}
</span></span></span></code></pre></div><p>You&rsquo;ll notice that I&rsquo;ve introduced a <code>cant_fail!()</code> macro here. I&rsquo;ve
introduced an assertion which will blow up loudly if that assumption isn&rsquo;t
valid. Because we&rsquo;re using the type system to statically guarantee code can&rsquo;t
be executed out of order and that the arguments we provide are always valid,
these otherwise infallible functions should fail quickly and loudly to
indicate a possible programming error.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// A macro you can use when you *know* a function has been statically proven to
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/// not fail.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>macro_rules<span style=color:#f92672>!</span> cant_fail {
</span></span><span style=display:flex><span>    (<span style=color:#75715e>$return_code</span>:<span style=color:#a6e22e>expr</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> Err(e) <span style=color:#f92672>=</span> <span style=color:#75715e>$return_code</span>.into_result() {
</span></span><span style=display:flex><span>            unreachable!(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;The type system should ensure this function can&#39;t fail: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>                e
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We need to do a bit more work when adding calls to
<code>stateful_start_adding_group()</code> and <code>stateful_end_adding_group()</code> for our
<code>GroupBuilder</code> because it is the first proper function that we need to
provide arguments for.</p><p>To help convert between a Rust <code>&amp;str</code> and <code>const char *</code> we can use the
<a href=https://doc.rust-lang.org/std/ffi/struct.CString.html class=external-link target=_blank rel=noopener><code>std::ffi::CString</code></a> type. The constructor can fail with a <code>NulError</code>
if a string contains an internal <code>null</code> byte, but considering most &ldquo;proper&rdquo;
strings in Rust won&rsquo;t ever contain <code>null</code> it seems fair to simplify the API by
panicking instead of propagating the error.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>NUL_MSG</span>: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;a valid Rust string shouldn&#39;t contain null characters&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> RecipeBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add_group</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span><span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>&#39;r</span> <span style=color:#66d9ef>mut</span> self, name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>GroupBuilder</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> CString::new(name).expect(<span style=color:#66d9ef>NUL_MSG</span>);
</span></span><span style=display:flex><span>        cant_fail!(<span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>            bindings::stateful_start_adding_group(name.as_ptr())
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        GroupBuilder { _recipe_builder: <span style=color:#a6e22e>ManuallyDrop</span>::new(self) }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> Drop <span style=color:#66d9ef>for</span> GroupBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>drop</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> bindings::stateful_end_adding_group().into_result();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=finishing-it-off>Finishing It Off
<a class=heading-link href=#finishing-it-off><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>At this point it&rsquo;s just a case of grepping for any remaining functions
containing <code>unimplemented!()</code> and translating the arguments so they can be
passed to the corresponding functions in our <code>stateful</code> library.</p><p>First up are the methods on <code>SettingParameters</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> SettingParameters<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>boolean</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, value: <span style=color:#66d9ef>bool</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> CString::new(name).expect(<span style=color:#66d9ef>NUL_MSG</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>            cant_fail!(bindings::stateful_set_bool_var(name.as_ptr(), value));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>integer</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, value: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> CString::new(name).expect(<span style=color:#66d9ef>NUL_MSG</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>            cant_fail!(bindings::stateful_set_int_var(name.as_ptr(), value));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then <code>RecipeBuilder</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> RecipeBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add_item</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, value: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> CString::new(name).expect(<span style=color:#66d9ef>NUL_MSG</span>);
</span></span><span style=display:flex><span>        cant_fail!(<span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>            bindings::stateful_add_item(name.as_ptr(), value)
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Our <code>GroupBuilder</code> also has an <code>unimplemented!()</code> method that needs
implementing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> GroupBuilder<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;r</span>, <span style=color:#a6e22e>&#39;lib</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add_item</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, value: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Self {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> CString::new(name).expect(<span style=color:#66d9ef>NUL_MSG</span>);
</span></span><span style=display:flex><span>        cant_fail!(<span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>            bindings::stateful_add_group_item(name.as_ptr(), value)
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The only remaining <code>unimplemented!()</code> is in our <code>execute()</code> function.</p><p>This one is a little tricky because we somehow need to pass results from the
&ldquo;finished&rdquo; callback back to our <code>execute()</code> function so they can be returned to
the caller.</p><p>Unfortunately, we don&rsquo;t have the option of passing a pointer to some state
we can put the result in, so we&rsquo;ll need to stash it in a temporary <code>static</code>
variable.</p><div class="notices tip"><p>If you are ever designing a C API, the <em>correct</em> way to implement non-trivial
callbacks is by accepting a <code>void *</code> user data pointer.</p><p>I would highly recommend checking out <a href=https://stackoverflow.com/questions/50874154/what-is-the-use-of-userdata-in-callback-register-function-in-c class=external-link target=_blank rel=noopener>this question on StackOverflow</a> for
more!</p></div><p>Because this function is pretty long, I&rsquo;m going to break it up into a couple
chunks.</p><p>First we have our temporary variables. This is a place to store our temporary
result and a pointer to the data attached to the <code>progress</code> closure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>&lt;</span>P<span style=color:#f92672>&gt;</span>(_recipe: <span style=color:#a6e22e>Recipe</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span>, <span style=color:#66d9ef>mut</span> progress: <span style=color:#a6e22e>P</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Output, Error<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    P: FnMut(<span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Safety: Accepting a `Recipe` means we prove at compile time that setting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// these variables can&#39;t result in any data races.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>mut</span> <span style=color:#66d9ef>ON_PROGRESS_USER_DATA</span>: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> c_void <span style=color:#f92672>=</span> ptr::null_mut();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>mut</span> <span style=color:#66d9ef>TEMPORARY_RESULT</span>: Option<span style=color:#f92672>&lt;</span>Output<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> None;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next we&rsquo;ve got a definition for the actual <code>on_progress()</code> function we&rsquo;ll be
passing to <code>stateful_execute()</code>. This uses a trick where you instantiate the
generic <code>on_progress&lt;F>()</code> function with a particular type, turning it into a
non-generic function which is specialised for the closure type passed to
<code>execute()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>&lt;</span>P<span style=color:#f92672>&gt;</span>(_recipe: <span style=color:#a6e22e>Recipe</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span>, <span style=color:#66d9ef>mut</span> progress: <span style=color:#a6e22e>P</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Output, Error<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    P: FnMut(<span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>on_progress</span><span style=color:#f92672>&lt;</span>F<span style=color:#f92672>&gt;</span>(percent: <span style=color:#a6e22e>c_int</span>) -&gt; <span style=color:#a6e22e>c_int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>        F: FnMut(<span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Safety: This requires us to store a pointer to `progress` when
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// `execute()` is called and make sure the `F` type variable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// `on_progress()` is instantiated with is the same as `execute()`&#39;s `P`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> actual_progress_callback <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>ON_PROGRESS_USER_DATA</span> <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> F);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        actual_progress_callback(percent);
</span></span><span style=display:flex><span>        bindings::<span style=color:#66d9ef>RESULT_OK</span> <span style=color:#66d9ef>as</span> c_int
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If that explanation makes your head hurt a little, just hang in there, it should
get a bit clearer once we see how it gets used.</p><p>Next we define an <code>on_finished()</code> function to pass to <code>stateful_execute()</code>. This
keeps reading outputs until there are no more, and saves them to the
<code>TEMPORARY_RESULT</code> static variable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>&lt;</span>P<span style=color:#f92672>&gt;</span>(_recipe: <span style=color:#a6e22e>Recipe</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span>, <span style=color:#66d9ef>mut</span> progress: <span style=color:#a6e22e>P</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Output, Error<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    P: FnMut(<span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>on_finished</span>(_num_items: <span style=color:#a6e22e>c_int</span>) -&gt; <span style=color:#a6e22e>c_int</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> output <span style=color:#f92672>=</span> Output::default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> item <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> bindings::stateful_get_output_by_index(
</span></span><span style=display:flex><span>            output.items.len() <span style=color:#66d9ef>as</span> c_int,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> item,
</span></span><span style=display:flex><span>        ) <span style=color:#f92672>==</span> bindings::<span style=color:#66d9ef>RESULT_OK</span> <span style=color:#66d9ef>as</span> c_int
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            output.items.push(item);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Safety: Accepting a `Recipe` means this can only be set by one thread
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// at a time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>TEMPORARY_RESULT</span> <span style=color:#f92672>=</span> Some(output);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bindings::<span style=color:#66d9ef>RESULT_OK</span> <span style=color:#66d9ef>as</span> c_int
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally we can actually call <code>stateful_execute()</code> and process the results.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>&lt;</span>P<span style=color:#f92672>&gt;</span>(_recipe: <span style=color:#a6e22e>Recipe</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span>, <span style=color:#66d9ef>mut</span> progress: <span style=color:#a6e22e>P</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Output, Error<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    P: FnMut(<span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ON_PROGRESS_USER_DATA</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> progress <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> P <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> c_void;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> ret <span style=color:#f92672>=</span> bindings::stateful_execute(
</span></span><span style=display:flex><span>            Some(on_progress::<span style=color:#f92672>&lt;</span>P<span style=color:#f92672>&gt;</span>),
</span></span><span style=display:flex><span>            Some(on_finished),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        .into_result();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We need to take the temporary result before handling
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// stateful_execute()&#39;s return code so we don&#39;t leak an `Output`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> output <span style=color:#f92672>=</span> <span style=color:#66d9ef>TEMPORARY_RESULT</span>.take();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// just bail if something went wrong
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> Err(e) <span style=color:#f92672>=</span> ret {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Err(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We need to make sure we actually set the temporary result. The only
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// way this could possibly happen is if `stateful_execute()` ran to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// completion and said it finished successfully without actually
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// invoking our `on_finished` callback... If so, that&#39;s a programming
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// error in the underlying library and nothing the caller can reasonably
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// be expected to handle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> output {
</span></span><span style=display:flex><span>            Some(output) <span style=color:#f92672>=&gt;</span> Ok(output),
</span></span><span style=display:flex><span>            None <span style=color:#f92672>=&gt;</span> panic!(<span style=color:#e6db74>&#34;The stateful_execute function said it returned
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            successfully without calling our on_finished callback. This is a
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            bug.&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m not going to explain this in much detail because it should hopefully be
fairly readable and well commented. Plus, reading the source code is always a
more accurate explanation of what is going on than several paragraphs of
English.</p><p>The most important thing to note is the liberal sprinkling of comments
starting with <code>// Safety</code>. These are hints to other developers (or myself 6
months from now) about the various invariants which need to be upheld, and the
reason I believe this <code>unsafe</code> code is sound.</p><div class="notices note"><p>This <code>execute()</code> function contains about 80 lines of <code>unsafe</code> code. If you
see something that looks a bit funny, please let me know either in the
<a href=https://github.com/Michael-F-Bryan/stateful-native-library class=external-link target=_blank rel=noopener><code>stateful-native-library</code> repository</a> or <a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com class=external-link target=_blank rel=noopener>this blog&rsquo;s issue
tracker</a>.</p><p>Writing correct code is very important to me, especially when it is being
read or used by others!</p></div><h2 id=making-sure-it-works>Making Sure It Works
<a class=heading-link href=#making-sure-it-works><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now we&rsquo;ve gone to all the effort of binding to our <code>stateful</code> native library,
let&rsquo;s write a small program which uses it.</p><p>To that end, I&rsquo;ve created the following contrived example,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// examples/basic-usage.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#e6db74>//! A contrived example showing how you can use the `stateful_native_library`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>//! bindings.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> stateful_native_library::{Error, Library};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>(), Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> library <span style=color:#f92672>=</span> Library::new()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// set some parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    library
</span></span><span style=display:flex><span>        .set_parameters()
</span></span><span style=display:flex><span>        .boolean(<span style=color:#e6db74>&#34;foo&#34;</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>        .integer(<span style=color:#e6db74>&#34;some-number&#34;</span>, <span style=color:#ae81ff>42</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start building the recipe
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> recipe_builder <span style=color:#f92672>=</span> library.create_recipe();
</span></span><span style=display:flex><span>    recipe_builder.add_item(<span style=color:#e6db74>&#34;first&#34;</span>, <span style=color:#ae81ff>1</span>).add_item(<span style=color:#e6db74>&#34;second&#34;</span>, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// we can add several groups using a loop
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>..</span><span style=color:#ae81ff>5</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;group_</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, i);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> group_builder <span style=color:#f92672>=</span> recipe_builder.add_group(<span style=color:#f92672>&amp;</span>name);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> j <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>i {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;group_</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>_item_</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, i, j);
</span></span><span style=display:flex><span>            group_builder.add_item(<span style=color:#f92672>&amp;</span>name, i <span style=color:#f92672>+</span> j);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        group_builder.finish();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// or use normal builder methods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    recipe_builder
</span></span><span style=display:flex><span>        .add_group(<span style=color:#e6db74>&#34;another group&#34;</span>)
</span></span><span style=display:flex><span>        .add_item(<span style=color:#e6db74>&#34;another nested item&#34;</span>, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>        .add_item(<span style=color:#e6db74>&#34;MOAR items&#34;</span>, <span style=color:#ae81ff>6</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// finish building the recipe
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> recipe <span style=color:#f92672>=</span> recipe_builder.build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// then get the outcome, periodically printing out progress messages
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> outcome <span style=color:#f92672>=</span> stateful_native_library::execute(recipe, <span style=color:#f92672>|</span>percent<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>%&#34;</span>, percent)
</span></span><span style=display:flex><span>    })<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Got </span><span style=color:#e6db74>{:?}</span><span style=color:#e6db74>&#34;</span>, outcome);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And this is what you get when you run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cargo run --example basic-usage
</span></span><span style=display:flex><span>   Compiling stateful-native-library v0.1.0 (/home/michael/Documents/stateful-native-library)
</span></span><span style=display:flex><span>    Finished dev [unoptimized + debuginfo] target(s) in 4.72s
</span></span><span style=display:flex><span>     Running `target/debug/examples/basic-usage`
</span></span><span style=display:flex><span>0%
</span></span><span style=display:flex><span>12%
</span></span><span style=display:flex><span>25%
</span></span><span style=display:flex><span>37%
</span></span><span style=display:flex><span>50%
</span></span><span style=display:flex><span>62%
</span></span><span style=display:flex><span>75%
</span></span><span style=display:flex><span>87%
</span></span><span style=display:flex><span>100%
</span></span><span style=display:flex><span>Got Output { items: [6, 4, 7, 5, 5, 3, 4, 2, 6, 5, 1, 1, 3, 2] }
</span></span></code></pre></div><p>Running the <code>basic-usage</code> example compiled with optimisations (which I would
expect to be more likely to show UB) under <code>valgrind</code> seems to show no obvious
problems.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ valgrind target/release/examples/basic-usage
</span></span><span style=display:flex><span>==9668== Memcheck, a memory error detector
</span></span><span style=display:flex><span>==9668== Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
</span></span><span style=display:flex><span>==9668== Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info
</span></span><span style=display:flex><span>==9668== Command: target/release/examples/basic-usage
</span></span><span style=display:flex><span>==9668==
</span></span><span style=display:flex><span>0%
</span></span><span style=display:flex><span>12%
</span></span><span style=display:flex><span>25%
</span></span><span style=display:flex><span>37%
</span></span><span style=display:flex><span>50%
</span></span><span style=display:flex><span>62%
</span></span><span style=display:flex><span>75%
</span></span><span style=display:flex><span>87%
</span></span><span style=display:flex><span>100%
</span></span><span style=display:flex><span>Got Output { items: [6, 4, 7, 5, 5, 3, 4, 2, 6, 5, 1, 1, 3, 2] }
</span></span><span style=display:flex><span>==9668==
</span></span><span style=display:flex><span>==9668== HEAP SUMMARY:
</span></span><span style=display:flex><span>==9668==     in use at exit: 0 bytes in 0 blocks
</span></span><span style=display:flex><span>==9668==   total heap usage: 160 allocs, 160 frees, 81,197 bytes allocated
</span></span><span style=display:flex><span>==9668==
</span></span><span style=display:flex><span>==9668== All heap blocks were freed -- no leaks are possible
</span></span><span style=display:flex><span>==9668==
</span></span><span style=display:flex><span>==9668== For lists of detected and suppressed errors, rerun with: -s
</span></span><span style=display:flex><span>==9668== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</span></span></code></pre></div><h2 id=conclusions>Conclusions
<a class=heading-link href=#conclusions><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In an ideal world all code would be perfect and we&rsquo;d never need to worry about
data races or accidentally putting a system in an invalid state.</p><p>Unfortunately, this <em>isn&rsquo;t</em> an ideal world so we need to develop techniques
that allow us to keep working under less than ideal conditions while limiting
the negative effects they can have on the rest of a codebase.</p><p>As it turns out, Rust&rsquo;s type system and its concept of lifetimes are really
powerful tools for taking errors that other languages could only detect at
runtime and promoting them to compilation failures. That&rsquo;s one of the things
I really like about the language, more often than not <em>if it compiles, it
works</em>.</p></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2025
Michael-F-Bryan
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com/tree/dbb621a9a787b276f42c0f30165783a6aa3065a6 target=_blank rel=noopener>dbb621a</a>]</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=/js/mermaid.min.min.9c343a21d2c1c6ad2ffc2661e9409225290bf15165a7661b9149c9a03934034c.js integrity="sha256-nDQ6IdLBxq0v/CZh6UCSJSkL8VFlp2YbkUnJoDk0A0w="></script><script src=/js/index.min.c04ed42ce6cde47e0926ae55f072b1ff2e67af9e681a00d0ffe507800d3fd657.js integrity="sha256-wE7ULObN5H4JJq5V8HKx/y5nr55oGgDQ/+UHgA0/1lc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-M80ZBKQHKV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-M80ZBKQHKV")}</script></body></html>