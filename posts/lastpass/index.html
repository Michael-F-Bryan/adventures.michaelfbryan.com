<!doctype html><html lang=en><head><title>How I Reverse Engineered the LastPass CLI Tool ¬∑ Michael-F-Bryan
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Michael-F-Bryan"><meta name=description content="A couple days ago I was writing an install script for my dotfiles
and reached a point where I wanted to grab some secrets (my SSH keys) from my
LastPass vault and copy them to the file system.
This is easy enough to do using the browser plugin, or even when working with
their command line tool (lpass) in an interactive way, but
I found there was no way to ask lpass which files are attached to a secret,
and get the output in a machine readable format."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="How I Reverse Engineered the LastPass CLI Tool"><meta name=twitter:description content="A couple days ago I was writing an install script for my dotfiles and reached a point where I wanted to grab some secrets (my SSH keys) from my LastPass vault and copy them to the file system.
This is easy enough to do using the browser plugin, or even when working with their command line tool (lpass) in an interactive way, but I found there was no way to ask lpass which files are attached to a secret, and get the output in a machine readable format."><meta property="og:url" content="https://adventures.michaelfbryan.com/posts/lastpass/"><meta property="og:site_name" content="Michael-F-Bryan"><meta property="og:title" content="How I Reverse Engineered the LastPass CLI Tool"><meta property="og:description" content="A couple days ago I was writing an install script for my dotfiles and reached a point where I wanted to grab some secrets (my SSH keys) from my LastPass vault and copy them to the file system.
This is easy enough to do using the browser plugin, or even when working with their command line tool (lpass) in an interactive way, but I found there was no way to ask lpass which files are attached to a secret, and get the output in a machine readable format."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-14T22:40:00+08:00"><meta property="article:modified_time" content="2025-04-01T09:19:10+08:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="I Made a Thing"><link rel=canonical href=https://adventures.michaelfbryan.com/posts/lastpass/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm+MTzNJdv80k+n0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/master.min.34be5ef36a820320661b4a8578382aba472d1a01092908eb30f0db81ec4031d4.css integrity="sha256-NL5e82qCAyBmG0qFeDgqukctGgEJKQjrMPDbgexAMdQ=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://adventures.michaelfbryan.com/>Michael-F-Bryan
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://adventures.michaelfbryan.com/posts/lastpass/>How I Reverse Engineered the LastPass CLI Tool</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2020-04-14T22:40:00+08:00>April 14, 2020
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
42-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/rust/>Rust</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/tags/i-made-a-thing/>I Made a Thing</a></span></div></div></header><div class=post-content><p>A couple days ago I was writing an install script for <a href=https://github.com/Michael-F-Bryan/dotfiles class=external-link target=_blank rel=noopener>my dotfiles</a>
and reached a point where I wanted to grab some secrets (my SSH keys) from my
LastPass vault and copy them to the file system.</p><p>This is easy enough to do using the browser plugin, or even when working with
their <a href=https://github.com/lastpass/lastpass-cli class=external-link target=_blank rel=noopener>command line tool (<code>lpass</code>)</a> in an interactive way, but
I found there was no way to ask <code>lpass</code> which files are attached to a secret,
and get the output in a machine readable format.</p><p>Like most self-respecting members of the open-source community, I <a href=https://github.com/lastpass/lastpass-cli/issues/547 class=external-link target=_blank rel=noopener>filed an
issue</a> on their GitHub page and in the meantime I started digging
into the source code to find where changes might need to be made. That way I
can make the change myself if it&rsquo;s easy enough, or I&rsquo;ll be able to provide
someone else with a bit more information.</p><p>However, reading through the source code got me thinking. There currently
aren&rsquo;t any libraries for working with LastPass, and although the <code>lpass</code> tool
is GPL&rsquo;d and the source code is freely accessible on GitHub, by reading the
source code you can quickly tell it was only ever intended as a command-line
tool.</p><p>Soo&mldr;.. Why not rewrite it in Rust?</p><div class="notices note"><p>The code written in this article is available <a href=https://github.com/Michael-F-Bryan/lastpass class=external-link target=_blank rel=noopener>on GitHub</a> and
<a href=https://crates.io/crates/lastpass class=external-link target=_blank rel=noopener>published on crates.io</a>. Feel free to browse through and steal code
or inspiration.</p><p>If you found this useful or spotted a bug, let me know on the blog&rsquo;s
<a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com class=external-link target=_blank rel=noopener>issue tracker</a>!</p></div><h2 id=a-quick-note-on-goals>A Quick Note On Goals
<a class=heading-link href=#a-quick-note-on-goals><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In the long run, I&rsquo;d like for this to be a fully-featured library for working
with a LastPass vault. Although, in the short term I&rsquo;m going to make a beeline
for downloading and decrypting attachments, seeing as that was the original
inspiration for this endeavour.</p><p>Someone may want to create a nice command-line tool on top of the library, but
I don&rsquo;t have any intention of being that someone (for now, anyways).</p><p>I&rsquo;ve also got a lot of experience writing FFI code, so I&rsquo;d like to write
bindings so the library is usable from Python (my dotfiles install script is
written in Python) and C. I might wait a bit to flesh out the crate&rsquo;s API
though, that way I&rsquo;ll have a better idea of how the bindings should be
consumed and it&rsquo;ll reduce unnecessary code churn.</p><p>The <code>lpass</code> tool has roughly three responsibilities,</p><ol><li>Communicate with the LastPass HTTP API</li><li>Perform the appropriate crypto so we can encrypt/decrypt the LastPass vault</li><li>Use the file system and a daemon to allow caching of the vault and persist
login sessions across multiple invocations of the <code>lpass</code> command (e.g. so
you don&rsquo;t need to keep entering your master password every time)</li></ol><p>As a library, the third point is usually left up to the frontend application
so we&rsquo;ve already made our job 33% easier.</p><p>I&rsquo;d also consider the HTTP bit a solved problem. The <a href=https://crates.io/crates/reqwest class=external-link target=_blank rel=noopener><code>reqwest</code></a>
crate provides a robust and fully-featured asynchronous HTTP client, and we
can leverage <a href=https://serde.rs/ class=external-link target=_blank rel=noopener><code>serde</code></a>&rsquo;s serialization superpowers to make sending or
receiving structured data a breeze.</p><p>I&rsquo;m a little worried about the crypto side of things. On one hand, we don&rsquo;t
need to implement any cryptography routines ourselves (the <a href=https://crates.io/crates/aes class=external-link target=_blank rel=noopener><code>aes</code></a> and
<a href=https://crates.io/crates/pbkdf2 class=external-link target=_blank rel=noopener><code>pbkdf2</code></a> crates already exist and are well-respected), but it&rsquo;s
easy to mess things up an accidentally introduce a security vulnerability.</p><p>I figure the best course of action here is to just copy what <code>lpass</code> do.</p><div class="notices warning"><p>If you&rsquo;ve read this far hopefully you&rsquo;ve realised this isn&rsquo;t one of those
<em>&ldquo;LastPass is broken!&rdquo;</em> posts. I&rsquo;m just reverse-engineering how the <code>lpass</code>
program works so I can implement it myself and publish it as a library.</p><p>If anything, after spending several hours banging my head against a wall and
trying to figure out why things weren&rsquo;t working, I can assure you that the
LastPass does a pretty good job at keeping people out.</p><p>I&rsquo;ve also deliberately only consulted freely accessible information, namely
the <code>lastpass-cli</code> project&rsquo;s source code, so this should also be fine from a
copyright standpoint. The resulting <a href=https://crates.io/crates/lastpass class=external-link target=_blank rel=noopener><code>lastpass</code></a> crate has also been
published under the GPL because it&rsquo;s considered a derived work.</p></div><h2 id=baby-steps>Baby Steps
<a class=heading-link href=#baby-steps><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>After creating the repository, the first thing to do is get a copy of the
<code>lastpass/lastpas-cli</code> project so we can refer to the source code when needed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ git submodule init
</span></span><span style=display:flex><span>$ git submodule add git@github.com:lastpass/lastpass-cli.git vendor/lastpass-cli
</span></span><span style=display:flex><span>Cloning into &#39;/home/michael/Documents/lastpass/vendor/lastpass-cli&#39;...
</span></span><span style=display:flex><span>remote: Enumerating objects: 2388, done.
</span></span><span style=display:flex><span>remote: Total 2388 (delta 0), reused 0 (delta 0), pack-reused 2388
</span></span><span style=display:flex><span>Receiving objects: 100% (2388/2388), 821.19 KiB | 463.00 KiB/s, done.
</span></span><span style=display:flex><span>Resolving deltas: 100% (1565/1565), done.
</span></span></code></pre></div><p>There are a couple strategies you can use when trying to reverse engineer an
existing application. The <em>Bottom-Up</em> strategy involves finding the snippet
of code you care about (e.g. sending a HTTP request to the login endpoint)
and tracing backwards to see how you construct the right inputs. On the other
hand, the <em>Top-Down</em> approach starts at <code>main()</code> and steps through the program
until you hit the juicy parts, similar to how a debugger works.</p><p>My first aim will be to log in and get any necessary session tokens. I know the
LastPass API endpoint for logging in will almost certainly be a string starting
with <code>login</code>, so we can start from there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ rg <span style=color:#e6db74>&#39;&#34;login&#39;</span> vendor/lastpass-cli
</span></span><span style=display:flex><span>vendor/lastpass-cli/endpoints.c
</span></span><span style=display:flex><span>236:	reply = http_post_lastpass(&#34;login_check.php&#34;, session, NULL, &#34;method&#34;, &#34;cli&#34;, NULL);
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>vendor/lastpass-cli/endpoints-login.c
</span></span><span style=display:flex><span>170:	*reply = http_post_lastpass_v(login_server, &#34;login.php&#34;, NULL, NULL, args);
</span></span><span style=display:flex><span>228:	        *reply = http_post_lastpass_v(login_server, &#34;login.php&#34;, NULL, NULL, args);
</span></span><span style=display:flex><span>296:	        *reply = http_post_lastpass_v(login_server, &#34;login.php&#34;, NULL, NULL, args);
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>vendor/lastpass-cli/contrib/lpass_zsh_completion
</span></span><span style=display:flex><span>116:          &#34;login:Authenticate with the LastPass server and initialize a local cache&#34;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>vendor/lastpass-cli/cmd.h
</span></span><span style=display:flex><span>75:#define cmd_login_usage &#34;login [--trust] [--plaintext-key [--force, -f]] &#34; color_usage &#34; USERNAME&#34;
</span></span></code></pre></div><p>I&rsquo;m guessing the file we&rsquo;re looking for is the aptly-named <code>endpoints-login.c</code>.
Opening the file up and jumping to the appropriate lines show there are three
login functions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/endpoints-login.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>ordinary_login</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>login_server, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN], <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>args, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>cause, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>message, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>reply, <span style=color:#66d9ef>struct</span> session <span style=color:#f92672>**</span>session,
</span></span><span style=display:flex><span>			   <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>ret_login_server)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>server;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>free</span>(<span style=color:#f92672>*</span>reply);
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>reply <span style=color:#f92672>=</span> <span style=color:#a6e22e>http_post_lastpass_v</span>(login_server, <span style=color:#e6db74>&#34;login.php&#34;</span>, NULL, NULL, args);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!*</span>reply)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>error_post</span>(message, session);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>session <span style=color:#f92672>=</span> <span style=color:#a6e22e>xml_ok_session</span>(<span style=color:#f92672>*</span>reply, key);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>session) {
</span></span><span style=display:flex><span>		(<span style=color:#f92672>*</span>session)<span style=color:#f92672>-&gt;</span>server <span style=color:#f92672>=</span> <span style=color:#a6e22e>xstrdup</span>(login_server);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>cause <span style=color:#f92672>=</span> <span style=color:#a6e22e>xml_error_cause</span>(<span style=color:#f92672>*</span>reply, <span style=color:#e6db74>&#34;cause&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!*</span>cause)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>error_other</span>(message, session, <span style=color:#e6db74>&#34;Unable to determine login failure cause.&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>ret_login_server <span style=color:#f92672>=</span> <span style=color:#a6e22e>xstrdup</span>(login_server);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>oob_login</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>login_server, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN], <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>args, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>message, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>reply, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>oob_name, <span style=color:#66d9ef>struct</span> session <span style=color:#f92672>**</span>session)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>terminal_fprintf</span>(stderr, TERMINAL_FG_YELLOW TERMINAL_BOLD <span style=color:#e6db74>&#34;Waiting for approval of out-of-band %s login%s&#34;</span> TERMINAL_NO_BOLD <span style=color:#e6db74>&#34;...&#34;</span>, <span style=color:#f92672>*</span>oob_name, can_do_passcode <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;, or press Ctrl+C to enter a passcode&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;outofbandrequest&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>free</span>(<span style=color:#f92672>*</span>reply);
</span></span><span style=display:flex><span>		<span style=color:#f92672>*</span>reply <span style=color:#f92672>=</span> <span style=color:#a6e22e>http_post_lastpass_v</span>(login_server, <span style=color:#e6db74>&#34;login.php&#34;</span>, NULL, NULL, args);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!*</span>reply) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (can_do_passcode) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;outofbandrequest&#34;</span>, <span style=color:#e6db74>&#34;0&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;outofbandretry&#34;</span>, <span style=color:#e6db74>&#34;0&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;outofbandretryid&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>xstrappend</span>(oob_name, <span style=color:#e6db74>&#34; OTP&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>goto</span> failure;
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>error_post</span>(message, session);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>goto</span> success;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>otp_login</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>login_server, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN], <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>args, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>message, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>reply, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>otp_name, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>cause, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>username, <span style=color:#66d9ef>struct</span> session <span style=color:#f92672>**</span>session)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>		multifactor <span style=color:#f92672>=</span> <span style=color:#a6e22e>password_prompt</span>(<span style=color:#e6db74>&#34;Code&#34;</span>, multifactor_error, <span style=color:#e6db74>&#34;Please enter your %s for &lt;%s&gt;.&#34;</span>, otp_name <span style=color:#f92672>?</span> otp_name : replied_multifactor<span style=color:#f92672>-&gt;</span>name, username);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>multifactor)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>error_other</span>(message, session, <span style=color:#e6db74>&#34;Aborted multifactor authentication.&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>append_post</span>(args, replied_multifactor<span style=color:#f92672>-&gt;</span>post_var, multifactor);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>free</span>(<span style=color:#f92672>*</span>reply);
</span></span><span style=display:flex><span>		<span style=color:#f92672>*</span>reply <span style=color:#f92672>=</span> <span style=color:#a6e22e>http_post_lastpass_v</span>(login_server, <span style=color:#e6db74>&#34;login.php&#34;</span>, NULL, NULL, args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So it looks like there are 3 methods for doing login&mldr; I&rsquo;m guessing the
<code>ordinary_login()</code> is for a standard username/password login and <code>oob_login()</code>
and <code>otp_login()</code> are for multi-factor authentication where you&rsquo;ve got an
out-of-band authentication device (e.g. a USB dongle) or are using an app that
uses one-time-pads (e.g. the Google Authenticator app).</p><p>I don&rsquo;t care about multi-factor authentication for now, so let&rsquo;s have a skim
through <code>ordinary_login()</code> and try to identify the important bits.</p><p>I&rsquo;m not 100% sure what the <code>_v</code> suffix in <code>http_post_lastpass_v()</code> means, but
it seems to be a function that sends a HTTP POST request to <code>lastpass.com</code>.
The two <code>NULL</code> parameters are a pointer to a session (presumably for auth,
but we haven&rsquo;t logged in yet so we don&rsquo;t have one) and a place to put the
<code>reply</code> string&rsquo;s length (which we don&rsquo;t care about because it&rsquo;s a
null-terminated string).</p><p>From there, it looks like the response body is parsed as XML into a <code>session</code>
using <code>xml_ok_session()</code>. Interestingly, we need to pass in a <code>key</code>, so
presumably parts of the response will be encrypted with our master password.
If parsing was successful, the parsed session is &ldquo;returned&rdquo; to the caller via
the <code>session</code> pointer and we leave the function. The rest of the function
seems to be around identifying the cause for a login failure, so we can
ignore it for the time being.</p><p>Looking up the stack to the function that calls <code>ordinary_login()</code>, we reach
<code>lastpass_login()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/endpoints-login.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> session <span style=color:#f92672>*</span><span style=color:#a6e22e>lastpass_login</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>username, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> hash[KDF_HEX_LEN], <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN], <span style=color:#66d9ef>int</span> iterations, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>error_message, <span style=color:#66d9ef>bool</span> trust)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>args[<span style=color:#ae81ff>33</span>];
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(args, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(args));
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;xml&#34;</span>, <span style=color:#e6db74>&#34;2&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;username&#34;</span>, user_lower);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;hash&#34;</span>, hash);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;iterations&#34;</span>, iters);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;includeprivatekeyenc&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;method&#34;</span>, <span style=color:#e6db74>&#34;cli&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;outofbandsupported&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (trusted_id)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>append_post</span>(args, <span style=color:#e6db74>&#34;uuid&#34;</span>, trusted_id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ordinary_login</span>(LASTPASS_SERVER, key, args, <span style=color:#f92672>&amp;</span>cause, error_message, <span style=color:#f92672>&amp;</span>reply, <span style=color:#f92672>&amp;</span>session, <span style=color:#f92672>&amp;</span>login_server))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> session;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It looks like this is responsible for constructing the POST data and sending
a request to <code>ordinary_login()</code>. I&rsquo;ve elided the bits afterwards because they
just fall back to the out-of-band and one-time-pad logins.</p><p>If you squint at <code>append_post()</code> calls in the previous snippet, you&rsquo;ll see
that we&rsquo;re constructing the key-value pairs to submit a HTML form.</p><p>At this point we actually know enough to start sending login requests to the
LastPass API!</p><p>I&rsquo;m going to use the HTTP client from the <a href=https://crates.io/crates/reqwest class=external-link target=_blank rel=noopener><code>reqwest</code></a> crate for this.
As well as having nice things like connection pooling, <code>async</code>, TLS,
and automatic cookie storage, there&rsquo;s this awesome feature where you can use
anything implementing <code>serde::Serialize</code> as the form data.</p><p>First, we&rsquo;ll create a struct with all the data to be submitted in the form.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/login.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> serde_derive::Serialize;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Data</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    xml: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    username: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    hash: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    iterations: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    includeprivatekeyenc: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    method: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    outofbandsupported: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    uuid: Option<span style=color:#f92672>&lt;&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices note"><p>Don&rsquo;t worry too much about those lifetime annotations (the <code>'a</code> in <code>&'a str</code>). I don&rsquo;t feel like making a bunch of temporary strings just to create
the form data, so we&rsquo;ll use references to existing strings (e.g. a dynamic
string that was passed in by the caller, or a string literal compiled into
the binary).</p></div><p>Then we can write a function to send this data to the <code>login.php</code> endpoint.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/login.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>login</span>(
</span></span><span style=display:flex><span>    client: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Client</span>,
</span></span><span style=display:flex><span>    hostname: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    login_key: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    iterations: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span>Session, LoginError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> Data {
</span></span><span style=display:flex><span>        xml: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        username,
</span></span><span style=display:flex><span>        hash: <span style=color:#a6e22e>login_key</span>,
</span></span><span style=display:flex><span>        iterations,
</span></span><span style=display:flex><span>        includeprivatekeyenc: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        method: <span style=color:#e6db74>&#34;cli&#34;</span>,
</span></span><span style=display:flex><span>        outofbandsupported: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        trusted_id,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> url <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>/login.php&#34;</span>, hostname);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> response <span style=color:#f92672>=</span> client
</span></span><span style=display:flex><span>        .post(<span style=color:#f92672>&amp;</span>url)
</span></span><span style=display:flex><span>        .form(<span style=color:#f92672>&amp;</span>data)
</span></span><span style=display:flex><span>        .send()
</span></span><span style=display:flex><span>        .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>        .error_for_status()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> body <span style=color:#f92672>=</span> response.text().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    unimplemented!(<span style=color:#e6db74>&#34;How do we parse the body into a session? </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, body);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Throughout this I&rsquo;ll be assuming you&rsquo;re either moderately familiar with Rust,
or have played with enough programming languages that you&rsquo;ll understand common
concepts like method chaining and <code>async-await</code>.</p><div class="notices note"><p>As a side note, I think the decision to make <code>await</code> a postfix operator works
really well with Rust&rsquo;s expression-centric syntax and <code>?</code> operator.</p><p>Having used async-await in C# and Python, I was initially quite skeptical of
writing <code>some_expr.await</code> instead of <code>await some_expr</code>, but after having used
it in the real world I think this syntax reduces visual noise and the
unnecessary parentheses or temporary variables you&rsquo;d normally get when
working with the returned value.</p><p>The interaction with the <code>?</code> operator also just <em>&ldquo;rolls off the tongue&rdquo;</em>
(e.g. <code>let foo = some_expr.await?</code> instead of <code>let foo = (await some_expr)?</code>).</p><p>Nice work, language designers üëç</p></div><p>I&rsquo;ve also taken the liberty of stubbing out a <code>Session</code> type based on the
<code>session</code> struct in <code>session.h</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/session.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Session</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> uid: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> token: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> private_key: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> session_id: String,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/session.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>session</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>uid;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>sessionid;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>token;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>server;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>private_key</span> private_key;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>I also hacked together <a href=https://github.com/Michael-F-Bryan/lastpass/blob/0a5da0262548d475e81138f91a22fa125658ea3e/src/bin/main.rs class=external-link target=_blank rel=noopener>a quick program</a> to send requests to
LastPass and dump the login response.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/bin/main.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> anyhow::Error;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> reqwest::Client;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> lastpass::endpoints;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>(), Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    env_logger::init();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> client <span style=color:#f92672>=</span> Client::builder()
</span></span><span style=display:flex><span>        .user_agent(lastpass::<span style=color:#66d9ef>DEFAULT_USER_AGENT</span>)
</span></span><span style=display:flex><span>        .cookie_store(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>        .build()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> session <span style=color:#f92672>=</span> endpoints::login(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>client,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;lastpass.com&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;my-test-account@example.com&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;SUPER_SECRET_LOGIN_KEY_I_GOT_FROM_LPASS&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>100100</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Logged in as my-test-account@example.com </span><span style=color:#e6db74>{:#?}</span><span style=color:#e6db74>&#34;</span>, session);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices tip"><p>I don&rsquo;t want to worry about deriving a login key or that <code>iterations</code>
variable for now, so I recompiled <code>lastpass-cli</code> with debug symbols and ran
<code>lpass login my-test-account@example.com</code> under the VS Code debugger to get
the right values.</p><p>When you&rsquo;re hacking together a proof-of-concept like this it&rsquo;s okay to use
hard-coded variables. Once we know that we can talk to the LastPass API we
can take a step back, start looking for patterns, and derive nice
abstractions.</p></div><p>Assuming we used the correct <code>login_key</code>, the <code>login.php</code> endpoint sends us
back a big blob of XML.</p><details><summary>A big blob of XML</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;response&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;ok</span> <span style=color:#a6e22e>sitesver=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>formfillver=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>bigicon=</span><span style=color:#e6db74>&#34;5617&#34;</span> <span style=color:#a6e22e>bigiconenabled=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>uid=</span><span style=color:#e6db74>&#34;999999999&#34;</span> <span style=color:#a6e22e>language=</span><span style=color:#e6db74>&#34;en-US&#34;</span> <span style=color:#a6e22e>sessionid=</span><span style=color:#e6db74>&#34;SESSIONID1234&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>disableoffline=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>pushserver=</span><span style=color:#e6db74>&#34;https://lp-push-server-455.lastpass.com/ws/1111111111111111111111111111111111111 main&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>new_save_site=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>first_time_login=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>infield_enabled=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>mobile_active=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>ziggy=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>better_generate_password_enabled=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>omar_ia=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>retire_3_0=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>family_shared_folders_enabled=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>family_legacy_shared_folders_enabled=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>try_families_enabled=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>premium_sharing_restricted=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>emergency_access_restricted=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>is_families_trial_started=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>predates_families=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>seen_vault_post_families=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>privatekeyenc=</span><span style=color:#e6db74>&#34;DEADBEEF&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>migrated=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>autofill_https_test=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>nopassword_integration_enabled=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>save_a_site_otp=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>site_feedback=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>omar_vault_migration=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>account_version_tracking=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>blob_version_set=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>yubikeyenabled=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>googleauthenabled=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>microsoftauthenabled=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>outofbandenabled=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>serverts=</span><span style=color:#e6db74>&#34;1586587085100000&#34;</span> <span style=color:#a6e22e>iconsversion=</span><span style=color:#e6db74>&#34;85&#34;</span> <span style=color:#a6e22e>isadmin=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lpusername=</span><span style=color:#e6db74>&#34;my-test-account@example.com&#34;</span> <span style=color:#a6e22e>email=</span><span style=color:#e6db74>&#34;my-test-account@example.com&#34;</span> <span style=color:#a6e22e>loglogins=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>client_enc=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>accts_version=</span><span style=color:#e6db74>&#34;198&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>pwdeckey=</span><span style=color:#e6db74>&#34;PASSWORDDECODEKEY&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>hih=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>genh=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>addh=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>seclvl=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>updated_enc=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>login_site_prompt=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>edit_site_prompt=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>edit_sn_prompt=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>view_pw_prompt=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>view_ff_prompt=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>improve=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>switch_identity_prompt=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>switch_f_prompt=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>multifactor_reprompt=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>multifactor_singlefactor=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>singlefactortype=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>country=</span><span style=color:#e6db74>&#34;AU&#34;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>banner=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>ratings_prompt=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>reqdversion=</span><span style=color:#e6db74>&#34;1.39&#34;</span> <span style=color:#a6e22e>pollinterval=</span><span style=color:#e6db74>&#34;-1&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>logoff_other_ses=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>generatedpw=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>pageloadthres=</span><span style=color:#e6db74>&#34;800000&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>attachversion=</span><span style=color:#e6db74>&#34;3&#34;</span> <span style=color:#a6e22e>pwresetreqd=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>accountlinkrequired=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>trialduration=</span><span style=color:#e6db74>&#34;30&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>token=</span><span style=color:#e6db74>&#34;BASE64ENCODEDTOKEN=&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>companyadmin=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>iterations=</span><span style=color:#e6db74>&#34;123456&#34;</span> <span style=color:#a6e22e>showcredmon=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>adlogin=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>note_title=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>note_text=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>note_button=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>note_url=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastchallengets=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>extended_shared_folder_log=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>multifactorscore=</span><span style=color:#e6db74>&#34;9&#34;</span> <span style=color:#a6e22e>disablepwalerts=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>emailverified=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>prefdata=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>pbt=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>logloginsvr=</span><span style=color:#e6db74>&#34;loglogin.lastpass.com&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>pollserver=</span><span style=color:#e6db74>&#34;pollserver.lastpass.com&#34;</span> <span style=color:#a6e22e>do_totp=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>newsettings_enabled =</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>show_extension_popup =</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>is_legacy_premium=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/response&gt;</span>
</span></span></code></pre></div></details><p>Considering the <code>Session</code> struct only has a handful of fields, it&rsquo;s safe to
assume most of this is unnecessary information that&rsquo;s probably used by other
LastPass products (e.g. their browser extension).</p><p>To see how the relevant information is extracted, I&rsquo;m going to look at the
<code>xml_ok_session()</code> function (which tries to parse the happy case out of the XML)
and see if anything jumps out.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/xml.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;xml.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;util.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;blob.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;libxml/parser.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;libxml/tree.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> session <span style=color:#f92672>*</span><span style=color:#a6e22e>xml_ok_session</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>buf, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> session <span style=color:#f92672>*</span>session <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	xmlDoc <span style=color:#f92672>*</span>doc <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	xmlNode <span style=color:#f92672>*</span>root;
</span></span><span style=display:flex><span>	doc <span style=color:#f92672>=</span> <span style=color:#a6e22e>xmlReadMemory</span>(buf, <span style=color:#a6e22e>strlen</span>(buf), NULL, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>doc)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	root <span style=color:#f92672>=</span> <span style=color:#a6e22e>xmlDocGetRootElement</span>(doc);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (root <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>xmlStrcmp</span>(root<span style=color:#f92672>-&gt;</span>name, BAD_CAST <span style=color:#e6db74>&#34;response&#34;</span>)) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (root <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>children; root; root <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>next) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>xmlStrcmp</span>(root<span style=color:#f92672>-&gt;</span>name, BAD_CAST <span style=color:#e6db74>&#34;ok&#34;</span>))
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (root <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>xmlStrcmp</span>(root<span style=color:#f92672>-&gt;</span>name, BAD_CAST <span style=color:#e6db74>&#34;ok&#34;</span>)) {
</span></span><span style=display:flex><span>		session <span style=color:#f92672>=</span> <span style=color:#a6e22e>session_new</span>();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (xmlAttrPtr attr <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>properties; attr; attr <span style=color:#f92672>=</span> attr<span style=color:#f92672>-&gt;</span>next) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>xmlStrcmp</span>(attr<span style=color:#f92672>-&gt;</span>name, BAD_CAST <span style=color:#e6db74>&#34;uid&#34;</span>))
</span></span><span style=display:flex><span>				session<span style=color:#f92672>-&gt;</span>uid <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#a6e22e>xmlNodeListGetString</span>(doc, attr<span style=color:#f92672>-&gt;</span>children, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>xmlStrcmp</span>(attr<span style=color:#f92672>-&gt;</span>name, BAD_CAST <span style=color:#e6db74>&#34;sessionid&#34;</span>))
</span></span><span style=display:flex><span>				session<span style=color:#f92672>-&gt;</span>sessionid <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#a6e22e>xmlNodeListGetString</span>(doc, attr<span style=color:#f92672>-&gt;</span>children, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>xmlStrcmp</span>(attr<span style=color:#f92672>-&gt;</span>name, BAD_CAST <span style=color:#e6db74>&#34;token&#34;</span>))
</span></span><span style=display:flex><span>				session<span style=color:#f92672>-&gt;</span>token <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#a6e22e>xmlNodeListGetString</span>(doc, attr<span style=color:#f92672>-&gt;</span>children, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>xmlStrcmp</span>(attr<span style=color:#f92672>-&gt;</span>name, BAD_CAST <span style=color:#e6db74>&#34;privatekeyenc&#34;</span>)) {
</span></span><span style=display:flex><span>				_cleanup_free_ <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>private_key <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#a6e22e>xmlNodeListGetString</span>(doc, attr<span style=color:#f92672>-&gt;</span>children, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>session_set_private_key</span>(session, key, private_key);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>out:
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (doc)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>xmlFreeDoc</span>(doc);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>session_is_valid</span>(session)) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>session_free</span>(session);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> session;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Looking at just the string literals and function names, it seems like we&rsquo;re
expecting a root <code>&lt;ok></code> node. From there we skim through the <code>&lt;ok></code> node&rsquo;s
attributes and copy <code>"uid"</code>, <code>"sessionid"</code>, <code>"token"</code>, and <code>"privatekeyenc"</code>
to the relevant fields on <code>session</code>.</p><p>That seems easy enough.</p><p>I&rsquo;ll be using the <a href=https://crates.io/crates/serde_xml_rs class=external-link target=_blank rel=noopener><code>serde_xml_rs</code></a> crate to parse the response
document. This lets us declaratively define how an &ldquo;ok&rdquo; document should look,
then lean on <code>serde</code> and <code>serde_xml_rs</code> to do the heavy lifting.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/login.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Deserialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Document</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;$value&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    root: <span style=color:#a6e22e>Root</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Deserialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Root</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;ok&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    Ok {
</span></span><span style=display:flex><span>        uid: String,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>/// A base64-encoded token.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>        token: String,
</span></span><span style=display:flex><span>        <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;privatekeyenc&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>        private_key: String,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>/// The PHP session ID.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>        <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;sessionid&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>        session_id: String,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>/// The user&#39;s username.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>        <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;lpusername&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>        username: String,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>/// The user&#39;s primary email address
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>        email: String,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we&rsquo;ve got something that represents the document schema, we actually have
everything we need to parse it into a <code>Session</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/login.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>login</span>(
</span></span><span style=display:flex><span>    client: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Client</span>,
</span></span><span style=display:flex><span>    hostname: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    login_key: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    iterations: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span>Session, LoginError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> body <span style=color:#f92672>=</span> response.text().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> doc: <span style=color:#a6e22e>Document</span> <span style=color:#f92672>=</span> serde_xml_rs::from_str(<span style=color:#f92672>&amp;</span>body)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    interpret_response(doc.root)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>interpret_response</span>(root: <span style=color:#a6e22e>Root</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Session, LoginError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> root {
</span></span><span style=display:flex><span>        Root::Ok {
</span></span><span style=display:flex><span>            uid,
</span></span><span style=display:flex><span>            token,
</span></span><span style=display:flex><span>            private_key,
</span></span><span style=display:flex><span>            session_id,
</span></span><span style=display:flex><span>            username,
</span></span><span style=display:flex><span>            <span style=color:#f92672>..</span>
</span></span><span style=display:flex><span>        } <span style=color:#f92672>=&gt;</span> Ok(Session { uid, token, private_key, session_id }
</span></span><span style=display:flex><span>        <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Running the test program shows we&rsquo;ve got an actual session.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cargo run
</span></span><span style=display:flex><span>Logged in as my-test-account@example.com Session {
</span></span><span style=display:flex><span>    uid: &#34;123456789&#34;,
</span></span><span style=display:flex><span>    token: &#34;X3BYcEFjRDFZYlRoVG42r1kTj/UvbBGar2zRpDXgzQyIbQpCMkocUHSFS3AMt3duyU4=&#34;,
</span></span><span style=display:flex><span>    private_key: &#34;DEADBEEFCAFEBABE&#34;,
</span></span><span style=display:flex><span>    session_id: &#34;3d,UxdQVzFSznYkCXfYXabP2Bw8&#34;,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Success!</p><p>While it may seem like we&rsquo;ve written a lot of code our quick&rsquo;n&rsquo;dirty login
function, complete with error handling code (which I&rsquo;ve skipped for simplicity),
and a test program, only took about 100 lines of Rust.</p><p>The vast majority of time was actually spent reading through the
<code>lastpass-cli</code> project&rsquo;s source code and figuring out how all the components
interact. This was made a lot harder because C promotes a culture of
<a href=https://refactoring.guru/smells/primitive-obsession class=external-link target=_blank rel=noopener><em>Primitive Obsession</em></a>, so everything is a <code>char *</code>
(the login key is a <code>char *</code>, the response is a <code>char *</code>, errors are a <code>char *</code>,
the key-value pairs for our POST form is a <code>char **</code> array where even
items are keys and odd items are values, etc.). The lack of generics and RAII
also makes it hard to create nice layers of abstraction in a C program because
you are constantly interspersing business logic with memory management, or
you need to <a href=https://github.com/lastpass/lastpass-cli/blob/8767b5e53192ad4e72d1352db4aa9218e928cbe1/list.h class=external-link target=_blank rel=noopener>implement your own doubly-linked list</a>.</p><h2 id=creating-an-abstraction-for-key-management>Creating an Abstraction for Key Management
<a class=heading-link href=#creating-an-abstraction-for-key-management><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now that we&rsquo;re able to log in, let&rsquo;s start getting rid of those hard-coded
values.</p><h3 id=login-keys>Login Keys
<a class=heading-link href=#login-keys><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>The first thing I&rsquo;d like to do is create a <code>LoginKey</code>. After a little digging,
it looks like we use <code>kdf_login_key()</code> to derive the login key based on the
user&rsquo;s username and master password.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/kdf.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>kdf_login_key</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>username, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>password, <span style=color:#66d9ef>int</span> iterations, <span style=color:#66d9ef>char</span> hex[KDF_HEX_LEN])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> hash[KDF_HASH_LEN];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>size_t</span> password_len;
</span></span><span style=display:flex><span>	_cleanup_free_ <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>user_lower <span style=color:#f92672>=</span> <span style=color:#a6e22e>xstrlower</span>(username);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	password_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(password);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (iterations <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		iterations <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (iterations <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sha256_hash</span>(user_lower, <span style=color:#a6e22e>strlen</span>(user_lower), password, password_len, hash);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>bytes_to_hex</span>(hash, <span style=color:#f92672>&amp;</span>hex, KDF_HASH_LEN);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sha256_hash</span>(hex, KDF_HEX_LEN <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, password, password_len, hash);
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pbkdf2_hash</span>(user_lower, <span style=color:#a6e22e>strlen</span>(user_lower), password, password_len, iterations, hash);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pbkdf2_hash</span>(password, password_len, (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)hash, KDF_HASH_LEN, <span style=color:#ae81ff>1</span>, hash);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bytes_to_hex</span>(hash, <span style=color:#f92672>&amp;</span>hex, KDF_HASH_LEN);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mlock</span>(hex, KDF_HEX_LEN);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we can see that the <code>iterations</code> parameter is used by <a href=https://crates.io/crates/pbkdf2 class=external-link target=_blank rel=noopener>PBKDF2</a> to
increase the number of times the hash is applied, allowing the algorithm to
scale as hardware gets faster.</p><p>As a special case, when <code>iterations &lt;= 1</code> we do two passes through SHA-256.
This looks like a backwards compatibility thing, where the <code>LoginKey</code> used by
older servers or accounts was computed using SHA-256 and they later
transitioned to PBKDF2 for increased security.</p><p>Looking through the source code we can see that a login key is <code>KDF_HASH_LEN</code>
bytes long, or about 64 bytes + 1 for a null terminator.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// /usr/include/openssl/sha.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># define SHA256_DIGEST_LENGTH    32
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/kdf.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;openssl/sha.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define KDF_HASH_LEN SHA256_DIGEST_LENGTH
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define KDF_HEX_LEN (KDF_HASH_LEN * 2 + 1)
</span></span></span></code></pre></div><p>This tells us enough to define a <code>LoginKey</code>. For now it&rsquo;s just a newtype around
a <code>[u8; 64]</code> array, we don&rsquo;t need the null terminator because arrays in Rust
always know how long they are.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/login_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// A hex-encoded hash of the username and password.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>LoginKey</span>([<span style=color:#66d9ef>u8</span>; LoginKey::<span style=color:#66d9ef>LEN</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>KDF_HASH_LEN</span>: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> LoginKey {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>LEN</span>: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>KDF_HASH_LEN</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can create a <code>LoginKey</code> using the <code>LoginKey::calculate()</code> constructor. This
just defers to <code>LoginKey::sha256()</code> and <code>LoginKey::pbkdf2()</code> based on the number
of iterations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/login_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> LoginKey {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Calculate a new [`LoginKey`].
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>calculate</span>(
</span></span><span style=display:flex><span>        username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>        password: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>        iterations: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    ) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> username <span style=color:#f92672>=</span> username.to_lowercase();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> iterations <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>            LoginKey::sha256(<span style=color:#f92672>&amp;</span>username, password)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            LoginKey::pbkdf2(<span style=color:#f92672>&amp;</span>username, password, iterations)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sha256</span>(username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, password: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>Self</span> { unimplemented!() }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>pbkdf2</span>(username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, password: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, iterations: <span style=color:#66d9ef>usize</span>) -&gt; <span style=color:#a6e22e>Self</span> { unimplemented!() }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;ll start with the <code>LoginKey::sha256()</code> constructor because that seems easiest,
so let&rsquo;s have a look at the <code>sha256_hash()</code> function used by <code>lastpass-cli</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/kdf.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> void sha256_hash(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>username, size_t username_len, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>password, size_t password_len, unsigned <span style=color:#66d9ef>char</span> hash[<span style=color:#66d9ef>KDF_HASH_LEN</span>])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SHA256_CTX</span> sha256;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>SHA256_Init(<span style=color:#f92672>&amp;</span>sha256))
</span></span><span style=display:flex><span>		goto die;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>SHA256_Update(<span style=color:#f92672>&amp;</span>sha256, username, username_len))
</span></span><span style=display:flex><span>		goto die;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>SHA256_Update(<span style=color:#f92672>&amp;</span>sha256, password, password_len))
</span></span><span style=display:flex><span>		goto die;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>SHA256_Final(hash, <span style=color:#f92672>&amp;</span>sha256))
</span></span><span style=display:flex><span>		goto die;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>die:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>die</span>(<span style=color:#e6db74>&#34;Failed to compute SHA256 for %s&#34;</span>, username);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Seems fair enough, it&rsquo;ll generate a hash of the <code>username + password</code>, then
hash that with the password.</p><p>I don&rsquo;t particularly want to implement any of this myself myself, so let&rsquo;s pull
in a couple crates:</p><ul><li><a href=https://crates.io/crates/sha2 class=external-link target=_blank rel=noopener><code>sha2</code></a> - for the SHA-256 algorithm</li><li><a href=https://crates.io/crates/digest class=external-link target=_blank rel=noopener><code>digest</code></a> - the <code>digest::Digest</code> trait comes from the
<a href=https://github.com/RustCrypto class=external-link target=_blank rel=noopener>RustCrypto</a> project and is used to implement generic
cryptographic hash functions</li><li><a href=https://crates.io/crates/hex class=external-link target=_blank rel=noopener><code>hex</code></a> - for converting bytes to their hexadecimal representation and
back again</li></ul><p>And then we can implement <code>LoginKey::sha256()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/login_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> digest::Digest;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> sha2::Sha256;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> LoginKey {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sha256</span>(username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, password: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> first_pass <span style=color:#f92672>=</span> Sha256::new()
</span></span><span style=display:flex><span>            .chain(username)
</span></span><span style=display:flex><span>            .chain(password)
</span></span><span style=display:flex><span>            .result();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> first_pass_hex <span style=color:#f92672>=</span> hex::encode(<span style=color:#f92672>&amp;</span>first_pass);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> second_pass <span style=color:#f92672>=</span> Sha256::new()
</span></span><span style=display:flex><span>            .chain(<span style=color:#f92672>&amp;</span>first_pass_hex)
</span></span><span style=display:flex><span>            .chain(password)
</span></span><span style=display:flex><span>            .result();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LoginKey::from_bytes(<span style=color:#f92672>&amp;</span>second_pass)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>from_bytes</span>(bytes: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        assert_eq!(bytes.len() <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>, LoginKey::<span style=color:#66d9ef>LEN</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> key <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; LoginKey::<span style=color:#66d9ef>LEN</span>];
</span></span><span style=display:flex><span>        hex::encode_to_slice(bytes, <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> key)
</span></span><span style=display:flex><span>            .expect(<span style=color:#e6db74>&#34;the assert guarantees we&#39;ve got the right length&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LoginKey(key)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To make sure I&rsquo;ve implemented this correctly, I gave the <code>lpass</code> program a dummy
set of credentials and using the debugger was able to see what they should hash
to.</p><p>This lets me write a simple sanity test.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/login_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>login_key_with_sha256</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-test-account@example.com&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;My Super Secret Password!&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> should_be <span style=color:#f92672>=</span> LoginKey(<span style=color:#f92672>*</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;b8a31d9784fa9a263d0e7a0d866b70612687f7067733126d74ccde02d3bab494&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> got <span style=color:#f92672>=</span> LoginKey::sha256(username, password);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        assert_eq!(got, should_be);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I can implement the <code>LoginKey::pbkdf2()</code> constructor in much the same way,
again letting the proper crate (in this case, <a href=https://crates.io/crates/pbkdf2 class=external-link target=_blank rel=noopener><code>pbkdf2</code></a>) do the heavy
lifting.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/login_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> sha2::Sha256;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> hmac::Hmac;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> LoginKey {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>pbkdf2</span>(username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, password: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, iterations: <span style=color:#66d9ef>usize</span>) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// the first rearranges the password (maintaining length), salting it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// with the username
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> first_pass <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; <span style=color:#66d9ef>KDF_HASH_LEN</span>];
</span></span><span style=display:flex><span>        pbkdf2::pbkdf2::<span style=color:#f92672>&lt;</span>Hmac<span style=color:#f92672>&lt;</span>Sha256<span style=color:#f92672>&gt;&gt;</span>(
</span></span><span style=display:flex><span>            password.as_bytes(),
</span></span><span style=display:flex><span>            username.as_bytes(),
</span></span><span style=display:flex><span>            iterations,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> first_pass,
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// we then hash the previous key, salting with the password
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// previous key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> key <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; <span style=color:#66d9ef>KDF_HASH_LEN</span>];
</span></span><span style=display:flex><span>        pbkdf2::pbkdf2::<span style=color:#f92672>&lt;</span>Hmac<span style=color:#f92672>&lt;</span>Sha256<span style=color:#f92672>&gt;&gt;</span>(
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span>first_pass,
</span></span><span style=display:flex><span>            password.as_bytes(),
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> key,
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LoginKey::from_bytes(<span style=color:#f92672>&amp;</span>key)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In much the same way, we can use the debugger to find a set of inputs and
outputs to test that our <code>LoginKey::pbkdf2()</code> function was implemented
correctly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/login_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>login_key_with_pbkdf2</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-test-account@example.com&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;My Super Secret Password!&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> iterations <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> should_be <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            LoginKey(<span style=color:#f92672>*</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;f93111b2fb6699de187ef8307aa84b1e9fdabf4a46cb821e83e507a95c3f7c97&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> got <span style=color:#f92672>=</span> LoginKey::pbkdf2(username, password, iterations);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        assert_eq!(got, should_be);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we can construct a <code>LoginKey</code>, we can <a href=https://github.com/Michael-F-Bryan/lastpass/blob/c0b7d260dcdf78cbaae83b15d9059573913f3366/src/bin/main.rs class=external-link target=_blank rel=noopener>update the test executable</a>
to accept credentials instead of a hard-coded login key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/bin/main.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> anyhow::Error;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> lastpass::{endpoints, keys::LoginKey};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> reqwest::Client;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> structopt::StructOpt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>(), Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    env_logger::init();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> args <span style=color:#f92672>=</span> Args::from_args();
</span></span><span style=display:flex><span>    log::debug!(<span style=color:#e6db74>&#34;Starting application with {:#?}&#34;</span>, args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> client <span style=color:#f92672>=</span> Client::builder()
</span></span><span style=display:flex><span>        .user_agent(lastpass::<span style=color:#66d9ef>DEFAULT_USER_AGENT</span>)
</span></span><span style=display:flex><span>        .cookie_store(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>        .build()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> iterations <span style=color:#f92672>=</span> endpoints::iterations(<span style=color:#f92672>&amp;</span>client, <span style=color:#f92672>&amp;</span>args.host, <span style=color:#f92672>&amp;</span>args.username).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> login_key <span style=color:#f92672>=</span> LoginKey::calculate(<span style=color:#f92672>&amp;</span>args.username, <span style=color:#f92672>&amp;</span>args.password, iterations);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    endpoints::login(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>client,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>args.host,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>args.username,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>login_key,
</span></span><span style=display:flex><span>        iterations,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log::info!(<span style=color:#e6db74>&#34;Logged in as {}&#34;</span>, args.username);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, StructOpt)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Args</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[structopt(
</span></span></span><span style=display:flex><span><span style=color:#75715e>        long = </span><span style=color:#e6db74>&#34;host&#34;</span><span style=color:#75715e>,
</span></span></span><span style=display:flex><span><span style=color:#75715e>        default_value = </span><span style=color:#e6db74>&#34;lastpass.com&#34;</span><span style=color:#75715e>,
</span></span></span><span style=display:flex><span><span style=color:#75715e>        help = </span><span style=color:#e6db74>&#34;The LastPass server&#39;s hostname&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    )]</span>
</span></span><span style=display:flex><span>    host: String,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[structopt(short = </span><span style=color:#e6db74>&#34;u&#34;</span><span style=color:#75715e>, long = </span><span style=color:#e6db74>&#34;username&#34;</span><span style=color:#75715e>, help = </span><span style=color:#e6db74>&#34;Your username&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    username: String,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[structopt(short = </span><span style=color:#e6db74>&#34;p&#34;</span><span style=color:#75715e>, long = </span><span style=color:#e6db74>&#34;password&#34;</span><span style=color:#75715e>, help = </span><span style=color:#e6db74>&#34;Your master password&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    password: String,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>While you reading through the earlier section, I took the liberty of creating
a function that asks LastPass how many iterations to use when generating a
login key.</p><p>The <code>iterations.php</code> endpoint replies with a single integer, so it&rsquo;s dead
simple.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/iterations.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>iterations</span>(
</span></span><span style=display:flex><span>    client: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Client</span>,
</span></span><span style=display:flex><span>    hostname: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    username: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>usize</span>, EndpointError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> url <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>/iterations.php&#34;</span>, hostname);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> Data { email: <span style=color:#a6e22e>username</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> response <span style=color:#f92672>=</span> client
</span></span><span style=display:flex><span>        .post(<span style=color:#f92672>&amp;</span>url)
</span></span><span style=display:flex><span>        .form(<span style=color:#f92672>&amp;</span>data)
</span></span><span style=display:flex><span>        .send()
</span></span><span style=display:flex><span>        .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>        .error_for_status()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> body <span style=color:#f92672>=</span> response.text().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    body.trim().parse().map_err(EndpointError::from)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Data</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    email: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=decryption-keys>Decryption Keys
<a class=heading-link href=#decryption-keys><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>To accompany the <code>LoginKey</code>, which has been shared with the LastPass servers
to prove who you are, there is also a <code>DecryptionKey</code> for decrypting your
actual LastPass vault.</p><p>This second key is derived from your master password and never leaves your
computer, hence the claim that LastPass themselves can&rsquo;t read your personal
data.</p><p>The <code>DecryptionKey</code> is also constructed using SHA-256 or PBKDF2, so I won&rsquo;t
go into detail on that. Instead, I&rsquo;d like to add a method for decrypting
ciphertext using a <code>DecryptionKey</code>.</p><p>I guess the best place to start is by looking at how the <code>lastpass-cli</code> project
decrypts things using the <code>DecryptionKey</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/cipher.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cipher_aes_decrypt</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>ciphertext, <span style=color:#66d9ef>size_t</span> len, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	EVP_CIPHER_CTX <span style=color:#f92672>*</span>ctx;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>plaintext;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> out_len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>len)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ctx <span style=color:#f92672>=</span> <span style=color:#a6e22e>EVP_CIPHER_CTX_new</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>ctx)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	plaintext <span style=color:#f92672>=</span> <span style=color:#a6e22e>xcalloc</span>(len <span style=color:#f92672>+</span> AES_BLOCK_SIZE <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>33</span> <span style=color:#f92672>&amp;&amp;</span> len <span style=color:#f92672>%</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> ciphertext[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;!&#39;</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>EVP_DecryptInit_ex</span>(ctx, <span style=color:#a6e22e>EVP_aes_256_cbc</span>(), NULL, key, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)(ciphertext <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>goto</span> error;
</span></span><span style=display:flex><span>		ciphertext <span style=color:#f92672>+=</span> <span style=color:#ae81ff>17</span>;
</span></span><span style=display:flex><span>		len <span style=color:#f92672>-=</span> <span style=color:#ae81ff>17</span>;
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>EVP_DecryptInit_ex</span>(ctx, <span style=color:#a6e22e>EVP_aes_256_ecb</span>(), NULL, key, NULL))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>goto</span> error;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>EVP_DecryptUpdate</span>(ctx, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)plaintext, <span style=color:#f92672>&amp;</span>out_len, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)ciphertext, len))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> error;
</span></span><span style=display:flex><span>	len <span style=color:#f92672>=</span> out_len;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>EVP_DecryptFinal_ex</span>(ctx, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)(plaintext <span style=color:#f92672>+</span> out_len), <span style=color:#f92672>&amp;</span>out_len))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> error;
</span></span><span style=display:flex><span>	len <span style=color:#f92672>+=</span> out_len;
</span></span><span style=display:flex><span>	plaintext[len] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EVP_CIPHER_CTX_free</span>(ctx);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> plaintext;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>error:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EVP_CIPHER_CTX_free</span>(ctx);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>secure_clear</span>(plaintext, len <span style=color:#f92672>+</span> AES_BLOCK_SIZE <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>free</span>(plaintext);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Although the code is a bit convoluted due to way error handling and argument
validation are done, it looks like we switch between two input algorithms at
the start based, then pass the ciphertext through the decryption function.</p><p>Similar to the <code>LoginKey::calculate()</code> function I&rsquo;m guessing this is because
the encryption algorithm has changed over time. So it was initially just
using AES-256 with the ECB <a href=https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation class=external-link target=_blank rel=noopener>block cipher mode</a>, then later they
transitioned to CBC with a 16-byte <a href=https://en.wikipedia.org/wiki/Initialization_vector class=external-link target=_blank rel=noopener>initialization vector</a> (that&rsquo;s why
there&rsquo;s the <code>ciphertext[0] == '!'</code> and all that pointer arithmetic).</p><p>The <a href=https://crates.io/crates/aes class=external-link target=_blank rel=noopener><code>aes</code></a> and <a href=https://crates.io/crates/block_modes class=external-link target=_blank rel=noopener><code>block-modes</code></a> crates made this a lot easier
than I was expecting.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/decryption_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> aes::Aes256;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> block_modes::{block_padding::Pkcs7, BlockMode, Cbc, Ecb};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> DecryptionKey {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>decrypt</span>(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>self,
</span></span><span style=display:flex><span>        ciphertext: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>],
</span></span><span style=display:flex><span>    ) -&gt; Result<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span>, DecryptionError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ciphertext.is_empty() {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// If there&#39;s no input, there&#39;s nothing to decrypt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> Ok(Vec::new());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> decrypted <span style=color:#f92672>=</span> <span style=color:#66d9ef>if</span> uses_cbc(ciphertext) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> iv <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>ciphertext[<span style=color:#ae81ff>1</span><span style=color:#f92672>..</span><span style=color:#ae81ff>17</span>];
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> ciphertext <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>ciphertext[<span style=color:#ae81ff>17</span><span style=color:#f92672>..</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Cbc::<span style=color:#f92672>&lt;</span>Aes256, Pkcs7<span style=color:#f92672>&gt;</span>::new_var(<span style=color:#f92672>&amp;</span>self.<span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>iv)<span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                .decrypt_vec(ciphertext)<span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            Ecb::<span style=color:#f92672>&lt;</span>Aes256, Pkcs7<span style=color:#f92672>&gt;</span>::new_var(<span style=color:#f92672>&amp;</span>self.<span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>[])<span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                .decrypt_vec(ciphertext)<span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(decrypted)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>uses_cbc</span>(ciphertext: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    ciphertext.len() <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>33</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;&amp;</span> ciphertext.len() <span style=color:#f92672>%</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;&amp;</span> ciphertext.starts_with(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>lastpass-cli</code> project doesn&rsquo;t have any tests with examples of decrypted
data (or any tests at all for that matter), so I&rsquo;ll need to resort to using
debugger on <code>lpass</code> and seeing how real data is decrypted if I want to make
sure my code works.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/keys/decryption_key.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>decrypt_some_text</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> key <span style=color:#f92672>=</span> DecryptionKey::from_raw(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> ciphertext <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>33</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>151</span>, <span style=color:#ae81ff>186</span>, <span style=color:#ae81ff>165</span>, <span style=color:#ae81ff>216</span>, <span style=color:#ae81ff>165</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>154</span>, <span style=color:#ae81ff>207</span>, <span style=color:#ae81ff>238</span>, <span style=color:#ae81ff>219</span>, <span style=color:#ae81ff>138</span>, <span style=color:#ae81ff>19</span>,
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>178</span>, <span style=color:#ae81ff>141</span>, <span style=color:#ae81ff>91</span>, <span style=color:#ae81ff>241</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>69</span>, <span style=color:#ae81ff>189</span>, <span style=color:#ae81ff>39</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>161</span>, <span style=color:#ae81ff>76</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>240</span>, <span style=color:#ae81ff>137</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>124</span>, <span style=color:#ae81ff>42</span>, <span style=color:#ae81ff>129</span>, <span style=color:#ae81ff>213</span>, <span style=color:#ae81ff>123</span>, <span style=color:#ae81ff>192</span>, <span style=color:#ae81ff>182</span>, <span style=color:#ae81ff>178</span>, <span style=color:#ae81ff>194</span>, <span style=color:#ae81ff>84</span>, <span style=color:#ae81ff>175</span>,
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>73</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>104</span>, <span style=color:#ae81ff>137</span>, <span style=color:#ae81ff>123</span>,
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> got <span style=color:#f92672>=</span> key.decrypt(<span style=color:#f92672>&amp;</span>ciphertext).unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        assert_eq!(
</span></span><span style=display:flex><span>            String::from_utf8(got).unwrap(),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Example password without folder&#34;</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Well the test passes, so if everything goes to plan we should have everything
we need to decode the vault.</p><h2 id=reading-the-vault>Reading the Vault
<a class=heading-link href=#reading-the-vault><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now we&rsquo;ve implemented the fundamental things like crypto and calling a couple
API endpoints, we&rsquo;re getting into the more juicy stuff. The next step is to
download a copy of the password vault and read it into memory.</p><h3 id=retrieving-the-vault>Retrieving the Vault
<a class=heading-link href=#retrieving-the-vault><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Once you&rsquo;ve logged in, retrieving a copy of the password vault from LastPass is
really easy. We don&rsquo;t need to supply any authentication information because
LastPass already gave us a PHP session cookie and I&rsquo;ll be reusing the same
<code>reqwest::Client</code> for both calls.</p><p>Just like <code>login.php</code> and <code>iterations.php</code>, we need to send a POST request
to the <code>getaccts.php</code> endpoint and read the response body.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/vault.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#66d9ef>crate</span>::{ Vault, VaultParseError };
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> reqwest::{Client, Error <span style=color:#66d9ef>as</span> ReqwestError};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> serde_derive::Serialize;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>LASTPASS_CLI_VERSION</span>: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.3.3.15.g8767b5e&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// Fetch the latest vault snapshot from LastPass.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_vault</span>(
</span></span><span style=display:flex><span>    client: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Client</span>,
</span></span><span style=display:flex><span>    hostname: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span>Vault, VaultError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> Data {
</span></span><span style=display:flex><span>        mobile: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        request_src: <span style=color:#e6db74>&#34;cli&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// I&#39;m not sure why lastpass-cli used its version number instead of a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// bool here, but \_(„ÉÑ)_/¬Ø
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        has_plugin: <span style=color:#a6e22e>LASTPASS_CLI_VERSION</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> url <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>/getaccts.php&#34;</span>, hostname);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> body <span style=color:#f92672>=</span> client
</span></span><span style=display:flex><span>        .post(<span style=color:#f92672>&amp;</span>url)
</span></span><span style=display:flex><span>        .form(<span style=color:#f92672>&amp;</span>data)
</span></span><span style=display:flex><span>        .send()
</span></span><span style=display:flex><span>        .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>        .error_for_status()<span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>        .bytes()
</span></span><span style=display:flex><span>        .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Vault::parse(<span style=color:#f92672>&amp;</span>body).map_err(VaultError::Parse)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Data</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    mobile: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;requestsrc&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    request_src: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;hasplugin&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    has_plugin: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, thiserror::Error)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>VaultError</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The HTTP client encountered an error.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Unable to send the request&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    HttpClient(<span style=color:#75715e>#[from]</span> ReqwestError),
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Unable to parse the vault&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    Parse(<span style=color:#75715e>#[from]</span> VaultParseError),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For now I&rsquo;ve also stubbed out a <code>Vault</code> type and given it a <code>Vault::parse()</code>
method that accepts a <code>&[u8]</code> and will return either a <code>Vault</code> or a
<code>VaultParseError</code>.</p><h3 id=decoding-the-vault>Decoding the Vault
<a class=heading-link href=#decoding-the-vault><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Running our test program again and inserting a line which will write the
response <code>body</code> to disk shows a big hunk of binary.</p><p>Let&rsquo;s print this data out as hex and see if we can spot any patterns&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># xxd src/vault_from_dummy_account.bin | head -n 30
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>00000000: 4c50 4156 0000 0002 3132 4154 5652 0000  LPAV....12ATVR..
</span></span><span style=display:flex><span>00000010: 0001 3145 4e43 5500 0000 2c35 4e5a 5969  ..1ENCU...,5NZYi
</span></span><span style=display:flex><span>00000020: 7967 7236 6659 514d 3950 424f 3765 5243  ygr6fYQM9PBO7eRC
</span></span><span style=display:flex><span>00000030: 6357 6f71 4336 454d 7a6c 3159 594b 705a  cWoqC6EMzl1YYKpZ
</span></span><span style=display:flex><span>00000040: 7357 7272 446b 3d43 4243 5500 0000 0131  sWrrDk=CBCU....1
</span></span><span style=display:flex><span>00000050: 4242 5445 0000 000a 3135 3839 3236 3534  BBTE....15892654
</span></span><span style=display:flex><span>00000060: 3836 4950 5445 0000 000a 3135 3839 3236  86IPTE....158926
</span></span><span style=display:flex><span>00000070: 3534 3836 574d 5445 0000 000a 3135 3839  5486WMTE....1589
</span></span><span style=display:flex><span>00000080: 3236 3534 3836 414e 5445 0000 000a 3135  265486ANTE....15
</span></span><span style=display:flex><span>00000090: 3839 3236 3534 3836 444f 5445 0000 000a  89265486DOTE....
</span></span><span style=display:flex><span>000000a0: 3135 3839 3236 3534 3836 4645 5445 0000  1589265486FETE..
</span></span><span style=display:flex><span>000000b0: 000a 3135 3839 3236 3534 3836 4655 5445  ..1589265486FUTE
</span></span><span style=display:flex><span>000000c0: 0000 000a 3135 3839 3236 3534 3836 5359  ....1589265486SY
</span></span><span style=display:flex><span>000000d0: 5445 0000 000a 3135 3839 3236 3534 3836  TE....1589265486
</span></span><span style=display:flex><span>000000e0: 574f 5445 0000 000a 3135 3839 3236 3534  WOTE....15892654
</span></span><span style=display:flex><span>000000f0: 3836 5441 5445 0000 000a 3135 3839 3236  86TATE....158926
</span></span><span style=display:flex><span>00000100: 3534 3836 5750 5445 0000 000a 3135 3839  5486WPTE....1589
</span></span><span style=display:flex><span>00000110: 3236 3534 3836 5350 4d54 0000 0037 0000  265486SPMT...7..
</span></span><span style=display:flex><span>00000120: 0001 3000 0000 0130 0000 0001 3000 0000  ..0....0....0...
</span></span><span style=display:flex><span>00000130: 0130 0000 0001 3000 0000 0131 0000 0001  .0....0....1....
</span></span><span style=display:flex><span>00000140: 3100 0000 0130 0000 0001 3000 0000 0130  1....0....0....0
</span></span><span style=display:flex><span>00000150: 0000 0001 304e 4d41 4300 0000 0136 4143  ....0NMAC....6AC
</span></span><span style=display:flex><span>00000160: 4354 0000 01c4 0000 0013 3534 3936 3233  CT........549623
</span></span><span style=display:flex><span>00000170: 3039 3734 3133 3031 3830 3637 3300 0000  0974130180673...
</span></span><span style=display:flex><span>00000180: 3121 0b97 baa5 d8a5 3a9a cfee db8a 131a  1!......:.......
</span></span><span style=display:flex><span>00000190: b28d 5bf1 1f1c 45bd 2705 0aa1 4c39 0af0  ..[...E.&#39;...L9..
</span></span><span style=display:flex><span>000001a0: 890b 7c2a 81d5 7bc0 b6b2 c254 af49 1368  ..|*..{....T.I.h
</span></span><span style=display:flex><span>000001b0: 897b 0000 0031 215d ae99 4843 6321 5162  .{...1!]..HCc!Qb
</span></span><span style=display:flex><span>000001c0: 80f5 6587 f669 4628 588e 8ba5 51b5 e6a3  ..e..iF(X...Q...
</span></span><span style=display:flex><span>000001d0: 83ed ba28 65e4 786d 2b2a 7ef8 c7d2 ccf9  ...(e.xm+*~.....
</span></span></code></pre></div><div class="notices note"><p>I set up a dummy LastPass account just for this analysis, so I&rsquo;m not overly
concerned about publishing it on the internet.</p><p>Besides, all the &ldquo;interesting&rdquo; bits are encrypted and you don&rsquo;t have access
to the master password so the most anyone can see is a couple unencrypted
timestamps.</p></div><p>After staring at the wall of hex for a couple seconds I noticed an interesting
pattern. This blob contains a repeating pattern&mldr;</p><ul><li>a 4-byte ASCII mnemonic</li><li>a 4-byte big-endian integer, <code>n</code></li><li><code>n</code> bytes worth of data, sometimes cleartext (e.g. base64-encoded text or a
long number that looks like a unix timestamp) and other times it&rsquo;ll look like
garbage (encrypted data)</li></ul><p>Now we have a rough idea of how a vault is structured, let&rsquo;s dive into some
source code and see how it&rsquo;s turned into something more usable.</p><p>Internally, it looks like LastPass refer to this thing as a <code>blob</code>, and there
happens to be <code>blob_parse()</code> function in <code>blob.h</code>. Let&rsquo;s start there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/blob.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> blob <span style=color:#f92672>*</span><span style=color:#a6e22e>blob_parse</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>blob, <span style=color:#66d9ef>size_t</span> len, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN], <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> private_key <span style=color:#f92672>*</span>private_key)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>read_chunk</span>(<span style=color:#f92672>&amp;</span>blob_pos, <span style=color:#f92672>&amp;</span>chunk)) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;LPAV&#34;</span>)) {
</span></span><span style=display:flex><span>			versionstr <span style=color:#f92672>=</span> <span style=color:#a6e22e>xstrndup</span>((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>) chunk.data, chunk.len);
</span></span><span style=display:flex><span>			parsed<span style=color:#f92672>-&gt;</span>version <span style=color:#f92672>=</span> <span style=color:#a6e22e>strtoull</span>(versionstr, NULL, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;ACCT&#34;</span>)) {
</span></span><span style=display:flex><span>			account <span style=color:#f92672>=</span> <span style=color:#a6e22e>account_parse</span>(<span style=color:#f92672>&amp;</span>chunk, last_share <span style=color:#f92672>?</span> last_share<span style=color:#f92672>-&gt;</span>key : key);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>account)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>goto</span> error;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;ACFL&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;ACOF&#34;</span>)) {
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;LOCL&#34;</span>)) {
</span></span><span style=display:flex><span>			parsed<span style=color:#f92672>-&gt;</span>local_version <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;SHAR&#34;</span>)) {
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;AACT&#34;</span>)) {
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;AACF&#34;</span>)) {
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(chunk.name, <span style=color:#e6db74>&#34;ATTA&#34;</span>)) {
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>versionstr)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> error;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> parsed;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>error:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>blob_free</span>(parsed);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This seems simple enough. Those patterns we saw earlier are called <code>chunk</code>s, and
parsing a <code>blob</code> is just a case of reading each <code>chunk</code> in the <code>blob</code>,
invoking different routines depending on a 4-character mnemonic.</p><p>Let&rsquo;s have a look at how each chunk is parsed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/blob.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> chunk {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> name[<span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>data;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>size_t</span> len;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/blob.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_chunk</span>(<span style=color:#66d9ef>struct</span> blob_pos <span style=color:#f92672>*</span>blob, <span style=color:#66d9ef>struct</span> chunk <span style=color:#f92672>*</span>chunk)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (blob<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>	chunk<span style=color:#f92672>-&gt;</span>name[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> blob<span style=color:#f92672>-&gt;</span>data[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>	chunk<span style=color:#f92672>-&gt;</span>name[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> blob<span style=color:#f92672>-&gt;</span>data[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>	chunk<span style=color:#f92672>-&gt;</span>name[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> blob<span style=color:#f92672>-&gt;</span>data[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>	chunk<span style=color:#f92672>-&gt;</span>name[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> blob<span style=color:#f92672>-&gt;</span>data[<span style=color:#ae81ff>3</span>];
</span></span><span style=display:flex><span>	chunk<span style=color:#f92672>-&gt;</span>name[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>	blob<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>-=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>	blob<span style=color:#f92672>-&gt;</span>data <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (blob<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>uint32_t</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>	chunk<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>=</span> <span style=color:#a6e22e>be32toh</span>(<span style=color:#f92672>*</span>((<span style=color:#66d9ef>uint32_t</span> <span style=color:#f92672>*</span>)blob<span style=color:#f92672>-&gt;</span>data));
</span></span><span style=display:flex><span>	blob<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>-=</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>uint32_t</span>);
</span></span><span style=display:flex><span>	blob<span style=color:#f92672>-&gt;</span>data <span style=color:#f92672>+=</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>uint32_t</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (chunk<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>&gt;</span> blob<span style=color:#f92672>-&gt;</span>len)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>	chunk<span style=color:#f92672>-&gt;</span>data <span style=color:#f92672>=</span> blob<span style=color:#f92672>-&gt;</span>data;
</span></span><span style=display:flex><span>	blob<span style=color:#f92672>-&gt;</span>data <span style=color:#f92672>+=</span> chunk<span style=color:#f92672>-&gt;</span>len;
</span></span><span style=display:flex><span>	blob<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>-=</span> chunk<span style=color:#f92672>-&gt;</span>len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This can be converted fairly mechanically into Rust. The only noticeable
difference is that instead of mutating the slice every time we read some data
off the front, I&rsquo;ll return a new slice.</p><p>This means when the caller removes some data from a buffer they&rsquo;ll be able to
<em>shadow</em> the old variable, making sure it&rsquo;s not possible to accidentally
confuse what has been already parsed and what hasn&rsquo;t.</p><p>I&rsquo;ve found this pattern works quite well when parsing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/parser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> byteorder::{BigEndian, ByteOrder};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Chunk</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    name: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> [<span style=color:#66d9ef>u8</span>],
</span></span><span style=display:flex><span>    data: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> [<span style=color:#66d9ef>u8</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> Chunk<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse</span>(buffer: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> [<span style=color:#66d9ef>u8</span>]) -&gt; Option<span style=color:#f92672>&lt;</span>(Chunk<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>&#39;a</span> [<span style=color:#66d9ef>u8</span>])<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> buffer.len() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span> { <span style=color:#66d9ef>return</span> None; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (name, buffer) <span style=color:#f92672>=</span> buffer.split_at(<span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> buffer.len() <span style=color:#f92672>&lt;</span> std::mem::size_of::<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u32</span><span style=color:#f92672>&gt;</span>() { <span style=color:#66d9ef>return</span> None; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (num_bytes, buffer) <span style=color:#f92672>=</span> buffer.split_at(std::mem::size_of::<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u32</span><span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> num_bytes: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> BigEndian::read_u32(num_bytes).try_into().unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> num_bytes <span style=color:#f92672>&gt;</span> buffer.len() { <span style=color:#66d9ef>return</span> None; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (data, rest) <span style=color:#f92672>=</span> buffer.split_at(num_bytes);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> chunk <span style=color:#f92672>=</span> Chunk { name, data };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Some((chunk, rest))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we can read a <code>Chunk</code> from the front of a byte buffer, we can start working
on the <code>Parser</code>. Instead of leaving all the state and code inline like they did
in <code>blob_parse()</code>, I&rsquo;ve decided to pull intermediate values into their own
<code>Parser</code> struct and give each chunk type its own <code>handle_XXX()</code> method. That
just helps to keep functions at a manageable size and improve readability.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/parser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#66d9ef>crate</span>::{Account, Share, App, DecryptionKey, VaultParseError};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Default)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Parser</span> {
</span></span><span style=display:flex><span>    vault_version: Option<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u64</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    accounts: Vec<span style=color:#f92672>&lt;</span>Account<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    shares: Vec<span style=color:#f92672>&lt;</span>Share<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    app: Option<span style=color:#f92672>&lt;</span>App<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    local: <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Parser {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>() -&gt; <span style=color:#a6e22e>Self</span> { Parser::default() }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse</span>(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>mut</span> buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>],
</span></span><span style=display:flex><span>        decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>,
</span></span><span style=display:flex><span>    ) -&gt; Result<span style=color:#f92672>&lt;</span>(), VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>let</span> Some((chunk, rest)) <span style=color:#f92672>=</span> Chunk::parse(buffer) {
</span></span><span style=display:flex><span>            buffer <span style=color:#f92672>=</span> rest;
</span></span><span style=display:flex><span>            self.handle_chunk(chunk, decryption_key)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can see the <code>Parser::parse()</code> method just reads chunks and passes them to
the <code>Parser::handle_chunk()</code> method. Likewise, <code>Parser::handle_chunk()</code> just
does a <code>match</code> on the <code>chunk</code>&rsquo;s name and passes the chunk body to the
appropriate method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/parser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Parser {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle_chunk</span>(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self,
</span></span><span style=display:flex><span>        chunk: <span style=color:#a6e22e>Chunk</span><span style=color:#f92672>&lt;</span>&#39;_<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>        decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>,
</span></span><span style=display:flex><span>    ) -&gt; Result<span style=color:#f92672>&lt;</span>(), VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> chunk.name {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;LPAV&#34;</span> <span style=color:#f92672>=&gt;</span> { self.vault_version <span style=color:#f92672>=</span> chunk.data_as_str()<span style=color:#f92672>?</span>.parse().ok(); },
</span></span><span style=display:flex><span>            <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;ACCT&#34;</span> <span style=color:#f92672>=&gt;</span> self.handle_account(chunk.data, decryption_key)<span style=color:#f92672>?</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;ATTA&#34;</span> <span style=color:#f92672>=&gt;</span> self.handle_attachment(chunk.data)<span style=color:#f92672>?</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;LOCL&#34;</span> <span style=color:#f92672>=&gt;</span> self.local <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;SHAR&#34;</span> <span style=color:#f92672>=&gt;</span> self.handle_share(chunk.data)<span style=color:#f92672>?</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;AACT&#34;</span> <span style=color:#f92672>=&gt;</span> self.handle_app(chunk.data, decryption_key)<span style=color:#f92672>?</span>,
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> {},
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle_account</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>], decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>) -&gt; Result<span style=color:#f92672>&lt;</span>(), VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        self.accounts.push(parse_account(buffer, decryption_key)<span style=color:#f92672>?</span>);
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle_attachment</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; Result<span style=color:#f92672>&lt;</span>(), VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> attachment <span style=color:#f92672>=</span> parse_attachment(buffer)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> self.accounts.iter_mut().find(<span style=color:#f92672>|</span>account<span style=color:#f92672>|</span> account.id <span style=color:#f92672>==</span> attachment.parent)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Some(parent) <span style=color:#f92672>=&gt;</span> { parent.attachments.push(attachment); },
</span></span><span style=display:flex><span>            None <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>return</span> Err(VaultParseError::AttachmentWithoutAccount {
</span></span><span style=display:flex><span>                attachment_id: <span style=color:#a6e22e>attachment</span>.id,
</span></span><span style=display:flex><span>                account_id: <span style=color:#a6e22e>attachment</span>.parent,
</span></span><span style=display:flex><span>            }),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle_share</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; Result<span style=color:#f92672>&lt;</span>(), VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        self.shares.push(parse_share(buffer)<span style=color:#f92672>?</span>);
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle_app</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>], decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>) -&gt; Result<span style=color:#f92672>&lt;</span>(), VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        self.app <span style=color:#f92672>=</span> Some(parse_app(buffer, decryption_key)<span style=color:#f92672>?</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s have a think about what we&rsquo;ll need to write the <code>parse_account()</code>
function.</p><p>In LastPass parlance, an <code>Account</code> is the fundamental unit in the vault.
These are used to represent things like account credentials (e.g. username
and password), it lets you attach a URL so you can quickly jump to the
website, you can have notes (a free-form string), attached files, and much
more.</p><p>As I&rsquo;ve coded it, an <code>Account</code> looks something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/account.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#66d9ef>crate</span>::{Attachment, DecryptionError, DecryptionKey, Id};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> url::Url;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// A single entry, typically a password or address.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Account</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> id: <span style=color:#a6e22e>Id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The account&#39;s name.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> name: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Which group the account is in (think of it like a directory).
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> group: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The URL associated with this account.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> url: <span style=color:#a6e22e>Url</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Any notes that may be attached.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> note: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> note_type: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Did the user mark this [`Account`] as a favourite?
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> favourite: <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The associated username.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> username: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The associated password.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> password: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Should we prompt for the master password before showing details to the
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// user?
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> password_protected: <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// An encrypted copy of the key used to decode this [`Account`]&#39;s
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// attachments.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> encrypted_attachment_key: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Does this account have any [`Attachment`]s?
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> attachment_present: <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> last_touch: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> last_modified: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Files which may be attached to this [`Account`].
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> attachments: Vec<span style=color:#f92672>&lt;</span>Attachment<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// src/attachment.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// Metadata about an attached file.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Attachment</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> id: <span style=color:#a6e22e>Id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The ID of the parent [`Account`].
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> parent: <span style=color:#a6e22e>Id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The file&#39;s mimetype.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> mime_type: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// An opaque string which is used by the backend to find the correct
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// version of an attached file.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> storage_key: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The size of the attachment, in bytes.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> size: <span style=color:#66d9ef>u64</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The attachment&#39;s filename, encrypted using the account&#39;s
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// `attachment_key`.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> encrypted_filename: String,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Like a lot of core business objects tend to do, you can see the <code>Account</code> has
grown a large number of fields over the years.</p><p>To help handle the monotony of parsing dozens of fields, <code>lastpass-cli</code> has
introduced a couple helper macros and functions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/blob.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_item</span>(<span style=color:#66d9ef>struct</span> chunk <span style=color:#f92672>*</span>chunk, <span style=color:#66d9ef>struct</span> item <span style=color:#f92672>*</span>item) { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>read_hex_string</span>(<span style=color:#66d9ef>struct</span> chunk <span style=color:#f92672>*</span>chunk) { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>read_plain_string</span>(<span style=color:#66d9ef>struct</span> chunk <span style=color:#f92672>*</span>chunk) { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>read_crypt_string</span>(<span style=color:#66d9ef>struct</span> chunk <span style=color:#f92672>*</span>chunk,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN],
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>stored_base64) { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read_boolean</span>(<span style=color:#66d9ef>struct</span> chunk <span style=color:#f92672>*</span>chunk) { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define entry_plain_at(base, var) do { \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	char *__entry_val__ = read_plain_string(chunk); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	if (!__entry_val__) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		goto error; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	base-&gt;var = __entry_val__; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	} while (0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define entry_plain(var) entry_plain_at(parsed, var)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define entry_hex_at(base, var) do { \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	char *__entry_val__ = read_hex_string(chunk); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	if (!__entry_val__) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		goto error; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	base-&gt;var = __entry_val__; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	} while (0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define entry_hex(var) entry_hex_at(parsed, var)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define entry_boolean(var) do { \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	int __entry_val__ = read_boolean(chunk); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	if (__entry_val__ &lt; 0) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		goto error; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	parsed-&gt;var = __entry_val__; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	} while (0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define entry_crypt_at(base, var) do { \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	char *__entry_val__ = read_crypt_string(chunk, key, &amp;base-&gt;var##_encrypted); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	if (!__entry_val__) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		goto error; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	base-&gt;var = __entry_val__; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	} while (0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define entry_crypt(var) entry_crypt_at(parsed, var)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define skip(placeholder) do { \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	struct item skip_item; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	if (!read_item(chunk, &amp;skip_item)) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		goto error; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	} while (0)
</span></span></span></code></pre></div><p>The only non-trivial helper is <code>read_crypt_string()</code>, the equivalent of our
<code>DecodeKey::decode()</code>. The rest just pop the next item from a <code>Chunk</code> and
parse it into the desired format.</p><p>From here, we can see how the <code>account_parse()</code> function is implemented. It&rsquo;s
not complicated per-se, just long.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/blob.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> account <span style=color:#f92672>*</span><span style=color:#a6e22e>account_parse</span>(<span style=color:#66d9ef>struct</span> chunk <span style=color:#f92672>*</span>chunk, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> key[KDF_HASH_LEN])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> account <span style=color:#f92672>*</span>parsed <span style=color:#f92672>=</span> <span style=color:#a6e22e>new_account</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_plain</span>(id);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_crypt</span>(name);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_crypt</span>(group);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_hex</span>(url);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_crypt</span>(note);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_boolean</span>(fav);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(sharedfromaid);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_crypt</span>(username);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_crypt</span>(password);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_boolean</span>(pwprotect);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(genpw);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(sn);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_plain</span>(last_touch);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(autologin);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(never_autofill);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(realm_data);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(fiid);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(custom_js);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(submit_id);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(captcha_id);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(urid);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(basic_auth);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(method);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(action);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(groupid);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(deleted);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_plain</span>(attachkey_encrypted);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_boolean</span>(attachpresent);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(individualshare);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(notetype);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(noalert);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entry_plain</span>(last_modified_gmt);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(hasbeenshared);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(last_pwchange_gmt);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(created_gmt);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skip</span>(vulnerable);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (parsed<span style=color:#f92672>-&gt;</span>name[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>		parsed<span style=color:#f92672>-&gt;</span>name[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (parsed<span style=color:#f92672>-&gt;</span>group[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>		parsed<span style=color:#f92672>-&gt;</span>group[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strlen</span>(parsed<span style=color:#f92672>-&gt;</span>attachkey_encrypted)) {
</span></span><span style=display:flex><span>		parsed<span style=color:#f92672>-&gt;</span>attachkey <span style=color:#f92672>=</span> <span style=color:#a6e22e>cipher_aes_decrypt_base64</span>(
</span></span><span style=display:flex><span>			parsed<span style=color:#f92672>-&gt;</span>attachkey_encrypted, key);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>parsed<span style=color:#f92672>-&gt;</span>attachkey)
</span></span><span style=display:flex><span>		parsed<span style=color:#f92672>-&gt;</span>attachkey <span style=color:#f92672>=</span> <span style=color:#a6e22e>xstrdup</span>(<span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* use name as &#39;fullname&#39; only if there&#39;s no assigned group */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strlen</span>(parsed<span style=color:#f92672>-&gt;</span>group) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>	    (<span style=color:#a6e22e>strlen</span>(parsed<span style=color:#f92672>-&gt;</span>name) <span style=color:#f92672>||</span> <span style=color:#a6e22e>account_is_group</span>(parsed)))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>xasprintf</span>(<span style=color:#f92672>&amp;</span>parsed<span style=color:#f92672>-&gt;</span>fullname, <span style=color:#e6db74>&#34;%s/%s&#34;</span>, parsed<span style=color:#f92672>-&gt;</span>group, parsed<span style=color:#f92672>-&gt;</span>name);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>		parsed<span style=color:#f92672>-&gt;</span>fullname <span style=color:#f92672>=</span> <span style=color:#a6e22e>xstrdup</span>(parsed<span style=color:#f92672>-&gt;</span>name);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> parsed;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>error:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>account_free</span>(parsed);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Our <code>parse_account()</code> function looks quite similar, although deciding to just
use helper functions and not macros means it&rsquo;s more visually cluttered.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span>(<span style=color:#66d9ef>crate</span>) <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse_account</span>(
</span></span><span style=display:flex><span>    buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>],
</span></span><span style=display:flex><span>    decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span>Account, VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (id, buffer) <span style=color:#f92672>=</span> read_parsed(buffer, <span style=color:#e6db74>&#34;account.id&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (name, buffer) <span style=color:#f92672>=</span> read_encrypted(buffer, <span style=color:#e6db74>&#34;account.name&#34;</span>, decryption_key)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (group, buffer) <span style=color:#f92672>=</span> read_encrypted(buffer, <span style=color:#e6db74>&#34;account.group&#34;</span>, decryption_key)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (url, buffer) <span style=color:#f92672>=</span> read_hex_string(buffer, <span style=color:#e6db74>&#34;account.url&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (note, buffer) <span style=color:#f92672>=</span> read_encrypted(buffer, <span style=color:#e6db74>&#34;account.note&#34;</span>, <span style=color:#f92672>&amp;</span>decryption_key)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (fav, buffer) <span style=color:#f92672>=</span> read_bool(buffer, <span style=color:#e6db74>&#34;account.fav&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.sharedfromaid&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (username, buffer) <span style=color:#f92672>=</span> read_encrypted(buffer, <span style=color:#e6db74>&#34;account.username&#34;</span>, decryption_key)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (password, buffer) <span style=color:#f92672>=</span> read_encrypted(buffer, <span style=color:#e6db74>&#34;account.password&#34;</span>, decryption_key)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (password_protected, buffer) <span style=color:#f92672>=</span> read_bool(buffer, <span style=color:#e6db74>&#34;account.pwprotect&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.genpw&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.sn&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (last_touch, buffer) <span style=color:#f92672>=</span> read_str_item(buffer, <span style=color:#e6db74>&#34;account.last_touch&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.autologin&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.never_autofill&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.realm_data&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.fiid&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.custom_js&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.submit_id&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.captcha_id&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.urid&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.basic_auth&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.method&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.action&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.groupid&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.deleted&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (attachkey_encrypted, buffer) <span style=color:#f92672>=</span> read_str_item(buffer, <span style=color:#e6db74>&#34;account.attachkey_encrypted&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (attachment_present, buffer) <span style=color:#f92672>=</span> read_bool(buffer, <span style=color:#e6db74>&#34;account.attachpresent&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.individualshare&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (note_type, buffer) <span style=color:#f92672>=</span> read_str_item(buffer, <span style=color:#e6db74>&#34;account.notetype&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.noalert&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (last_modified_gmt, buffer) <span style=color:#f92672>=</span> read_str_item(buffer, <span style=color:#e6db74>&#34;account.last_modified_gmt&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.hasbeenshared&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.last_pwchange_gmt&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.created_gmt&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer <span style=color:#f92672>=</span> skip(buffer, <span style=color:#e6db74>&#34;account.vulnerable&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> buffer;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(Account {
</span></span><span style=display:flex><span>        id,
</span></span><span style=display:flex><span>        name,
</span></span><span style=display:flex><span>        username,
</span></span><span style=display:flex><span>        password,
</span></span><span style=display:flex><span>        password_protected,
</span></span><span style=display:flex><span>        note: <span style=color:#a6e22e>note</span>.to_string(),
</span></span><span style=display:flex><span>        note_type: <span style=color:#a6e22e>note_type</span>.to_string(),
</span></span><span style=display:flex><span>        last_touch: <span style=color:#a6e22e>last_touch</span>.to_string(),
</span></span><span style=display:flex><span>        encrypted_attachment_key: <span style=color:#a6e22e>attachkey_encrypted</span>.to_string(),
</span></span><span style=display:flex><span>        attachment_present,
</span></span><span style=display:flex><span>        favourite: <span style=color:#a6e22e>fav</span>,
</span></span><span style=display:flex><span>        group,
</span></span><span style=display:flex><span>        last_modified: <span style=color:#a6e22e>last_modified_gmt</span>.to_string(),
</span></span><span style=display:flex><span>        url: <span style=color:#a6e22e>Url</span>::parse(<span style=color:#f92672>&amp;</span>url).map_err(<span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> VaultParseError::BadParse {
</span></span><span style=display:flex><span>            field: <span style=color:#e6db74>&#34;account.url&#34;</span>,
</span></span><span style=display:flex><span>            inner: Box::new(e),
</span></span><span style=display:flex><span>        })<span style=color:#f92672>?</span>,
</span></span><span style=display:flex><span>        attachments: Vec::new(),
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices note"><p>You may have noticed that each helper function is passed a string with the
field name. That comes about because I&rsquo;m trying to give really clear error
messages when things go wrong (that way they&rsquo;re easier to debug), so instead of
saying <em>&ldquo;unable to parse the vault&rdquo;</em>, we&rsquo;ll be able to say something more useful
like <em>&ldquo;Unable to decrypt account.password&rdquo;</em>).</p><p>This is the full declaration for <code>VaultParseError</code>. You&rsquo;ll notice we&rsquo;re using
<a href=https://crates.io/crates/thiserror class=external-link target=_blank rel=noopener><code>thiserror</code></a> to automatically derive <code>std::fmt::Display</code> and make
sure things like <code>Error::source()</code> will return the underlying issue if one is
present.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/parser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// Errors that can happen when parsing a [`Vault`] from raw bytes.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[derive(Debug, thiserror::Error)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>VaultParseError</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;The </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> chunk should contain a UTF-8 string&#34;</span><span style=color:#75715e>, name)]</span>
</span></span><span style=display:flex><span>    ChunkShouldBeString {
</span></span><span style=display:flex><span>        name: String,
</span></span><span style=display:flex><span>        <span style=color:#75715e>#[source]</span>
</span></span><span style=display:flex><span>        inner: <span style=color:#a6e22e>Utf8Error</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Parsing didn&#39;t find, {}&#34;</span><span style=color:#75715e>, name)]</span>
</span></span><span style=display:flex><span>    MissingField { name: <span style=color:#66d9ef>&amp;</span>&#39;static <span style=color:#66d9ef>str</span> },
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Reached the end of input while looking for {}&#34;</span><span style=color:#75715e>, expected_field)]</span>
</span></span><span style=display:flex><span>    UnexpectedEOF { expected_field: <span style=color:#66d9ef>&amp;</span>&#39;static <span style=color:#66d9ef>str</span> },
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Unable to decrypt {}&#34;</span><span style=color:#75715e>, field)]</span>
</span></span><span style=display:flex><span>    UnableToDecrypt {
</span></span><span style=display:flex><span>        field: <span style=color:#66d9ef>&amp;</span>&#39;static <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>#[source]</span>
</span></span><span style=display:flex><span>        inner: <span style=color:#a6e22e>DecryptionError</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Parsing the {} field failed&#34;</span><span style=color:#75715e>, field)]</span>
</span></span><span style=display:flex><span>    BadParse {
</span></span><span style=display:flex><span>        field: <span style=color:#66d9ef>&amp;</span>&#39;static <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>#[source]</span>
</span></span><span style=display:flex><span>        inner: Box<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>dyn</span> Error <span style=color:#f92672>+</span> Send <span style=color:#f92672>+</span> Sync <span style=color:#f92672>+</span> &#39;static<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><p>I&rsquo;m not going to go show too much more parsing code (because it&rsquo;s all kinda the
same and you can <a href=https://github.com/Michael-F-Bryan/lastpass/blob/60499b7531689c4f3f5dc7180bc705528cd64bf4/src/parser.rs class=external-link target=_blank rel=noopener>read it on github</a>), but I&rsquo;d like to show how
simple it is to read an encrypted field is. Most of the code is actually
dedicated to providing detailed parse errors to the caller.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/parser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>read_encrypted</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span>(
</span></span><span style=display:flex><span>    buffer: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> [<span style=color:#66d9ef>u8</span>],
</span></span><span style=display:flex><span>    field: <span style=color:#66d9ef>&amp;</span>&#39;static <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span>(String, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>&#39;a</span> [<span style=color:#66d9ef>u8</span>]), VaultParseError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// read the next &#34;item&#34; (&amp;[u8]) from the front of our buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> (ciphertext, buffer) <span style=color:#f92672>=</span> read_item(buffer, field)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// then decrypt it using our decryption key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> decrypted <span style=color:#f92672>=</span> decryption_key
</span></span><span style=display:flex><span>        .decrypt(ciphertext)
</span></span><span style=display:flex><span>        .map_err(<span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> VaultParseError::UnableToDecrypt { field, inner: <span style=color:#a6e22e>e</span> })<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// and interpret the decrypted text as a UTF-8 string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> decrypted <span style=color:#f92672>=</span> String::from_utf8(decrypted)
</span></span><span style=display:flex><span>        .map_err(<span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> VaultParseError::BadParse { field, inner: Box::new(e) })<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok((decrypted, buffer))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We&rsquo;re actually able to read the <code>Vault</code> into memory and start looking at its
contents now!</p><p>Let&rsquo;s update the example executable so it&rsquo;ll log in and print out the first
<code>Account</code> in my test vault.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>info cargo run --username $EMAIL --password<span style=color:#f92672>=</span>$PASSWORD
</span></span><span style=display:flex><span>Sending a request to https://lastpass.com/getaccts.php
</span></span><span style=display:flex><span>Account {
</span></span><span style=display:flex><span>    id: Id(
</span></span><span style=display:flex><span>        &#34;533903346832032070&#34;,
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    name: &#34;Another Password&#34;,
</span></span><span style=display:flex><span>    group: &#34;&#34;,
</span></span><span style=display:flex><span>    url: &#34;https://google.com/&#34;,
</span></span><span style=display:flex><span>    note: &#34;This is a super secure note.&#34;,
</span></span><span style=display:flex><span>    note_type: &#34;Generic&#34;,
</span></span><span style=display:flex><span>    favourite: false,
</span></span><span style=display:flex><span>    username: &#34;user&#34;,
</span></span><span style=display:flex><span>    password: &#34;My Super Secret Password!!1!&#34;,
</span></span><span style=display:flex><span>    password_protected: false,
</span></span><span style=display:flex><span>    encrypted_attachment_key: &#34;!MOEcIddt5GaMMH8eoMWyRA==|BWdjMSoIvClMRyWrDdIlz38tZiU3O1nmcbg95PRXCT4zKLTTG4s0OD9v/co2l2PwNaKL4oaVPSIB8oUFhk3kAl77qBbrkAH03lWY/wIModA=&#34;,
</span></span><span style=display:flex><span>    attachment_present: true,
</span></span><span style=display:flex><span>    last_touch: &#34;0&#34;,
</span></span><span style=display:flex><span>    last_modified: &#34;1586717786&#34;,
</span></span><span style=display:flex><span>    attachments: [
</span></span><span style=display:flex><span>        Attachment {
</span></span><span style=display:flex><span>            id: Id(
</span></span><span style=display:flex><span>                &#34;533923346832032065-27281&#34;,
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>            parent: Id(
</span></span><span style=display:flex><span>                &#34;533923346832032065&#34;,
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>            mime_type: &#34;other:txt&#34;,
</span></span><span style=display:flex><span>            storage_key: &#34;100000020283&#34;,
</span></span><span style=display:flex><span>            size: 70,
</span></span><span style=display:flex><span>            encrypted_filename: &#34;!zdLMAcQ2okxs3MFWNjoCaw==|B7NqfcNPX0IbYFXNtykqEw==&#34;,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=downloading-attachments>Downloading Attachments
<a class=heading-link href=#downloading-attachments><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>An interesting part about accounts is that each gets an
<code>encrypted_attachment_key</code> field. This is a key that is base64-encoded and
encrypted using your master key, and is what you use for all
attachment-related decryption.</p><p>Let&rsquo;s give the <code>Account</code> a helper method for extracting the account key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/account.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Account {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Get the key used to work with this [`Account`]&#39;s attachments.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>attachment_key</span>(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>self,
</span></span><span style=display:flex><span>        decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>,
</span></span><span style=display:flex><span>    ) -&gt; Result<span style=color:#f92672>&lt;</span>DecryptionKey, DecryptionError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> hex <span style=color:#f92672>=</span> decryption_key.decrypt_base64(<span style=color:#f92672>&amp;</span>self.encrypted_attachment_key)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> key <span style=color:#f92672>=</span> DecryptionKey::from_hex(<span style=color:#f92672>&amp;</span>hex)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(key)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we&rsquo;ve got the attachment key, we can decrypt an <code>Attachment</code>&rsquo;s filename from
the metadata stored in the vault.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/attachment.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#66d9ef>crate</span>::{DecryptionError, DecryptionKey, Id};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// Metadata about an attached file.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[derive(Debug, Clone, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[non_exhaustive]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Attachment</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> id: <span style=color:#a6e22e>Id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The ID of the parent [`crate::Account`].
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> parent: <span style=color:#a6e22e>Id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The file&#39;s mimetype.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> mime_type: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// An opaque string which is used by the backend to find the correct
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// version of an attached file.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> storage_key: String,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The size of the attachment, in bytes.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> size: <span style=color:#66d9ef>u64</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The attachment&#39;s filename, encrypted using the account&#39;s `attachment_key`.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> encrypted_filename: String,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Attachment {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>filename</span>(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>self,
</span></span><span style=display:flex><span>        attachment_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>,
</span></span><span style=display:flex><span>    ) -&gt; Result<span style=color:#f92672>&lt;</span>String, DecryptionError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        attachment_key
</span></span><span style=display:flex><span>            .decrypt_base64(<span style=color:#f92672>&amp;</span>self.encrypted_filename)
</span></span><span style=display:flex><span>            .map(<span style=color:#f92672>|</span>filename<span style=color:#f92672>|</span> String::from_utf8(filename).unwrap())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So now we&rsquo;re able to read an attachment&rsquo;s filename.</p><p>It may not sound like much, but by this point we&rsquo;ve actually gone through
three levels of encryption&mldr;</p><ol><li>First we needed a login key to prove who we are</li><li>Then we needed to use the master decryption key so we can read things like
an account&rsquo;s name, associated username and password, and extract the
attachment key</li><li>Then we used the attachment key to read the attachment&rsquo;s filename</li></ol><p>Talk about defence in depth!</p><h3 id=downloading-attachments-1>Downloading Attachments
<a class=heading-link href=#downloading-attachments-1><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>It looks like the <code>Attachment</code>&rsquo;s <code>storage_key</code> field doesn&rsquo;t actually have
anything to do with encryption. When I first saw it, my thoughts were <em>&ldquo;oh
great, yet another layer of encryption&rdquo;</em>, but after printing the value out
you can see it&rsquo;s obviously not a key or encrypted data.</p><p>Don&rsquo;t just take my word on it though, here&rsquo;s the <code>Debug</code> representation of
an <code>Attachment</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>Attachment {
</span></span><span style=display:flex><span>    id: <span style=color:#a6e22e>Id</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;533903346832032070-27282&#34;</span>,
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    parent: <span style=color:#a6e22e>Id</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;533903346832032070&#34;</span>,
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    mime_type: <span style=color:#e6db74>&#34;other:txt&#34;</span>,
</span></span><span style=display:flex><span>    storage_key: <span style=color:#e6db74>&#34;100000027282&#34;</span>,
</span></span><span style=display:flex><span>    size: <span style=color:#ae81ff>70</span>,
</span></span><span style=display:flex><span>    encrypted_filename: <span style=color:#e6db74>&#34;!zdLMAcQ9okxR3MFWNjoCaw==|B7NqfcNPX0IayFXNtxkqEw==&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The value <code>100000027282</code> seems far too regular to be anything related to
crypto, so I&rsquo;m guessing the use of the word <em>&ldquo;key&rdquo;</em> is intended as <em>&ldquo;unique
identifier&rdquo;</em>.</p><p>I&rsquo;m guessing it&rsquo;s an ID that LastPass use to refer to a particular resource
stored on S3 or in a database somewhere. I doubt only 27282 attachments have
been uploaded to LastPass, so that means they&rsquo;re probably randomising storage
keys instead of using an auto-incrementing number.</p><p>To figure out how attachments are downloaded, let&rsquo;s have another look at the
<code>lastpass-cli</code> source code.</p><p>At the very bottom of <code>endpoints.h</code> there&rsquo;s a declaration for the
<code>lastpass_load_attachment()</code> function&mldr; That seems promising üôÇ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/endpoints.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get the attachment for a given attachment id.  The crypttext is returned
</span></span></span><span style=display:flex><span><span style=color:#75715e> * and should be decrypted with account-&gt;attachkey.  The pointer returned
</span></span></span><span style=display:flex><span><span style=color:#75715e> * in *result should be freed by the caller.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>lastpass_load_attachment</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> session <span style=color:#f92672>*</span>session,
</span></span><span style=display:flex><span>			     <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>shareid,
</span></span><span style=display:flex><span>			     <span style=color:#66d9ef>struct</span> attach <span style=color:#f92672>*</span>attach,
</span></span><span style=display:flex><span>			     <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>result)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>reply <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>p;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>result <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> http_param_set params <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		.argv <span style=color:#f92672>=</span> NULL,
</span></span><span style=display:flex><span>		.n_alloced <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http_post_add_params</span>(<span style=color:#f92672>&amp;</span>params,
</span></span><span style=display:flex><span>			     <span style=color:#e6db74>&#34;token&#34;</span>, session<span style=color:#f92672>-&gt;</span>token,
</span></span><span style=display:flex><span>			     <span style=color:#e6db74>&#34;getattach&#34;</span>, attach<span style=color:#f92672>-&gt;</span>storagekey,
</span></span><span style=display:flex><span>			     NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (shareid) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>http_post_add_params</span>(<span style=color:#f92672>&amp;</span>params,
</span></span><span style=display:flex><span>				     <span style=color:#e6db74>&#34;sharedfolderid&#34;</span>, shareid,
</span></span><span style=display:flex><span>				     NULL);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	reply <span style=color:#f92672>=</span> <span style=color:#a6e22e>http_post_lastpass_param_set</span>(<span style=color:#e6db74>&#34;getattach.php&#34;</span>,
</span></span><span style=display:flex><span>					     session, NULL,
</span></span><span style=display:flex><span>					     <span style=color:#f92672>&amp;</span>params);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>free</span>(params.argv);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>reply)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>ENOENT;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* returned string is json-encoded base64 string; unescape it */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (reply[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#34;&#39;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>memmove</span>(reply, reply<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>strlen</span>(reply));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (reply[<span style=color:#a6e22e>strlen</span>(reply)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#34;&#39;</span>)
</span></span><span style=display:flex><span>		reply[<span style=color:#a6e22e>strlen</span>(reply)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	p <span style=color:#f92672>=</span> reply;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#f92672>*</span>p) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\\&#39;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>memmove</span>(p, p <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>strlen</span>(p));
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			p<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>result <span style=color:#f92672>=</span> reply;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices tip"><p>For reference, the <code>attach</code> struct is almost identical to our <code>Attachment</code>,
except it also has references to the next and previous attachments because
it&rsquo;s stored in a doubly-linked list (we use a <code>Vec&lt;Attachment></code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// vendor/lastpass-cli/blob.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> attach {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>id;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>parent;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>mimetype;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>storagekey;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>size;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>filename;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> list_head list;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></div><p>This <code>lastpass_load_attachment()</code> function seems fairly straightforward.</p><ol><li>Send a request to <code>getattach.php</code> with a <code>token</code> and <code>getattach</code>, our
<code>storage_key</code> (I don&rsquo;t care about shared folders for now, so we can ignore
the <code>sharedfolderid</code> parameter)</li><li>Parse the string that&rsquo;s returned as a JSON string (i.e. wrapped in quotes and
with escape characters)</li><li>Base64-decode it to get the blob of bytes that makes up the encrypted
attachment</li><li>Decrypt the attachment using the attachment key. This isn&rsquo;t strictly part of
<code>lastpass_load_attachment()</code>, but I&rsquo;d prefer to do it all in the same
function so callers aren&rsquo;t second-guessing whether the <code>Vec&lt;u8></code> they&rsquo;ve
got is still encrypted</li></ol><p>By now you&rsquo;ve already seen me write several endpoint definitions and we&rsquo;ve
used the <code>DecryptionKey</code> once or twice, so nothing should be overly new here.</p><p>First we define a <code>Data</code> type to hold our form data.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/load_attachment.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> serde_derive::Serialize;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Data</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    token: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;getattach&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    storage_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m also creating a dedicated error type, because no other endpoints deal with
these particular base64-decoding and decryption errors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/load_attachment.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, thiserror::Error)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>LoadAttachmentError</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The HTTP client encountered an error.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Unable to send the request&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    HttpClient(<span style=color:#75715e>#[from]</span> reqwest::Error),
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Unable to decrypt the payload&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    Decrypt(<span style=color:#75715e>#[from]</span> <span style=color:#66d9ef>crate</span>::DecryptionError),
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[error(</span><span style=color:#e6db74>&#34;Unable to decode the decrypted attachment&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    Decode(<span style=color:#75715e>#[from]</span> base64::DecodeError),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And finally, the endpoint function itself.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// src/endpoints/load_attachment.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>load_attachment</span>(
</span></span><span style=display:flex><span>    client: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Client</span>,
</span></span><span style=display:flex><span>    hostname: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    token: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    storage_key: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>,
</span></span><span style=display:flex><span>    decryption_key: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>DecryptionKey</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span>, LoadAttachmentError<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> Data { token, storage_key };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> url <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>/getattach.php&#34;</span>, hostname);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> response <span style=color:#f92672>=</span> client
</span></span><span style=display:flex><span>        .post(<span style=color:#f92672>&amp;</span>url)
</span></span><span style=display:flex><span>        .form(<span style=color:#f92672>&amp;</span>data)
</span></span><span style=display:flex><span>        .send()
</span></span><span style=display:flex><span>        .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>        .error_for_status()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> ciphertext: String <span style=color:#f92672>=</span> response.text().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> decryption_key.decrypt_base64(<span style=color:#f92672>&amp;</span>ciphertext)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// not only was the ciphertext in base64, the attachment body was too
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    base64::decode(data).map_err(LoadAttachmentError::Decode)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The thing I really like about this is once you have the underlying
abstractions (key management, an ergonomic HTTP client, async-await, the
<code>base64</code> crate, serialization to/from arbitrary formats, etc.) everything
sort of <em>falls into place</em>.</p><p>I mean, loading an attachment only took about 30 lines of easily readable
code and about half of that is taken up by the definitions for <code>Data</code> and
<code>LoadAttachmentError</code>.</p><p>And check it out&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>*** My Secure Note - hello-world.txt (70 bytes) ***
</span></span><span style=display:flex><span>Sending a request to https://lastpass.com/getattach.php
</span></span><span style=display:flex><span>Hello, World
</span></span></code></pre></div><p>It was able to download our <code>hello-world.txt</code> attachment! üéâ</p><h2 id=conclusions>Conclusions
<a class=heading-link href=#conclusions><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Sorry if it took a while, but we got there in the end. It turns out reading
through the source code for a 15,000-line C program and explaining how my
2,000-line Rust implementation works takes a while&mldr;</p><p>I&rsquo;m no professional cartographer, but it seems like the LastPass system has
been pretty well designed. They&rsquo;ve deliberately separated the <code>LoginKey</code> from
the key you use to decrypt your vault. Plus the defence-in-depth (e.g.
attachment keys) should help protect users from attacking a vault that&rsquo;s been
cached locally.</p><p>You&rsquo;ve probably noticed already but I&rsquo;m also pleasantly surprised at how easy
this was to implement. Rust has a really nice ecosystem, and thanks to the
work of projects like <a href=https://serde.rs/ class=external-link target=_blank rel=noopener><code>serde</code></a>, <a href=https://crates.io/crates/reqwest class=external-link target=_blank rel=noopener><code>reqwest</code></a>, and
<a href=https://github.com/RustCrypto class=external-link target=_blank rel=noopener>RustCrypto</a>, I have all the necessary pieces at my fingertips.
You&rsquo;d hardly notice that async-await is only 4 months old.</p><p>The hardest bit was actually deciphering the <code>blob</code> parsing code, and that&rsquo;s
because it was written in C and the lack of existing unit tests meant I spent
a fair amount of time running <code>lpass</code> under the debugger to see what certain
values are meant to be. It&rsquo;s not a deal breaker, but you&rsquo;d think a C program
for accessing your passwords and bank account details would have some sort of
unit testing or input fuzzing&mldr;</p><div class="notices note"><p>I&rsquo;d be keen to hear from you if you are a developer from LastPass! What are
your thoughts on my efforts? Has the analysis been accurate, and can you spot
any bugs or issues?</p><p>I feel like having an official library that lets developers work with the
LastPass API can enable a lot of benefits for customers, and I&rsquo;d like to help
out on that front üòÅ</p></div></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>¬©
2025
Michael-F-Bryan
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com/tree/dbb621a9a787b276f42c0f30165783a6aa3065a6 target=_blank rel=noopener>dbb621a</a>]</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=/js/mermaid.min.min.9c343a21d2c1c6ad2ffc2661e9409225290bf15165a7661b9149c9a03934034c.js integrity="sha256-nDQ6IdLBxq0v/CZh6UCSJSkL8VFlp2YbkUnJoDk0A0w="></script><script src=/js/index.min.c04ed42ce6cde47e0926ae55f072b1ff2e67af9e681a00d0ffe507800d3fd657.js integrity="sha256-wE7ULObN5H4JJq5V8HKx/y5nr55oGgDQ/+UHgA0/1lc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-M80ZBKQHKV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-M80ZBKQHKV")}</script></body></html>