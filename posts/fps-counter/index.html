<!doctype html><html lang=en><head><title>FPS Counter · Michael-F-Bryan
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Michael-F-Bryan"><meta name=description content="As mentioned in the previous article the next task is to
implement our first proper System, the FpsCounter.

A relatively easy, yet important, component is some sort of FPS counter.
Ideally there’ll be a bit of text in the corner showing the number of
poll()s per second and the average duration. That way we can get a better
feel for our simulator’s performance characteristics.
An FpsCounter has two responsibilities,"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="FPS Counter"><meta name=twitter:description content="As mentioned in the previous article the next task is to implement our first proper System, the FpsCounter.
A relatively easy, yet important, component is some sort of FPS counter. Ideally there’ll be a bit of text in the corner showing the number of poll()s per second and the average duration. That way we can get a better feel for our simulator’s performance characteristics.
An FpsCounter has two responsibilities,"><meta property="og:url" content="https://adventures.michaelfbryan.com/posts/fps-counter/"><meta property="og:site_name" content="Michael-F-Bryan"><meta property="og:title" content="FPS Counter"><meta property="og:description" content="As mentioned in the previous article the next task is to implement our first proper System, the FpsCounter.
A relatively easy, yet important, component is some sort of FPS counter. Ideally there’ll be a bit of text in the corner showing the number of poll()s per second and the average duration. That way we can get a better feel for our simulator’s performance characteristics.
An FpsCounter has two responsibilities,"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-03T08:50:00+08:00"><meta property="article:modified_time" content="2025-04-01T09:19:10+08:00"><meta property="article:tag" content="Adventures-in-Motion-Control"><meta property="article:tag" content="Rust"><meta property="article:tag" content="WebAssembly"><link rel=canonical href=https://adventures.michaelfbryan.com/posts/fps-counter/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm+MTzNJdv80k+n0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/master.min.34be5ef36a820320661b4a8578382aba472d1a01092908eb30f0db81ec4031d4.css integrity="sha256-NL5e82qCAyBmG0qFeDgqukctGgEJKQjrMPDbgexAMdQ=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://adventures.michaelfbryan.com/>Michael-F-Bryan
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://adventures.michaelfbryan.com/posts/fps-counter/>FPS Counter</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2019-09-03T08:50:00+08:00>September 3, 2019
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/adventures-in-motion-control/>Adventures-in-Motion-Control</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/rust/>Rust</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/webassembly/>WebAssembly</a></span></div></div></header><div class=post-content><p>As mentioned in <a href=https://adventures.michaelfbryan.com/posts/top-level-infrastructure/#the-next-step>the previous article</a> the next task is to
implement our first proper <code>System</code>, the <code>FpsCounter</code>.</p><blockquote><p>A relatively easy, yet important, component is some sort of FPS counter.
Ideally there’ll be a bit of text in the corner showing the number of
<code>poll()</code>s per second and the average duration. That way we can get a better
feel for our simulator’s performance characteristics.</p></blockquote><p>An <code>FpsCounter</code> has two responsibilities,</p><ul><li>Keep track of the last <code>n</code> poll times</li><li>Calculate some statistics on the poll times and display it in the browser</li></ul><h2 id=creating-the-system>Creating The System
<a class=heading-link href=#creating-the-system><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Instead of making the <code>FpsCounter</code> part of our top-level <code>sim</code> application,
it should be given its own crate. This means the <code>FpsCounter</code> won&rsquo;t need to care
about JavaScript, and lets us maintain distinct layers of abstraction (see
<a href=https://adventures.michaelfbryan.com/posts/top-level-infrastructure/#layers><em>Top-Level Infrastructure - Layers</em></a> for more).</p><p>First up, lets create the crate.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>cargo new --lib fps-counter
</span></span><span style=display:flex><span>cd fps-counter
</span></span><span style=display:flex><span>cargo add ../hal
</span></span></code></pre></div><p>We&rsquo;ll also make simplest system that compiles.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// fps-counter/src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![no_std]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> aimc_hal::{Clock, System};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>FpsCounter</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span>In, Out<span style=color:#f92672>&gt;</span> System<span style=color:#f92672>&lt;</span>In, Out<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> FpsCounter {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>poll</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, inputs: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>In</span>, outputs: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Out) {
</span></span><span style=display:flex><span>        unimplemented!()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, we want to make sure the <code>FpsCounter</code> tracks the time of the last tick.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> aimc_hal::clock::DummyClock;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>track_time_of_last_tick</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> fps <span style=color:#f92672>=</span> FpsCounter::default();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> should_be <span style=color:#f92672>=</span> Duration::new(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>23</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> time <span style=color:#f92672>=</span> DummyClock(should_be);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fps.poll(<span style=color:#f92672>&amp;</span>time, <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> ());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assert_eq!(fps.last_tick, should_be);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices note"><p>The <code>aimc_hal::clock::DummyClock</code> type is a helper <code>Clock</code> that always
returns the same <code>Duration</code>.</p></div><p>To make this test pass, we&rsquo;ll need to update our <code>FpsCounter</code> to track the last
tick. It&rsquo;ll also need a source of time, we constrain the <code>In</code> type using
<code>aimc_hal::clock::HasClock</code>. This means <code>input</code> will have a getter that yields
a <code>Clock</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, Default, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>FpsCounter</span> {
</span></span><span style=display:flex><span>    last_tick: <span style=color:#a6e22e>Duration</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span>In: <span style=color:#a6e22e>HasClock</span>, Out<span style=color:#f92672>&gt;</span> System<span style=color:#f92672>&lt;</span>In, Out<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> FpsCounter {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>poll</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, inputs: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>In</span>, outputs: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Out) {
</span></span><span style=display:flex><span>        self.last_tick <span style=color:#f92672>=</span> inputs.clock().elapsed();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The next step is to calculate the corresponding FPS and send the result
somewhere.</p><p>We&rsquo;ll wrap the calculated result in its own <code>Fps</code> struct, then make sure the
<code>outputs</code> can handle it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Copy, Clone, Default, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Fps</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> frequency: <span style=color:#66d9ef>f32</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>trait</span> FpsSink {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>emit_fps</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, fps: <span style=color:#a6e22e>Fps</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And the corresponding test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_use]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> std;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::prelude::v1::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Default)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Sink</span>(Vec<span style=color:#f92672>&lt;</span>Fps<span style=color:#f92672>&gt;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> FpsSink <span style=color:#66d9ef>for</span> Sink {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>emit_fps</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, fps: <span style=color:#a6e22e>Fps</span>) { self.<span style=color:#ae81ff>0.</span>push(fps); }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>record_fps</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> start <span style=color:#f92672>=</span> Duration::new(<span style=color:#ae81ff>42</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> period <span style=color:#f92672>=</span> Duration::from_millis(<span style=color:#ae81ff>20</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> now <span style=color:#f92672>=</span> start <span style=color:#f92672>+</span> period;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> fps <span style=color:#f92672>=</span> FpsCounter::with_start_time(start);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> sink <span style=color:#f92672>=</span> Sink::default();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> time <span style=color:#f92672>=</span> DummyClock(now);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fps.poll(<span style=color:#f92672>&amp;</span>time, <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> sink);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assert_eq!(sink.<span style=color:#ae81ff>0.</span>len(), <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    assert_eq!(
</span></span><span style=display:flex><span>        sink.<span style=color:#ae81ff>0</span>[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>        Fps {
</span></span><span style=display:flex><span>            frequency: <span style=color:#ae81ff>1000.0</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>20.0</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    assert_eq!(fps.last_tick, now);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Updating <code>FpsCounter::poll()</code> to make the test pass is left as an exercise for
the reader.</p><p>A further extension would be to add an <code>average_poll_duration</code> field to <code>Fps</code>.
That way <code>sim::App</code> can record when <code>App::poll()</code> starts and poll the
<code>FpsCounter</code> as the last thing before <code>App::poll()</code> exits. Embedded systems
won&rsquo;t generally have access to an allocator, so you may want to checkout
<a href=https://docs.rs/arraydeque/0.4.5/arraydeque/ class=external-link target=_blank rel=noopener><code>arraydeque</code></a> as a <code>#[no_std]</code> alternative.</p><h2 id=wiring-up-to-the-application>Wiring up to the Application
<a class=heading-link href=#wiring-up-to-the-application><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now we&rsquo;ve got an FPS counter it&rsquo;s time to show the FPS in our window.</p><p>First, let&rsquo;s give the FPS counter somewhere to be displayed. This means adding
a dummy element to <code>frontend/index.html</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> &lt;body&gt;
</span></span><span style=display:flex><span>   &lt;noscript&gt;This page contains webassembly and javascript content, please enable javascript in your browser.&lt;/noscript&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-  &lt;div&gt;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    &lt;span id=&#34;fps-counter&#34;&gt;&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-  &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672></span>   &lt;script src=&#34;./bootstrap.js&#34;&gt;&lt;/script&gt;
</span></span><span style=display:flex><span> &lt;/body&gt;
</span></span></code></pre></div><p>The <code>Browser</code> will also need updating so it takes a reference to the
<code>#fps-counter</code> span in its constructor.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/browser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> fps_counter::{Fps, FpsSink};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> wasm_bindgen::JsValue;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> web_sys::Element;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Browser</span> {
</span></span><span style=display:flex><span>    fps_div: <span style=color:#a6e22e>Element</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Browser {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>from_element</span>(fps_selector: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Browser, <span style=color:#f92672>&amp;</span>&#39;static <span style=color:#66d9ef>str</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> document <span style=color:#f92672>=</span> web_sys::window()
</span></span><span style=display:flex><span>            .ok_or(<span style=color:#e6db74>&#34;Can&#39;t get a reference to the window&#34;</span>)<span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>            .document()
</span></span><span style=display:flex><span>            .ok_or(<span style=color:#e6db74>&#34;Can&#39;t get a reference to the document&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> element <span style=color:#f92672>=</span> document
</span></span><span style=display:flex><span>            .query_selector(fps_selector)
</span></span><span style=display:flex><span>            .map_err(<span style=color:#f92672>|</span>_<span style=color:#f92672>|</span> <span style=color:#e6db74>&#34;Invalid selector&#34;</span>)<span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>            .ok_or(<span style=color:#e6db74>&#34;Can&#39;t find the FPS element&#34;</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(Browser { fps_div: <span style=color:#a6e22e>element</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>While we&rsquo;re at it, we should probably implement <code>fps_counter::FpsSink</code> for
<code>Browser</code>&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/browser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> FpsSink <span style=color:#66d9ef>for</span> Browser {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>emit_fps</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, fps: <span style=color:#a6e22e>Fps</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> buffer <span style=color:#f92672>=</span> ArrayString::<span style=color:#f92672>&lt;</span>[<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>128</span>]<span style=color:#f92672>&gt;</span>::default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> result <span style=color:#f92672>=</span> write!(buffer, <span style=color:#e6db74>&#34;FPS: {:.1}Hz&#34;</span>, fps.frequency);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> result.is_ok() {
</span></span><span style=display:flex><span>            self.fps_div.set_inner_html(<span style=color:#f92672>&amp;</span>buffer);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            self.fps_div.set_inner_html(<span style=color:#e6db74>&#34;FPS: ? Hz&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We&rsquo;ll need to propagate possible errors now that constructing a <code>Browser</code> may
fail.</p><p>The idiomatic way to do this is by returning a <code>Result&lt;T, JsValue></code> from a
<code>#[wasm_bindgen]</code> function. That way, the shims generated by <code>wasm-bindgen</code>
will be notified of failure and raise the <code>JsValue</code> as an exception.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[wasm_bindgen]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>setup_world</span>(fps_div: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; Result<span style=color:#f92672>&lt;</span>App, JsValue<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> browser <span style=color:#f92672>=</span> Browser::from_element(fps_div)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> inputs <span style=color:#f92672>=</span> Inputs::default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(App::new(inputs, browser))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And of course <code>setup_world()</code>&rsquo;s signature changed, so we&rsquo;ll need to pass in the
<code>#fps-counter</code> selector from our JavaScript.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// frontend/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Initializing the world&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>world</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>wasm</span>.<span style=color:#a6e22e>setup_world</span>(<span style=color:#e6db74>&#34;#fps-counter&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>animate</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With any luck, this should be everything required to wire the <code>FpsCounter</code> up
to the UI.</p><p>Reloading the window shows some rapidly changing text in the top-left corner.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>FPS: 55.56Hz
</span></span></code></pre></div><p>The label itself isn&rsquo;t overly pleasing to look at, but it gets the job done.
If the text itself seems to flicker, remember that we&rsquo;re updating it every
time the <code>App</code> gets polled (about 60 times per second).</p><p>As an exercise for the reader, try implementing a <a href=https://en.wikipedia.org/wiki/Moving_average class=external-link target=_blank rel=noopener>moving average</a> to
smooth that flicker out.</p><h2 id=the-next-step>The Next Step
<a class=heading-link href=#the-next-step><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now we&rsquo;ve got a better feel for the work required to add new systems to the
application and wire them up to the UI, the next step is probably going to be
the <em>Communications</em> system.</p><p>The real world tends to be messy with lots of places where errors can enter the
<em>Communications</em> system, but lots of people have solved the problem in the past
so we should be okay.</p></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2025
Michael-F-Bryan
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com/tree/dbb621a9a787b276f42c0f30165783a6aa3065a6 target=_blank rel=noopener>dbb621a</a>]</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=/js/mermaid.min.min.9c343a21d2c1c6ad2ffc2661e9409225290bf15165a7661b9149c9a03934034c.js integrity="sha256-nDQ6IdLBxq0v/CZh6UCSJSkL8VFlp2YbkUnJoDk0A0w="></script><script src=/js/index.min.c04ed42ce6cde47e0926ae55f072b1ff2e67af9e681a00d0ffe507800d3fd657.js integrity="sha256-wE7ULObN5H4JJq5V8HKx/y5nr55oGgDQ/+UHgA0/1lc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-M80ZBKQHKV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-M80ZBKQHKV")}</script></body></html>