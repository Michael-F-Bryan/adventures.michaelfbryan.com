<!doctype html><html lang=en><head><title>Top-Level Infrastructure · Michael-F-Bryan
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Michael-F-Bryan"><meta name=description content="As mentioned in the intro article, the first task will be to set
up the application&rsquo;s structure and define how the various components will
communicate.

  Multitasking
  
    
    Link to heading
  

Most embedded systems will implement multi-tasking by rapidly polling each
system within an infinite loop.
loop {
    poll_comms();
    poll_motion_planning();
    poll_io();
    poll_machine_events();
}
A motion controller will normally spend most of its time polling, but there are
places where polling isn&rsquo;t appropriate. For example, accurate movement of a
stepper motor relies on sending pulses at very precise times. Another scenario
is in the handling of communication, where waiting for the next poll to read a
byte may result in missing part of a message."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Top-Level Infrastructure"><meta name=twitter:description content="As mentioned in the intro article, the first task will be to set up the application’s structure and define how the various components will communicate.
Multitasking Link to heading Most embedded systems will implement multi-tasking by rapidly polling each system within an infinite loop.
loop { poll_comms(); poll_motion_planning(); poll_io(); poll_machine_events(); } A motion controller will normally spend most of its time polling, but there are places where polling isn’t appropriate. For example, accurate movement of a stepper motor relies on sending pulses at very precise times. Another scenario is in the handling of communication, where waiting for the next poll to read a byte may result in missing part of a message."><meta property="og:url" content="https://adventures.michaelfbryan.com/posts/top-level-infrastructure/"><meta property="og:site_name" content="Michael-F-Bryan"><meta property="og:title" content="Top-Level Infrastructure"><meta property="og:description" content="As mentioned in the intro article, the first task will be to set up the application’s structure and define how the various components will communicate.
Multitasking Link to heading Most embedded systems will implement multi-tasking by rapidly polling each system within an infinite loop.
loop { poll_comms(); poll_motion_planning(); poll_io(); poll_machine_events(); } A motion controller will normally spend most of its time polling, but there are places where polling isn’t appropriate. For example, accurate movement of a stepper motor relies on sending pulses at very precise times. Another scenario is in the handling of communication, where waiting for the next poll to read a byte may result in missing part of a message."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-02T21:22:30+08:00"><meta property="article:modified_time" content="2025-04-01T09:19:10+08:00"><meta property="article:tag" content="Adventures-in-Motion-Control"><meta property="article:tag" content="Rust"><meta property="article:tag" content="WebAssembly"><link rel=canonical href=https://adventures.michaelfbryan.com/posts/top-level-infrastructure/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm+MTzNJdv80k+n0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/master.min.34be5ef36a820320661b4a8578382aba472d1a01092908eb30f0db81ec4031d4.css integrity="sha256-NL5e82qCAyBmG0qFeDgqukctGgEJKQjrMPDbgexAMdQ=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://adventures.michaelfbryan.com/>Michael-F-Bryan
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://adventures.michaelfbryan.com/posts/top-level-infrastructure/>Top-Level Infrastructure</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2019-09-02T21:22:30+08:00>September 2, 2019
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
9-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/adventures-in-motion-control/>Adventures-in-Motion-Control</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/rust/>Rust</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/webassembly/>WebAssembly</a></span></div></div></header><div class=post-content><p>As mentioned in <a href=https://adventures.michaelfbryan.com/posts/announcing-adventures-in-motion-control/#the-next-step>the intro article</a>, the first task will be to set
up the application&rsquo;s structure and define how the various components will
communicate.</p><h2 id=multitasking>Multitasking
<a class=heading-link href=#multitasking><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Most embedded systems will implement multi-tasking by rapidly polling each
system within an infinite loop.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>    poll_comms();
</span></span><span style=display:flex><span>    poll_motion_planning();
</span></span><span style=display:flex><span>    poll_io();
</span></span><span style=display:flex><span>    poll_machine_events();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A motion controller will normally spend most of its time polling, but there are
places where polling isn&rsquo;t appropriate. For example, accurate movement of a
stepper motor relies on sending pulses at very precise times. Another scenario
is in the handling of communication, where waiting for the next poll to read a
byte may result in missing part of a message.</p><p>To deal with this embedded systems use <a href=https://en.wikipedia.org/wiki/Interrupt class=external-link target=_blank rel=noopener>interrupts</a>, callbacks which
will preempt the normal flow of execution to handle an event. These callbacks,
referred to as <em>Interrupt Service Routines</em>, will then do the bare minimum
required to handle the event so execution can be resumed as quickly as
possible.</p><p>For example, this may happen by saving the event to memory (e.g.
<em>&ldquo;received <code>0x0A</code> over serial&rdquo;</em>) so it can be handled by the appropriate
system when it is polled next.</p><h2 id=inter-system-communication>Inter-System Communication
<a class=heading-link href=#inter-system-communication><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now we know that systems will do work by being polled frequently, lets think
about how they&rsquo;ll interact with the rest of the application.</p><p>In general a system works by reading state, evaluating some logic using that
state, then propagate the results of that logic by sending messages to the
rest of the system (or even to the real world via IOs).</p><p>Systems will be polled infinitely and are the top-most level of logic so they
must handle every possible error, even if that is just done by entering a fault
state. It doesn&rsquo;t make sense for <code>poll()</code> to return an error (who would
handle the error?)&mldr; Or anything, for that matter.</p><p>From that, we&rsquo;ve got a rough image of what a system may look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>trait</span> System<span style=color:#f92672>&lt;</span>In, Out<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>poll</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, inputs: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>In</span>, outputs: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Out);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=keeping-track-of-time>Keeping Track of Time
<a class=heading-link href=#keeping-track-of-time><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>An important responsibility for a motion controller is being able to change
the value of something over time (hence the <em>motion</em> in <em>motion controller</em>).
Timing is used all over the place and each motion controller will have its
own way of tracking the time (remember that there may not necessarily be an
OS meaning we can&rsquo;t depend on <code>std::time::SystemTime</code>), so lets pull this
out into its own trait.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> core::time::Duration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> Clock: Sync {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The amount of time that has elapsed since some arbitrary point in time
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// (e.g. when the program started).
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>elapsed</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>Duration</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices note"><p>A <code>Clock</code> will be shared by almost every system and a reference may be passed
across threads. Hence the <code>&amp;self</code> in <code>elapsed()</code> and the <code>Sync</code> bound.</p></div><div class="notices tip"><p>Extracting the concept of time into its own trait is especially handy during
testing. It can also be used to make time run faster than the usual 1 second
per second (e.g. fast-forward).</p></div><h2 id=layers>Layers
<a class=heading-link href=#layers><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>To reduce coupling and make things more manageable, we&rsquo;ll take advantage of
<a href=https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html class=external-link target=_blank rel=noopener>Cargo Workspaces</a> to break the project into layers.</p><p>At the very bottom is our <em>Hardware Abstraction Layer</em> (HAL). This defines
the various platform-agnostic interfaces used by the application.</p><p>Next we have the various drivers (e.g. stepper motor control) and systems (e.g.
communication and motion planning). These are built on top of the HAL and
are where most of the application is implemented.</p><p>At the very top is the application itself, an in-browser simulator in our case.
Its role is to glue the various components together, performing the necessary
setup before polling the various systems ad infinitum.</p><p>Our app&rsquo;s dependency graph may look something like this:</p><div class=mermaid align=center>graph BT;
H[Hardware Abstraction Layer];
B[In-Browser Simulator];
C[Comms System];
P[Motion Planning];
S[Stepper Axis Driver];
F[Flash Memory];
H-->C;
H-->P;
H-->F;
H-->S;
F-->B;
S-->B;
P-->B;
C-->B;</div><h2 id=hello-world>Hello, World!
<a class=heading-link href=#hello-world><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now we&rsquo;ve got a better idea of how the application might be structured it&rsquo;s
time to stub out enough of the frontend to see things run.</p><p>I won&rsquo;t explain each step in setting up a Rust WASM project (the
<a href=https://rustwasm.github.io/book/game-of-life/setup.html class=external-link target=_blank rel=noopener>Rust and WebAssembly</a> book already does a great job at that!), but
here&rsquo;s the gist of it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cargo generate --git https://github.com/rustwasm/wasm-pack-template --name sim
</span></span><span style=display:flex><span> Creating project called `sim`...
</span></span><span style=display:flex><span> Done! New project created /home/michael/Documents/adventures-in-motion-control/sim
</span></span><span style=display:flex><span>$ cd sim <span style=color:#f92672>&amp;&amp;</span> wasm-pack build
</span></span><span style=display:flex><span>$ ls pkg
</span></span><span style=display:flex><span> aimc_sim.d.ts aimc_sim.js aimc_sim_bg.d.ts aimc_sim_bg.wasm package.json
</span></span><span style=display:flex><span> README.md sim.d.ts sim.js sim_bg.d.ts sim_bg.wasm
</span></span><span style=display:flex><span>$ cd ..
</span></span><span style=display:flex><span>$ npm init wasm-app frontend
</span></span><span style=display:flex><span> npx: installed 1 in 2.523s
</span></span><span style=display:flex><span> 🦀 Rust + 🕸 Wasm = ❤
</span></span><span style=display:flex><span>$ cd frontend <span style=color:#f92672>&amp;&amp;</span> yarn install
</span></span><span style=display:flex><span>$ yarn add ../sim/pkg
</span></span><span style=display:flex><span>$ yarn run start
</span></span><span style=display:flex><span> yarn run v1.15.2
</span></span><span style=display:flex><span> webpack-dev-server
</span></span><span style=display:flex><span> ℹ ｢wds｣: Project is running at http://localhost:8080/
</span></span><span style=display:flex><span> ℹ ｢wds｣: webpack output is served from /
</span></span><span style=display:flex><span> ℹ ｢wds｣: Content not from webpack is served from /home/michael/Documents/adventures-in-motion-control/frontend
</span></span><span style=display:flex><span> ℹ ｢wdm｣: Hash: 93fc66658e148c72a97a
</span></span><span style=display:flex><span> Version: webpack 4.39.3
</span></span><span style=display:flex><span> Time: 467ms
</span></span><span style=display:flex><span> Built at: 09/02/2019 7:24:22 PM
</span></span><span style=display:flex><span>                            Asset       Size  Chunks             Chunk Names
</span></span><span style=display:flex><span>                   0.bootstrap.js    3.4 KiB       0  [emitted]
</span></span><span style=display:flex><span> 8e8fa9289c240ac706a1.module.wasm  872 bytes       0  [emitted]
</span></span><span style=display:flex><span>                     bootstrap.js    367 KiB    main  [emitted]  main
</span></span><span style=display:flex><span>                       index.html  297 bytes          [emitted]
</span></span><span style=display:flex><span> Entrypoint main = bootstrap.js
</span></span></code></pre></div><p>The project now looks something like this (<a href=https://github.com/Michael-F-Bryan/adventures-in-motion-control/commit/69e68832299e459068b4263676bb9fc20987f03a class=external-link target=_blank rel=noopener>commit <code>69e68832</code></a>):</p><ul><li>adventures-in-motion-control/<ul><li>Cargo.toml</li><li>hal/<ul><li>src/<ul><li>lib.rs</li><li>clock.rs</li><li>system.rs</li></ul></li></ul></li><li>sim/<ul><li>src/<ul><li>lib.rs</li><li>utils.rs</li></ul></li></ul></li><li>frontend/<ul><li>package.json</li><li>bootstrap.js</li><li>index.js</li><li>index.html</li></ul></li></ul></li></ul><p>I normally use <a href=https://crates.io/crates/cargo-watch class=external-link target=_blank rel=noopener><code>cargo-watch</code></a> to recompile and run my project&rsquo;s
test suite whenever a change is made, but doing the same with <code>wasm-pack</code> and
<code>yarn</code> takes a little extra effort. Instead, we&rsquo;ll need to work with
<a href=https://crates.io/crates/watchexec class=external-link target=_blank rel=noopener><code>watchexec</code></a> directly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ watchexec <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    # Clear the screen every time
</span></span><span style=display:flex><span>    --clear \
</span></span><span style=display:flex><span>    # The webpack dev server will still be running, make sure it is restarted
</span></span><span style=display:flex><span>    --restart \
</span></span><span style=display:flex><span>    # These files are changed when running  `wasm-pack` and `yarn add`
</span></span><span style=display:flex><span>    --ignore &#39;sim/pkg/*&#39; \
</span></span><span style=display:flex><span>    --ignore &#39;frontend/package.json&#39; \
</span></span><span style=display:flex><span>    --ignore &#39;frontend/yarn.lock&#39; \
</span></span><span style=display:flex><span>    --ignore &#39;frontend/node_modules/*&#39; \
</span></span><span style=display:flex><span>    # The actual command to execute whenever something changes
</span></span><span style=display:flex><span>    &#39;wasm-pack build sim &amp;&amp; cd frontend &amp;&amp; yarn add ../sim/pkg &amp;&amp; yarn start&#39;
</span></span></code></pre></div><div class="notices note"><p>Webpack won&rsquo;t automatically detect the <code>sim/pkg/</code> directory&rsquo;s contents have
changed (I&rsquo;m guessing the folder&rsquo;s contents are copied to <code>node_modules/</code>?).
That means we need to manually run <code>yarn add ../sim/pkg</code> every time the WASM
code changes.</p></div><p>Lets stub out an <code>App</code> type. This will contain the world&rsquo;s state, with a
reference being passed to the JavaScript frontend so it can be periodically
polled.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/app.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> aimc_hal::{clock::Clock, System};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> wasm_bindgen::prelude::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[wasm_bindgen]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>App</span> {
</span></span><span style=display:flex><span>    inputs: <span style=color:#a6e22e>Inputs</span>,
</span></span><span style=display:flex><span>    browser: <span style=color:#a6e22e>Browser</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> App {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>poll</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        self.browser.log(<span style=color:#e6db74>&#34;Polling...&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices note"><p>The <code>Input</code> and <code>Browser</code> types are what hooks our <code>App</code> up to the rest of the
world. They&rsquo;ll implement the various HAL traits so our systems are able run.</p></div><p>For now, the <code>Input</code> just contains a <code>Clock</code> based on JavaScript&rsquo;s
<code>performance.now()</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/inputs.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#66d9ef>crate</span>::PerformanceClock;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> aimc_hal::clock::{Clock, HasClock};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::time::Duration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, Default)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Inputs</span> {
</span></span><span style=display:flex><span>    clock: <span style=color:#a6e22e>PerformanceClock</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> HasClock <span style=color:#66d9ef>for</span> Inputs {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>clock</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>dyn</span> Clock { <span style=color:#f92672>&amp;</span>self.clock }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>PerformanceClock</code> itself isn&rsquo;t overly interesting. It just uses <code>web-sys</code>
to call the native JavaScript function and converts the the result to a
<code>Duration</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/clock.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> aimc_hal::clock::Clock;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::time::Duration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// A [`Clock`] which uses the browser&#39;s native `performance.now()` function
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/// to keep track of time.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[derive(Debug, Clone, Default)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>PerformanceClock</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Clock <span style=color:#66d9ef>for</span> PerformanceClock {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>elapsed</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> perf <span style=color:#f92672>=</span> web_sys::window()
</span></span><span style=display:flex><span>            .expect(<span style=color:#e6db74>&#34;The window always exists&#34;</span>)
</span></span><span style=display:flex><span>            .performance()
</span></span><span style=display:flex><span>            .expect(<span style=color:#e6db74>&#34;The window should always have a performance timer&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> now_ms <span style=color:#f92672>=</span> perf.now();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> secs <span style=color:#f92672>=</span> (now_ms <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000.0</span>).floor();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> secs <span style=color:#f92672>=</span> secs <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> nanos <span style=color:#f92672>=</span> ((now_ms <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000.0</span>).fract() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1e9</span>).floor();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> nanos <span style=color:#f92672>=</span> nanos <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u32</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Duration::new(secs <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>, nanos <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u32</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>Browser</code> is also pretty empty at the moment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/browser.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> wasm_bindgen::JsValue;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Default)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Browser</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Browser {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>log</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, msg: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> msg <span style=color:#f92672>=</span> JsValue::from(msg);
</span></span><span style=display:flex><span>        web_sys::console::log_1(<span style=color:#f92672>&amp;</span>msg);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We also need to expose functions which will let JavaScript create the world
and poll it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// sim/src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![no_std]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> app;
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> browser;
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> clock;
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> inputs;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>use</span> app::App;
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>use</span> browser::Browser;
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>use</span> clock::PerformanceClock;
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>use</span> inputs::Inputs;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> wasm_bindgen::prelude::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[wasm_bindgen(start)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>on_module_loaded</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wire up pretty panic messages when the WASM module is loaded into memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#[cfg(feature = </span><span style=color:#e6db74>&#34;console_error_panic_hook&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    console_error_panic_hook::set_once();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// Creates a new world, initializing the various systems and wiring up any
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/// necessary interrupts.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[wasm_bindgen]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>setup_world</span>(fps_div: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>App</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> browser <span style=color:#f92672>=</span> Browser::default();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> inputs <span style=color:#f92672>=</span> Inputs::default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(App::new(inputs, browser))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// Poll the application, running each system in turn and letting them make
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/// progress.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[wasm_bindgen]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>poll</span>(app: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> App) { app.poll(); }
</span></span></code></pre></div><p>Now the <code>sim</code> crate is exposing <code>setup_world()</code> and <code>poll()</code>, we can wire it
up to the browser.</p><p>Something to note about JavaScript running in a browser is that an infinite loop
will prevent anything else from executing, locking the entire window up. This
isn&rsquo;t great.</p><p>The trick to implementing an infinite &ldquo;loop&rdquo; in JavaScript is to use
<a href=https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame class=external-link target=_blank rel=noopener><code>window.requestAnimationFrame()</code></a> to schedule some <code>animate()</code> function
to be called, then make sure <code>animate()</code> calls <code>requestAnimationFrame(animate)</code>
so it&rsquo;ll be called again.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// frontend/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>wasm</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;aimc-sim&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>world</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Initializing the world&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>world</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>wasm</span>.<span style=color:#a6e22e>setup_world</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>animate</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>animate</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wasm</span>.<span style=color:#a6e22e>poll</span>(<span style=color:#a6e22e>world</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>animate</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>init</span>();
</span></span></code></pre></div><p>Going to the dev server (http://localhost:8080/) should show an empty page,
however if you open up the developer console you should see something like this:</p><p><img src=it-works.png alt="It Works!!1!"></p><p>It may not look impressive, but to just get that <em>&ldquo;Polling&mldr;&rdquo;</em> message we
needed to:</p><ol><li>Compile the <code>sim</code> crate to WebAssembly</li><li>Import that WebAssembly from a JavaScript application and make sure JS can
call our WASM functions</li><li>Bundle the JavaScript and WebAssembly together and send it to a browser</li><li>Initialize the world when the window is first loaded</li><li>Call <code>wasm.poll()</code> from an JavaScript function that is called whenever the
browser paints</li><li>Poll the underlying <code>App</code>, using in a set of dummy <code>Inputs</code> and a <code>Browser</code>
object</li><li>Invoke that browser&rsquo;s <code>log()</code> method</li><li>Call back into JavaScript&rsquo;s <code>console.log()</code> function</li></ol><h2 id=the-next-step>The Next Step
<a class=heading-link href=#the-next-step><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now the main application is wired up and we can run code in the browser the next
step is to add some systems to our application.</p><p>A relatively easy, yet important, component is some sort of FPS counter. Ideally
there&rsquo;ll be a bit of text in the corner showing the number of <code>poll()</code>s per
second and the average duration. That way we can get a better feel for our
simulator&rsquo;s performance characteristics.</p></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2025
Michael-F-Bryan
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com/tree/dbb621a9a787b276f42c0f30165783a6aa3065a6 target=_blank rel=noopener>dbb621a</a>]</section></footer></main><script src=https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js integrity="sha256-QdTG1YTLLTwD3b95jLqFxpQX9uYuJMNAtVZgwKX4oYU=" crossorigin=anonymous></script><script>mermaid.initialize({startOnLoad:!0})</script><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=/js/mermaid.min.min.9c343a21d2c1c6ad2ffc2661e9409225290bf15165a7661b9149c9a03934034c.js integrity="sha256-nDQ6IdLBxq0v/CZh6UCSJSkL8VFlp2YbkUnJoDk0A0w="></script><script src=/js/index.min.c04ed42ce6cde47e0926ae55f072b1ff2e67af9e681a00d0ffe507800d3fd657.js integrity="sha256-wE7ULObN5H4JJq5V8HKx/y5nr55oGgDQ/+UHgA0/1lc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-M80ZBKQHKV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-M80ZBKQHKV")}</script></body></html>