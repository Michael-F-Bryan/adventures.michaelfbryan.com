<!doctype html><html lang=en><head><title>Wiring Up Communication · Michael-F-Bryan
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Michael-F-Bryan"><meta name=description content="As we mentioned in the last AiMC post, the next task is to wire up
communications between the simulator&rsquo;s backend and frontend.
As a general rule, our frontend will have two communication regimes:

When something happens (e.g. a button is pressed or a job starts sending),
the frontend will send a batch of messages to the backend and interpret the
response
The frontend will continually poll the backend&rsquo;s state in the background
(e.g. at 10Hz)

As it is, the Browser in our WASM code already provides a method for
sending data to the frontend (Browser::send_data()) and
receiving data from the frontend (App::on_data_received()) so
we shouldn&rsquo;t need to write any Rust code."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Wiring Up Communication"><meta name=twitter:description content="As we mentioned in the last AiMC post, the next task is to wire up communications between the simulator’s backend and frontend.
As a general rule, our frontend will have two communication regimes:
When something happens (e.g. a button is pressed or a job starts sending), the frontend will send a batch of messages to the backend and interpret the response The frontend will continually poll the backend’s state in the background (e.g. at 10Hz) As it is, the Browser in our WASM code already provides a method for sending data to the frontend (Browser::send_data()) and receiving data from the frontend (App::on_data_received()) so we shouldn’t need to write any Rust code."><meta property="og:url" content="https://adventures.michaelfbryan.com/posts/wiring-up-communication/"><meta property="og:site_name" content="Michael-F-Bryan"><meta property="og:title" content="Wiring Up Communication"><meta property="og:description" content="As we mentioned in the last AiMC post, the next task is to wire up communications between the simulator’s backend and frontend.
As a general rule, our frontend will have two communication regimes:
When something happens (e.g. a button is pressed or a job starts sending), the frontend will send a batch of messages to the backend and interpret the response The frontend will continually poll the backend’s state in the background (e.g. at 10Hz) As it is, the Browser in our WASM code already provides a method for sending data to the frontend (Browser::send_data()) and receiving data from the frontend (App::on_data_received()) so we shouldn’t need to write any Rust code."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-10T22:58:00+08:00"><meta property="article:modified_time" content="2025-04-01T09:19:10+08:00"><meta property="article:tag" content="Adventures-in-Motion-Control"><meta property="article:tag" content="Vue"><meta property="article:tag" content="Javascript"><link rel=canonical href=https://adventures.michaelfbryan.com/posts/wiring-up-communication/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm+MTzNJdv80k+n0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/master.min.34be5ef36a820320661b4a8578382aba472d1a01092908eb30f0db81ec4031d4.css integrity="sha256-NL5e82qCAyBmG0qFeDgqukctGgEJKQjrMPDbgexAMdQ=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://adventures.michaelfbryan.com/>Michael-F-Bryan
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://adventures.michaelfbryan.com/posts/wiring-up-communication/>Wiring Up Communication</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2019-10-10T22:58:00+08:00>October 10, 2019
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
8-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/adventures-in-motion-control/>Adventures-in-Motion-Control</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/vue/>Vue</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/javascript/>Javascript</a></span></div></div></header><div class=post-content><p>As we mentioned <a href=https://adventures.michaelfbryan.com/posts/a-better-frontend/#the-next-step>in the last AiMC post</a>, the next task is to wire up
communications between the simulator&rsquo;s backend and frontend.</p><p>As a general rule, our frontend will have two communication regimes:</p><ol><li>When something happens (e.g. a button is pressed or a job starts sending),
the frontend will send a batch of messages to the backend and interpret the
response</li><li>The frontend will continually poll the backend&rsquo;s state in the background
(e.g. at 10Hz)</li></ol><p>As it is, the <code>Browser</code> in our WASM code already provides a method for
sending data to the frontend (<a href=https://michael-f-bryan.github.io/adventures-in-motion-control/aimc_sim/struct.Browser.html#method.send_data class=external-link target=_blank rel=noopener><code>Browser::send_data()</code></a>) and
receiving data from the frontend (<a href=https://michael-f-bryan.github.io/adventures-in-motion-control/aimc_sim/struct.App.html#method.on_data_received class=external-link target=_blank rel=noopener><code>App::on_data_received()</code></a>) so
we shouldn&rsquo;t need to write any Rust code.</p><p>As far as the frontend is concerned, when a user clicks a button we should:</p><ol><li>Construct a message to send to the backend</li><li>fire off an <code>async</code> function to queue that message</li><li>on the next <code>animate()</code> tick, the message will be encoded to bytes and we&rsquo;ll
start sending those bytes to the backend (max of about 256 bytes/tick) using
<code>App::on_data_received()</code></li><li>After processing the message, the backend will invoke <code>Browser::send_data()</code>
to notify us of a response</li><li>When enough bytes have been received our frontend&rsquo;s <code>Decoder</code> will be able to
decode them back into a <code>Packet</code></li><li>The frontend will need to inspect the packet to figure out which message is
being responded to</li><li>The original <code>async</code> call will either be <code>resolve()</code>-ed with the
response, or <code>reject()</code>-ed with an error (e.g. <code>Nack</code>)</li></ol><h2 id=creating-a-communication-bus>Creating a Communication Bus
<a class=heading-link href=#creating-a-communication-bus><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The central entity which will coordinate communication is the <code>CommsBus</code>. It
uses the <code>App::on_data_received()</code> and <code>Browser::send_data()</code>, as well as an
internal list of pending requests, to coordinate messaging between the frontend
and backend, and either <code>resolve()</code> or <code>reject()</code> pending messages.</p><p>The <code>CommsBus</code> starts off reasonably simple.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/CommsBus.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommsBus</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>pending</span>: <span style=color:#66d9ef>Pending</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Pending</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO: implement this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span></code></pre></div><p>The main way it&rsquo;s used by the frontend is via a <code>send()</code> method. This needs
to use some <code>sendToBackend</code> callback (actually a reference to the
<code>App::on_data_received()</code> method) to send the encoded message and return a
promise. The promise&rsquo;s <code>resolve</code> and <code>reject</code> functions will also need to be
stashed away for later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/CommsBus.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Decoder</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;anpp&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommsBus</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>sendToBackend</span><span style=color:#f92672>?:</span> (<span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>Uint8Array</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>pending</span>: <span style=color:#66d9ef>Pending</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>Request</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Response</span>&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendToBackend</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendToBackend</span>(<span style=color:#a6e22e>toPacket</span>(<span style=color:#a6e22e>req</span>).<span style=color:#a6e22e>encoded</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pending</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>started</span>: <span style=color:#66d9ef>new</span> Date(), <span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span> });
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Not wired up to the backend&#34;</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Pending</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>started</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>response</span>: <span style=color:#66d9ef>Response</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>err</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You may notice that <code>send()</code> receives a <code>Request</code> object and returns (a promise
which will eventually resolve to) a <code>Response</code>. These are actually trivial
data classes which are used to represent the various message types we expect.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/messaging.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Request</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>GoHome</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Ack</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Nack</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Ack</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>toString</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;ACK&#34;</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Nack</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>toString</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;NACK&#34;</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GoHome</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>speed</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Create a new `GoHome` message.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param speed The speed to go home at in mm/s. Must be a positive integer
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * below 256.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>speed</span>: <span style=color:#66d9ef>number</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>speed</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>round</span>(<span style=color:#a6e22e>speed</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>speed</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>speed</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>256</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`The speed must be between 0 and 256 (exclusive), found </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>speed</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>speed</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>speed</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>toString</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`Go Home @ </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>speed</span><span style=color:#e6db74>}</span><span style=color:#e6db74>mm/s`</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We also need a <code>toPacket()</code> function to convert between a message type and a
<code>Packet</code> from the <a href=https://www.npmjs.com/package/anpp class=external-link target=_blank rel=noopener><code>anpp</code> package on NPM</a>.</p><p>Given the only <code>Request</code> the frontend can send (at this stage) is a <code>GoHome</code>,
implementing <code>toPacket()</code> is almost trivial&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/CommsBus.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Decoder</span>, <span style=color:#a6e22e>Packet</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;anpp&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>toPacket</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>Request</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Packet</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span> <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>GoHome</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Packet</span>(<span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>([<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>speed</span>]));
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Unable to convert this to a Packet&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, whenever the backend wants to send us data the <code>Browser::send_data()</code> hook
(provided by the top-level Vue component) will need to tell the <code>CommsBus</code>. From
there, the bytes can be added to a <code>Decoder</code> (again from the <code>anpp</code> package) and
we can check for any parsed messages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/CommsBus.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommsBus</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>decoder</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Decoder</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>onDataReceived</span>(<span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>Uint8Array</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>decoder</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pkt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>decoder</span>.<span style=color:#a6e22e>decode</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pkt</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handlePacket</span>(<span style=color:#a6e22e>pkt</span>);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Handling a message requires us to pop the next <code>Pending</code> request from front of
the <code>pending</code> queue and parse the <code>Packet</code> into its corresponding <code>Response</code>.
Depending on whether this parse succeeds we can either <code>resolve()</code> or <code>reject()</code>
the pending request.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/CommsBus.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommsBus</span> {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>handlePacket</span>(<span style=color:#a6e22e>pkt</span>: <span style=color:#66d9ef>Packet</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pending</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pending</span>.<span style=color:#a6e22e>shift</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>pending</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// received a response with no request...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>pending</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>pkt</span>));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>pending</span>.<span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Thanks to the <code>Packet</code>&rsquo;s <code>id</code> field, and the fact that the only responses we can
handle are empty <code>Ack</code> and <code>Nack</code> messages, parsing a <code>Packet</code> is almost as
trivial as encoding one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/CommsBus.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>pkt</span>: <span style=color:#66d9ef>Packet</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Response</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>pkt</span>.<span style=color:#a6e22e>id</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Ack</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>1</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Nack</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Unknown packet type (id: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pkt</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="notices info"><p>As part of using <code>anpp</code> in our frontend I actually needed to port the original
<code>anpp</code> library from C to JavaScript and publish it to NPM. Please raise tickets
on the issue tracker if bugs are found or you have any suggestions!</p></div><h2 id=using-the-comms-bus-from-the-control-panel>Using the Comms Bus from the Control Panel
<a class=heading-link href=#using-the-comms-bus-from-the-control-panel><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We&rsquo;ll pass a <code>Send</code> function to our <code>Controls</code> component to allow it to send
messages to the backend.</p><p>First we&rsquo;ll need to give the <code>Controls</code> component a <code>send</code> property which is
<code>fn(Request) -> Promise&lt;Response></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/components/Controls.vue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Controls</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Vue</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>@Prop</span>({ <span style=color:#a6e22e>required</span>: <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>send</span><span style=color:#f92672>!:</span> (<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>Request</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Response</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next we&rsquo;ll wire up the <em>Home</em> section&rsquo;s submit handler and make it send a
<code>GoHome</code> message.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vue data-lang=vue><span style=display:flex><span><span style=color:#75715e>// frontend/src/components/Controls.vue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>b-form</span> <span style=color:#a6e22e>inline</span> <span style=color:#f92672>@submit</span><span style=color:#e6db74>=&#34;onHomePressed&#34;</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#a6e22e>b</span><span style=color:#f92672>-form</span>&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ts&#34;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Controls</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Vue</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>motion</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MotionParameters</span>();
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>Prop</span>({ <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>send</span><span style=color:#f92672>!:</span> (<span style=color:#a6e22e>req</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Request</span>) =&gt; Promise&lt;<span style=color:#f92672>Response</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>onHomePressed</span>(<span style=color:#a6e22e>e</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>preventDefault</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>home</span>().<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>).<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>home</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GoHome</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>motion</span>.<span style=color:#a6e22e>homingSpeed</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>We also need to make sure the frontend&rsquo;s top-level <code>App</code> component provides this
<code>send()</code> prop.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vue data-lang=vue><span style=display:flex><span><span style=color:#75715e>// frontend/src/App.vue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;app&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wrapper&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>b-card</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;body&#34;</span> <span style=color:#a6e22e>no</span><span style=color:#f92672>-body</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>b-tabs</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>-class</span><span style=color:#960050;background-color:#1e0010>=&#34;</span><span style=color:#a6e22e>mt</span><span style=color:#f92672>-3</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#a6e22e>card</span>&gt;
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>          &lt;<span style=color:#f92672>Controls</span> <span style=color:#f92672>:send</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;send&#34;</span> /&gt;
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>b-tabs</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>b-card</span>&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ts&#34;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>Component</span>({ <span style=color:#a6e22e>components</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Sidebar</span>, <span style=color:#a6e22e>GCodeViewer</span>, <span style=color:#a6e22e>Terminal</span>, <span style=color:#a6e22e>Controls</span> } })
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>App</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Vue</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>comms</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CommsBus</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>req</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Request</span>)<span style=color:#f92672>:</span> Promise&lt;<span style=color:#f92672>Response</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comms</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>Back in <a href=https://adventures.michaelfbryan.com/posts/a-better-frontend/#wiring-aimc-sim-up-to-the-frontend-again>A Better Frontend</a> we stubbed out the <code>send_data()</code> method (the
callback invoked every time the backend wants to send the frontend some data)
with a <code>TODO</code> comment and a <code>console.log()</code>. Well now we need to implement it
for real.</p><p>Due to the way we&rsquo;ve structured the frontend, this is just a case of sending
the data to the <code>CommsBus</code> and letting it handle things.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vue data-lang=vue><span style=display:flex><span><span style=color:#75715e>// frontend/src/App.vue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ts&#34;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>Component</span>({ <span style=color:#a6e22e>components</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Sidebar</span>, <span style=color:#a6e22e>GCodeViewer</span>, <span style=color:#a6e22e>Terminal</span>, <span style=color:#a6e22e>Controls</span> } })
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>App</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Vue</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>comms</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CommsBus</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>req</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Request</span>)<span style=color:#f92672>:</span> Promise&lt;<span style=color:#f92672>Response</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comms</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>The frontend should now be able to communicate with the backend. Let&rsquo;s add a
few well-placed <code>console.log()</code> calls to <code>Controls.onHomePressed()</code> to make this
easier to see.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vue data-lang=vue><span style=display:flex><span><span style=color:#75715e>// frontend/src/components/Controls.vue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ts&#34;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Controls</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Vue</span> {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>onHomePressed</span>(<span style=color:#a6e22e>e</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>preventDefault</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Going Home!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>home</span>()
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>resp</span> =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>toString</span>(), <span style=color:#a6e22e>resp</span>))
</span></span><span style=display:flex><span>      .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>We can also hook into the send/receive process so the <em>Terminal</em> is able to
visually display messages. This requires adding a <code>Messages[]</code> property which
contains a message, timestamp it was sent/received, and its direction, and will
be passed through to the <code>Terminal</code> control as a prop.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// frontend/src/CommsBus.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommsBus</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>messages</span>: <span style=color:#66d9ef>Message</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>Request</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Response</span>&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendToBackend</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onRequestSent</span>(<span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>handlePacket</span>(<span style=color:#a6e22e>pkt</span>: <span style=color:#66d9ef>Packet</span>) {
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>pkt</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onResponseReceived</span>(<span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>pending</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>onRequestSent</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>Request</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pushMessage</span>(<span style=color:#a6e22e>Direction</span>.<span style=color:#a6e22e>Sent</span>, <span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>onResponseReceived</span>(<span style=color:#a6e22e>resp</span>: <span style=color:#66d9ef>Response</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pushMessage</span>(<span style=color:#a6e22e>Direction</span>.<span style=color:#a6e22e>Received</span>, <span style=color:#a6e22e>resp</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>pushMessage</span>(<span style=color:#a6e22e>direction</span>: <span style=color:#66d9ef>Direction</span>, <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>messages</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date() });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vue data-lang=vue><span style=display:flex><span><span style=color:#75715e>// frontend/src/App.vue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>b-tab</span> <span style=color:#a6e22e>title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Terminal&#34;</span>&gt;
</span></span><span style=display:flex><span>          &lt;<span style=color:#f92672>Terminal</span> <span style=color:#f92672>:messages</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;messages&#34;</span> /&gt;
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>b-tab</span>&gt;
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ts&#34;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>Component</span>({ <span style=color:#a6e22e>components</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Sidebar</span>, <span style=color:#a6e22e>GCodeViewer</span>, <span style=color:#a6e22e>Terminal</span>, <span style=color:#a6e22e>Controls</span> } })
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>App</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Vue</span> {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>messages</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Message</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comms</span>.<span style=color:#a6e22e>messages</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>Pressing the <em>&ldquo;Home&rdquo;</em> button and pulling up the dev tools now shows the backend
responded with a <em>NACK</em> (the default response when the backend doesn&rsquo;t know what
to do with a message).</p><figure><img src=/posts/wiring-up-communication/console-log.png alt="Clicking Home"><figcaption><h4>Progress!</h4></figcaption></figure><h2 id=the-next-step>The Next Step
<a class=heading-link href=#the-next-step><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We&rsquo;re now at the point where the frontend can send messages to the backend, and
the backend can send back a response. This unblocks quite a few features, so
from here we can:</p><ul><li>Start periodically polling the backend to check its status (e.g. axis
positions, current <a href=https://adventures.michaelfbryan.com/posts/initial-motion-system/><em>control mode</em></a>)</li><li>Read in a g-code program and send it chunk-by-chunk to the backend so it can
go through the pipeline of <code>parse -> motion planning -> execute</code></li><li>Continue fleshing out the <code>Controls</code> with a software-defined handset (e.g.
axis jogging)</li><li>Implement more of the communications monitor so we can manually send arbitrary
messages</li><li>Add more automation sequences</li></ul><p>Let me know which one you&rsquo;d like to see tackled next.</p></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2025
Michael-F-Bryan
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/Michael-F-Bryan/adventures.michaelfbryan.com/tree/dbb621a9a787b276f42c0f30165783a6aa3065a6 target=_blank rel=noopener>dbb621a</a>]</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=/js/mermaid.min.min.9c343a21d2c1c6ad2ffc2661e9409225290bf15165a7661b9149c9a03934034c.js integrity="sha256-nDQ6IdLBxq0v/CZh6UCSJSkL8VFlp2YbkUnJoDk0A0w="></script><script src=/js/index.min.c04ed42ce6cde47e0926ae55f072b1ff2e67af9e681a00d0ffe507800d3fd657.js integrity="sha256-wE7ULObN5H4JJq5V8HKx/y5nr55oGgDQ/+UHgA0/1lc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-M80ZBKQHKV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-M80ZBKQHKV")}</script></body></html>